const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jszip.min-p_IMUA3t.js","assets/index-DjsbB7Em.js","assets/index-FBu17hMI.css"])))=>i.map(i=>d[i]);
import{K as ea,x as aa,j as t,N as Y,n as L,r as c,D as ta,_ as je,L as sa,z as P,v as ie,w as ne,F as ia,M as na,G as oa}from"./index-DjsbB7Em.js";import{u as ra}from"./useAdmin-C5ouPi0N.js";import{F as la,E as ca}from"./ExportModal-4VlMHNEB.js";const da="_tabSelector_usssr_1",ga="_imageContainer_usssr_12",ma="_imagePlaceholder_usssr_33",ua="_metadataTags_usssr_45",pa="_metadataTag_usssr_45",fa="_captionContainer_usssr_67",ha="_captionText_usssr_74",_a="_gridLayout_usssr_131",xa="_detailsSection_usssr_155",ya="_loadingContainer_usssr_161",va="_errorContainer_usssr_171",ja="_fullSizeModalOverlay_usssr_205",wa="_fullSizeModalContent_usssr_219",Ia="_ratingWarningContent_usssr_230",Na="_ratingWarningTitle_usssr_236",Ca="_ratingWarningText_usssr_243",ba="_ratingWarningButtons_usssr_250",Sa="_carouselContainer_usssr_365",Da="_carouselImageWrapper_usssr_370",ka="_carouselImage_usssr_370",Ma="_carouselNavigation_usssr_393",La="_carouselButton_usssr_405",Fa="_carouselIndicators_usssr_429",Ta="_carouselIndicator_usssr_429",Pa="_carouselIndicatorActive_usssr_458",Ea="_singleImageContainer_usssr_488",$a="_viewImageButtonContainer_usssr_494",m={tabSelector:da,imageContainer:ga,imagePlaceholder:ma,metadataTags:ua,metadataTag:pa,captionContainer:fa,captionText:ha,gridLayout:_a,detailsSection:xa,loadingContainer:ya,errorContainer:va,fullSizeModalOverlay:ja,fullSizeModalContent:wa,ratingWarningContent:Ia,ratingWarningTitle:Na,ratingWarningText:Ca,ratingWarningButtons:ba,carouselContainer:Sa,carouselImageWrapper:Da,carouselImage:ka,carouselNavigation:Ma,carouselButton:La,carouselIndicators:Fa,carouselIndicator:Ta,carouselIndicatorActive:Pa,singleImageContainer:Ea,viewImageButtonContainer:$a};function st(){const{mapId:g}=ea(),x=aa(),{isAuthenticated:oe}=ra();console.log("MapDetailsPage: Current URL:",window.location.href),console.log("MapDetailsPage: Hash:",window.location.hash),console.log("MapDetailsPage: mapId from useParams:",g),console.log("MapDetailsPage: mapId type:",typeof g),console.log("MapDetailsPage: mapId length:",g?.length),console.log("MapDetailsPage: mapId value:",JSON.stringify(g));const we=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;if(!g||g==="undefined"||g==="null"||g.trim()===""||!we.test(g))return t.jsx(Y,{children:t.jsxs("div",{className:"flex flex-col items-center gap-4 text-center py-12",children:[t.jsx("div",{className:"text-4xl",children:"âš ï¸"}),t.jsx("div",{className:"text-xl font-semibold",children:"Invalid Map ID"}),t.jsx("div",{children:"The map ID provided is not valid."}),t.jsxs("div",{className:"text-sm text-gray-500 mt-2",children:['Debug Info: mapId = "',g,'" (type: ',typeof g,")"]}),t.jsx(L,{name:"back-to-explore",variant:"secondary",onClick:()=>x("/explore"),children:"Return to Explore"})]})});const[re,Ie]=c.useState("mapDetails"),[e,ee]=c.useState(null),[z,R]=c.useState(!0),[le,O]=c.useState(null),[ce,Ne]=c.useState([]),[de,Ce]=c.useState([]),[ge,be]=c.useState([]),[me,Se]=c.useState([]),[De,ke]=c.useState([]),[Me,Le]=c.useState(!1),[Fe,Te]=c.useState(!1),[B,q]=c.useState(!1),[Pe,K]=c.useState(!1),[ue,Z]=c.useState(!1),[Ee,ae]=c.useState(!1),[$e,te]=c.useState(!1),[Ra,Aa]=c.useState("standard"),[E,za]=c.useState(80),[J,Oa]=c.useState(10),[Ua,Wa]=c.useState(10),[Ba,Ja]=c.useState(!0),[Va,Ha]=c.useState(!0),[U,Q]=c.useState(!1),[Re,pe]=c.useState(!1),[Ae,fe]=c.useState(null),[ze,V]=c.useState(!1),[_,H]=c.useState([]),[D,A]=c.useState(0),[G,he]=c.useState(!1),{search:p,setSearch:Ga,srcFilter:y,setSrcFilter:qa,catFilter:v,setCatFilter:Ka,regionFilter:j,setRegionFilter:Za,countryFilter:w,setCountryFilter:Qa,imageTypeFilter:I,setImageTypeFilter:Xa,uploadTypeFilter:N,setUploadTypeFilter:Ya,showReferenceExamples:b,setShowReferenceExamples:Oe,clearAllFilters:Ue}=ta(),We=[{key:"explore",label:"List"},{key:"mapDetails",label:"Carousel"}],_e=c.useCallback(async a=>{if(console.log("fetchMapData called with id:",a),console.log("fetchMapData id type:",typeof a),!a||a==="undefined"||a==="null"||a.trim()===""){console.log("fetchMapData: Invalid ID detected:",a),O("Invalid Map ID"),R(!1);return}if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(a)){console.log("fetchMapData: Invalid UUID format:",a),O("Invalid Map ID format"),R(!1);return}console.log("fetchMapData: Making API call for id:",a),q(!0),R(!0);try{const l=await fetch(`/api/images/${a}`);if(!l.ok)throw new Error("Map not found");const i=await l.json();if(ee(i),i.all_image_ids&&i.all_image_ids.length>1)await xe(i.all_image_ids);else if(i.image_count&&i.image_count>1){console.log("Multi-upload detected but no all_image_ids, trying grouped endpoint");try{const n=await fetch("/api/images/grouped");if(n.ok){const o=(await n.json()).find(u=>u.all_image_ids&&u.all_image_ids.includes(i.image_id));o&&o.all_image_ids?await xe(o.all_image_ids):(H([i]),A(0))}else H([i]),A(0)}catch(n){console.error("Failed to fetch from grouped endpoint:",n),H([i]),A(0)}}else H([i]),A(0);await se(a)}catch(l){O(l instanceof Error?l.message:"Unknown error occurred")}finally{R(!1),q(!1)}},[]),xe=c.useCallback(async a=>{console.log("fetchAllImages called with imageIds:",a),he(!0);try{const s=a.map(async i=>{const n=await fetch(`/api/images/${i}`);if(!n.ok)throw new Error(`Failed to fetch image ${i}`);return n.json()}),l=await Promise.all(s);H(l),A(0),console.log("fetchAllImages: Loaded",l.length,"images")}catch(s){console.error("fetchAllImages error:",s),O(s instanceof Error?s.message:"Failed to load all images")}finally{he(!1)}},[]),Be=c.useCallback(()=>{_.length>1&&A(a=>a>0?a-1:_.length-1)},[_.length]),Je=c.useCallback(()=>{_.length>1&&A(a=>a<_.length-1?a+1:0)},[_.length]),Ve=c.useCallback(a=>{a>=0&&a<_.length&&A(a)},[_.length]),ye=c.useCallback(async a=>{const s=a||(_.length>0?_[D]:e);if(s){V(!0),fe(s),pe(!0);try{const l=new Image;l.onload=()=>{V(!1)},l.onerror=()=>{V(!1)},l.src=s.image_url}catch(l){console.error("Error preloading full-size image:",l),V(!1)}}},[_,D,e]),He=c.useCallback(()=>{pe(!1),fe(null),V(!1)},[]);c.useEffect(()=>{if(console.log("MapDetailsPage: mapId from useParams:",g),console.log("MapDetailsPage: mapId type:",typeof g),console.log("MapDetailsPage: mapId value:",g),!g||g==="undefined"||g==="null"||g.trim()===""||g===void 0||g===null){console.log("MapDetailsPage: Invalid mapId, setting error"),O("Map ID is required"),R(!1);return}if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(g)){console.log("MapDetailsPage: Invalid UUID format:",g),O("Invalid Map ID format"),R(!1);return}console.log("MapDetailsPage: Fetching data for mapId:",g),_e(g)},[g,_e]),c.useEffect(()=>{if(!e||z||U)return;if(!g||g==="undefined"||g==="null"||g.trim()===""){console.log("Auto-navigation skipped: Invalid mapId");return}if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(g)){console.log("Auto-navigation skipped: Invalid mapId format");return}(()=>{const l=!p||e.title?.toLowerCase().includes(p.toLowerCase())||e.generated?.toLowerCase().includes(p.toLowerCase())||e.source?.toLowerCase().includes(p.toLowerCase())||e.event_type?.toLowerCase().includes(p.toLowerCase()),i=!y||e.source===y,n=!v||e.event_type===v,r=!j||e.countries.some($=>$.r_code===j),o=!w||e.countries.some($=>$.c_code===w),u=!I||e.image_type===I,h=!b||e.starred===!0,k=l&&i&&n&&r&&o&&u&&h;return console.log("Auto-navigation check:",{mapId:g,search:p,srcFilter:y,catFilter:v,regionFilter:j,countryFilter:w,imageTypeFilter:I,showReferenceExamples:b,matchesSearch:l,matchesSource:i,matchesCategory:n,matchesRegion:r,matchesCountry:o,matchesImageType:u,matchesReferenceExamples:h,matches:k}),k})()||(console.log("Current map does not match filters, looking for first matching item"),fetch("/api/images").then(l=>l.json()).then(l=>{console.log("Auto-navigation: Received images from API:",l.length),console.log("Auto-navigation: First few images:",l.slice(0,3).map(n=>({image_id:n.image_id,title:n.title})));const i=l.find(n=>{const r=!p||n.title?.toLowerCase().includes(p.toLowerCase())||n.generated?.toLowerCase().includes(p.toLowerCase())||n.source?.toLowerCase().includes(p.toLowerCase())||n.event_type?.toLowerCase().includes(p.toLowerCase()),o=!y||n.source===y,u=!v||n.event_type===v,h=!j||n.countries?.some(f=>f.r_code===j),k=!w||n.countries?.some(f=>f.c_code===w),$=!I||n.image_type===I,F=!b||n.starred===!0;return r&&o&&u&&h&&k&&$&&F});console.log("Auto-navigation: Found first matching image:",i?{image_id:i.image_id,title:i.title,source:i.source}:"No matching image found"),i&&i.image_id&&i.image_id!=="undefined"&&i.image_id!=="null"&&i.image_id.trim()!==""&&i.image_id!==g&&(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(i.image_id)?(console.log("Auto-navigating to:",i.image_id),x(`/map/${i.image_id}`)):console.error("Auto-navigation blocked: Invalid image_id format:",i.image_id))}).catch(console.error))},[e,p,y,v,j,w,I,b,g,x,z,U]);const se=c.useCallback(async a=>{if(!(!a||a==="undefined"||a==="null"||a.trim()===""))try{const s=new URLSearchParams;p&&s.append("search",p),y&&s.append("source",y),v&&s.append("event_type",v),j&&s.append("region",j),w&&s.append("country",w),I&&s.append("image_type",I),N&&s.append("upload_type",N),b&&s.append("starred_only","true");const l=await fetch(`/api/images/grouped?${s.toString()}`);if(l.ok){const i=await l.json();console.log("Server response for upload_type=multiple:",{url:`/api/images/grouped?${s.toString()}`,count:i.length,images:i.map(r=>({image_id:r.image_id,image_count:r.image_count,all_image_ids:r.all_image_ids,all_image_ids_length:r.all_image_ids?.length}))});const n=i.findIndex(r=>r.image_id===a);console.log("Navigation availability check (server-side):",{filteredImagesCount:i.length,currentIndex:n,currentId:a,uploadTypeFilter:N,hasPrevious:i.length>1&&n>0,hasNext:i.length>1&&n<i.length-1,filteredImages:i.map(r=>({image_id:r.image_id,image_count:r.image_count,all_image_ids:r.all_image_ids,image_type:r.image_type}))}),Le(i.length>1&&n>0),Te(i.length>1&&n<i.length-1)}}catch(s){console.error("Failed to check navigation availability:",s)}},[p,y,v,j,w,I,N,b]),ve=async a=>{if(!B){q(!0);try{const s=new URLSearchParams;p&&s.append("search",p),y&&s.append("source",y),v&&s.append("event_type",v),j&&s.append("region",j),w&&s.append("country",w),I&&s.append("image_type",I),N&&s.append("upload_type",N),b&&s.append("starred_only","true");const l=await fetch(`/api/images/grouped?${s.toString()}`);if(l.ok){const i=await l.json(),n=i.findIndex(u=>u.image_id===g);if(n===-1){console.error("Current image not found in filtered list");return}let r;a==="previous"?r=n>0?n-1:i.length-1:r=n<i.length-1?n+1:0;const o=i[r];o&&o.image_id&&o.image_id!=="undefined"&&o.image_id!=="null"&&o.image_id.trim()!==""&&(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(o.image_id)?(console.log("Carousel navigating to:",o.image_id),x(`/map/${o.image_id}`)):console.error("Carousel navigation blocked: Invalid image_id format:",o.image_id))}}catch(s){console.error("Failed to navigate to item:",s)}finally{q(!1)}}};c.useEffect(()=>{console.log("=== NAVIGATION USEEFFECT TRIGGERED ==="),console.log("Navigation useEffect triggered:",{map:!!e,mapId:g,loading:z,isDeleting:U,uploadTypeFilter:N,allFilters:{search:p,srcFilter:y,catFilter:v,regionFilter:j,countryFilter:w,imageTypeFilter:I,uploadTypeFilter:N,showReferenceExamples:b}}),e&&g&&!z&&!U?(console.log("Calling checkNavigationAvailability with:",g),se(g)):console.log("NOT calling checkNavigationAvailability because:",{map:!!e,mapId:!!g,loading:z,isDeleting:U})},[e,g,p,y,v,j,w,I,N,b,z,U,se]),c.useEffect(()=>{Promise.all([fetch("/api/sources").then(a=>a.json()),fetch("/api/types").then(a=>a.json()),fetch("/api/image-types").then(a=>a.json()),fetch("/api/regions").then(a=>a.json()),fetch("/api/countries").then(a=>a.json())]).then(([a,s,l,i,n])=>{Ne(a),Ce(s),be(l),Se(i),ke(n)}).catch(console.error)},[]);const Ge=async()=>{e&&K(!0)},qe=async()=>{if(e)try{(await fetch(`/api/images/${e.image_id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({starred:!e.starred})})).ok?ee(s=>s?{...s,starred:!s.starred}:null):console.error("Failed to toggle starred status")}catch(a){console.error("Error toggling starred status:",a)}},Ke=async()=>{if(e){Q(!0);try{if(console.log("Deleting image with ID:",e.image_id),(await fetch(`/api/images/${e.image_id}`,{method:"DELETE"})).ok){ee(s=>s?{...s,starred:!s.starred}:null),K(!1);try{const s=await fetch("/api/images/grouped");if(s.ok){const i=(await s.json()).filter(r=>{const o=!p||r.title?.toLowerCase().includes(p.toLowerCase())||r.generated?.toLowerCase().includes(p.toLowerCase())||r.source?.toLowerCase().includes(p.toLowerCase())||r.event_type?.toLowerCase().includes(p.toLowerCase()),u=!y||r.source===y,h=!v||r.event_type===v,k=!j||r.countries?.some(C=>C.r_code===j),$=!w||r.countries?.some(C=>C.c_code===w),F=!I||r.image_type===I,f=!N||N==="single"&&(!r.image_count||r.image_count<=1)||N==="multiple"&&r.image_count&&r.image_count>1,M=!b||r.starred===!0;return o&&u&&h&&k&&$&&F&&f&&M}),n=i.filter(r=>r.image_id!==e.image_id);if(n.length>0){const r=i.findIndex(u=>u.image_id===e.image_id);let o;if(r===i.length-1?o=r-1:o=r,console.log("Navigation target:",{currentIndex:r,targetIndex:o,targetId:n[o]?.image_id}),o>=0&&o<n.length){const u=n[o];u&&u.image_id&&u.image_id!=="undefined"&&u.image_id!=="null"&&u.image_id.trim()!==""?/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(u.image_id)?(console.log("Navigating to:",u.image_id),x(`/map/${u.image_id}`)):(console.error("Navigation blocked: Invalid image_id format:",u.image_id),x("/explore")):(console.error("Navigation blocked: Invalid image_id:",u?.image_id),x("/explore"))}else n[0]&&n[0].image_id&&n[0].image_id!=="undefined"&&n[0].image_id!=="null"&&n[0].image_id.trim()!==""?/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(n[0].image_id)?(console.log("Fallback navigation to first item:",n[0].image_id),x(`/map/${n[0].image_id}`)):(console.error("Fallback navigation blocked: Invalid image_id format:",n[0].image_id),x("/explore")):(console.log("No valid remaining items, going to explore page"),x("/explore"))}else console.log("No remaining items, going to explore page"),x("/explore")}else x("/explore")}catch(s){console.error("Failed to navigate to next item:",s),x("/explore")}finally{Q(!1)}}else console.error("Delete failed"),Q(!1)}catch(a){console.error("Delete failed:",a),Q(!1)}}},d=c.useMemo(()=>{if(!e)return null;if(!p&&!y&&!v&&!j&&!w&&!I&&!N&&!b)return e;const a=!p||e.title?.toLowerCase().includes(p.toLowerCase())||e.generated?.toLowerCase().includes(p.toLowerCase())||e.source?.toLowerCase().includes(p.toLowerCase())||e.event_type?.toLowerCase().includes(p.toLowerCase()),s=!y||e.source===y,l=!v||e.event_type===v,i=!j||e.countries.some(k=>k.r_code===j),n=!w||e.countries.some(k=>k.c_code===w),r=!I||e.image_type===I,o=!N||N==="single"&&(!e.image_count||e.image_count<=1)&&(!e.all_image_ids||e.all_image_ids.length<=1)||N==="multiple"&&(e.image_count&&e.image_count>1||e.all_image_ids&&e.all_image_ids.length>1),u=!b||e.starred===!0,h=a&&s&&l&&i&&n&&r&&o&&u;return!h&&(p||y||v||j||w||I||N||b)?(setTimeout(()=>{Ze()},100),e):h?e:null},[e,p,y,v,j,w,I,N,b]),Ze=c.useCallback(async()=>{R(!0);try{const a=new URLSearchParams;p&&a.append("search",p),y&&a.append("source",y),v&&a.append("event_type",v),j&&a.append("region",j),w&&a.append("country",w),I&&a.append("image_type",I),N&&a.append("upload_type",N),b&&a.append("starred_only","true");const s=await fetch(`/api/images/grouped?${a.toString()}`);if(s.ok){const l=await s.json();if(l.length>0){const i=l[0];i&&i.image_id&&x(`/map/${i.image_id}`)}else x("/explore")}}catch(a){console.error("Failed to navigate to matching image:",a),x("/explore")}finally{R(!1)}},[p,y,v,j,w,I,N,b,x]),Qe=()=>{if(!e)return;if(!e.all_image_ids||e.all_image_ids.length<=1){const i=`/upload?step=1&contribute=true&imageIds=${[e.image_id].join(",")}`;x(i);return}const s=`/upload?step=1&contribute=true&imageIds=${e.all_image_ids.join(",")}`;x(s)},T=(a,s)=>({image:`images/${s}`,caption:a.edited||a.generated||"",metadata:{image_id:a.image_count&&a.image_count>1?a.all_image_ids||[a.image_id]:a.image_id,title:a.title,source:a.source,event_type:a.event_type,image_type:a.image_type,countries:a.countries,starred:a.starred,image_count:a.image_count||1}}),Xe=async a=>{if(e){ae(!0),te(!1);try{const s=(await oa(async()=>{const{default:o}=await import("./jszip.min-p_IMUA3t.js").then(u=>u.j);return{default:o}},__vite__mapDeps([0,1,2]))).default,l=new s;if(e.image_type==="crisis_map"){const o=l.folder("crisis_maps_dataset"),u=o?.folder("images");if(u)try{const h=e.image_count&&e.image_count>1?e.all_image_ids||[e.image_id]:[e.image_id],k=h.map(async(f,M)=>{try{const C=await fetch(`/api/images/${f}/file`);if(!C.ok)throw new Error(`Failed to fetch image ${f}`);const S=await C.blob(),X=e.file_key.split(".").pop()||"jpg",W=`0001_${String(M+1).padStart(2,"0")}.${X}`;return u.file(W,S),{success:!0,fileName:W,imageId:f}}catch(C){return console.error(`Failed to process image ${f}:`,C),{success:!1,fileName:"",imageId:f}}}),F=(await Promise.all(k)).filter(f=>f.success);if(F.length===0)throw new Error("No images could be processed");if(a==="fine-tuning"){const f=[],M=[],C=[],S=F.map(Ye=>`images/${Ye.fileName}`),X=Math.random(),W={image:S.length===1?S[0]:S,caption:e.edited||e.generated||"",metadata:{image_id:h,title:e.title,source:e.source,event_type:e.event_type,image_type:e.image_type,countries:e.countries,starred:e.starred,image_count:e.image_count||1}};X<E/100?f.push(W):X<(E+J)/100?M.push(W):C.push(W),o&&(o.file("train.jsonl",JSON.stringify(f,null,2)),o.file("test.jsonl",JSON.stringify(M,null,2)),o.file("val.jsonl",JSON.stringify(C,null,2)))}else{const f=F.map(C=>`images/${C.fileName}`),M={image:f.length===1?f[0]:f,caption:e.edited||e.generated||"",metadata:{image_id:h,title:e.title,source:e.source,event_type:e.event_type,image_type:e.image_type,countries:e.countries,starred:e.starred,image_count:e.image_count||1}};o&&o.file("0001.json",JSON.stringify(M,null,2))}}catch(h){throw console.error(`Failed to process image ${e.image_id}:`,h),h}}else if(e.image_type==="drone_image"){const o=l.folder("drone_images_dataset"),u=o?.folder("images");if(u)try{const h=await fetch(`/api/images/${e.image_id}/file`);if(!h.ok)throw new Error(`Failed to fetch image ${e.image_id}`);const k=await h.blob(),F=`0001.${e.file_key.split(".").pop()||"jpg"}`;if(u.file(F,k),a==="fine-tuning"){const f=[],M=[],C=[];if(String(e?.image_type)==="crisis_map"){const S=Math.random();S<E/100?f.push(T(e,"0001")):S<(E+J)/100?M.push(T(e,"0001")):C.push(T(e,"0001"))}else if(String(e?.image_type)==="drone_image"){const S=Math.random();S<E/100?f.push(T(e,"0001")):S<(E+J)/100?M.push(T(e,"0001")):C.push(T(e,"0001"))}o&&(o.file("train.jsonl",JSON.stringify(f,null,2)),o.file("test.jsonl",JSON.stringify(M,null,2)),o.file("val.jsonl",JSON.stringify(C,null,2)))}else{const f={image:`images/${F}`,caption:e.edited||e.generated||"",metadata:{image_id:e.image_count&&e.image_count>1?e.all_image_ids||[e.image_id]:e.image_id,title:e.title,source:e.source,event_type:e.event_type,image_type:e.image_type,countries:e.countries,starred:e.starred,image_count:e.image_count||1}};o&&o.file("0001.json",JSON.stringify(f,null,2))}}catch(h){throw console.error(`Failed to process image ${e.image_id}:`,h),h}}else{const o=l.folder("generic_dataset"),u=o?.folder("images");if(u)try{const h=await fetch(`/api/images/${e.image_id}/file`);if(!h.ok)throw new Error(`Failed to fetch image ${e.image_id}`);const k=await h.blob(),F=`0001.${e.file_key.split(".").pop()||"jpg"}`;if(u.file(F,k),a==="fine-tuning"){const f=[],M=[],C=[];if(String(e?.image_type)==="crisis_map"){const S=Math.random();S<E/100?f.push(T(e,"0001")):S<(E+J)/100?M.push(T(e,"0001")):C.push(T(e,"0001"))}else if(String(e?.image_type)==="drone_image"){const S=Math.random();S<E/100?f.push(T(e,"0001")):S<(E+J)/100?M.push(T(e,"0001")):C.push(T(e,"0001"))}o&&(o.file("train.jsonl",JSON.stringify(f,null,2)),o.file("test.jsonl",JSON.stringify(M,null,2)),o.file("val.jsonl",JSON.stringify(C,null,2)))}else{const f={image:`images/${F}`,caption:e.edited||e.generated||"",metadata:{image_id:e.image_count&&e.image_count>1?e.all_image_ids||[e.image_id]:e.image_id,title:e.title,source:e.source,event_type:e.event_type,image_type:e.image_type,countries:e.countries,starred:e.starred,image_count:e.image_count||1}};o&&o.file("0001.json",JSON.stringify(f,null,2))}}catch(h){throw console.error(`Failed to process image ${e.image_id}:`,h),h}}const i=await l.generateAsync({type:"blob"}),n=URL.createObjectURL(i),r=document.createElement("a");r.href=n,r.download=`dataset_${e.image_type}_${e.image_id}_${a}_${new Date().toISOString().split("T")[0]}.zip`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n),console.log(`Exported ${e.image_type} dataset with 1 image in ${a} mode`),te(!0)}catch(s){console.error("Export failed:",s),alert("Failed to export dataset. Please try again.")}finally{ae(!1)}}};return z?t.jsx(Y,{children:t.jsx("div",{className:m.loadingContainer,children:t.jsxs("div",{className:"flex flex-col items-center gap-4",children:[t.jsx(je,{className:"text-ifrcRed"}),t.jsx("div",{children:"Loading map details..."})]})})}):le||!e?t.jsx(Y,{children:t.jsx("div",{className:m.errorContainer,children:t.jsxs("div",{className:"flex flex-col items-center gap-4 text-center",children:[t.jsx("div",{className:"text-4xl",children:"âš ï¸"}),t.jsx("div",{className:"text-xl font-semibold",children:"Unable to load map"}),t.jsx("div",{children:le||"Map not found"}),t.jsx(L,{name:"back-to-explore",variant:"secondary",onClick:()=>x("/explore"),children:"Return to Explore"})]})})}):t.jsxs(Y,{children:[t.jsxs("div",{className:"max-w-7xl mx-auto",children:[t.jsxs("div",{className:m.tabSelector,children:[t.jsx(sa,{name:"map-details-view",value:re,onChange:a=>{(a==="mapDetails"||a==="explore")&&(Ie(a),a==="explore"&&x("/explore"))},options:We,keySelector:a=>a.key,labelSelector:a=>a.label}),t.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[t.jsx(P,{withInternalPadding:!0,className:"bg-white/20 backdrop-blur-sm rounded-md p-2",children:t.jsxs(L,{name:"reference-examples",variant:b?"primary":"secondary",onClick:()=>Oe(!b),className:"whitespace-nowrap",children:[t.jsx("span",{className:"mr-2",children:b?t.jsx("span",{className:"text-yellow-400",children:"â˜…"}):t.jsx("span",{className:"text-yellow-400",children:"â˜†"})}),"Reference Examples"]})}),t.jsx(L,{name:"export-dataset",variant:"secondary",onClick:()=>Z(!0),children:"Export"})]})]}),t.jsx(la,{sources:ce,types:de,regions:me,countries:De,imageTypes:ge,isLoadingFilters:!1}),re==="mapDetails"?t.jsx("div",{className:"relative",children:d?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:m.gridLayout,children:[t.jsxs(P,{heading:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{children:d.title||"Map Image"}),d.starred&&t.jsx("span",{className:"text-red-500 text-xl",title:"Starred image",children:"â˜…"})]}),headingLevel:2,withHeaderBorder:!0,withInternalPadding:!0,spacing:"comfortable",children:[t.jsx("div",{className:m.imageContainer,children:e?.image_count&&e.image_count>1||_.length>1?t.jsxs("div",{className:m.carouselContainer,children:[t.jsx("div",{className:m.carouselImageWrapper,children:G?t.jsxs("div",{className:m.imagePlaceholder,children:[t.jsx(je,{className:"text-ifrcRed"}),t.jsx("div",{children:"Loading images..."})]}):_[D]?.detail_url?t.jsx("img",{src:_[D].detail_url,alt:_[D].file_key,className:m.carouselImage,onError:a=>{console.log("MapDetailsPage: Detail image failed to load, falling back to original:",_[D].detail_url);const s=a.target;_[D].image_url&&(s.src=_[D].image_url)},onLoad:()=>console.log("MapDetailsPage: Detail image loaded successfully:",_[D].detail_url)}):_[D]?.image_url?t.jsx("img",{src:_[D].image_url,alt:_[D].file_key,className:m.carouselImage,onLoad:()=>console.log("MapDetailsPage: Original image loaded successfully:",_[D].image_url)}):t.jsx("div",{className:m.imagePlaceholder,children:"No image available"})}),t.jsxs("div",{className:m.carouselNavigation,children:[t.jsx(L,{name:"previous-image",variant:"tertiary",size:1,onClick:Be,disabled:G,className:m.carouselButton,children:t.jsx(ie,{className:"w-4 h-4"})}),t.jsx("div",{className:m.carouselIndicators,children:_.map((a,s)=>t.jsx("button",{onClick:()=>Ve(s),className:`${m.carouselIndicator} ${s===D?m.carouselIndicatorActive:""}`,disabled:G,children:s+1},s))}),t.jsx(L,{name:"next-image",variant:"tertiary",size:1,onClick:Je,disabled:G,className:m.carouselButton,children:t.jsx(ne,{className:"w-4 h-4"})})]}),t.jsx("div",{className:m.viewImageButtonContainer,children:t.jsx(L,{name:"view-full-size-carousel",variant:"secondary",size:1,onClick:()=>ye(_[D]),disabled:G||!_[D]?.image_url,children:"View Image"})})]}):t.jsxs("div",{className:m.singleImageContainer,children:[d.detail_url?t.jsx("img",{src:d.detail_url,alt:d.file_key,onError:a=>{console.log("MapDetailsPage: Detail image failed to load, falling back to original:",d.detail_url);const s=a.target;d.image_url&&(s.src=d.image_url)},onLoad:()=>console.log("MapDetailsPage: Detail image loaded successfully:",d.detail_url)}):d.image_url?t.jsx("img",{src:d.image_url,alt:d.file_key,onLoad:()=>console.log("MapDetailsPage: Original image loaded successfully:",d.image_url)}):t.jsx("div",{className:m.imagePlaceholder,children:"No image available"}),t.jsx("div",{className:m.viewImageButtonContainer,children:t.jsx(L,{name:"view-full-size-single",variant:"secondary",size:1,onClick:()=>ye(d),disabled:!d.image_url,children:"View Image"})})]})}),t.jsx(P,{withInternalPadding:!0,className:"bg-white/20 backdrop-blur-sm rounded-md p-2",children:t.jsxs("div",{className:m.metadataTags,children:[d.image_type!=="drone_image"&&t.jsx("span",{className:m.metadataTag,children:ce.find(a=>a.s_code===d.source)?.label||d.source}),t.jsx("span",{className:m.metadataTag,children:de.find(a=>a.t_code===d.event_type)?.label||d.event_type}),t.jsx("span",{className:m.metadataTag,children:ge.find(a=>a.image_type===d.image_type)?.label||d.image_type}),d.countries&&d.countries.length>0&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:m.metadataTag,children:me.find(a=>a.r_code===d.countries[0].r_code)?.label||"Unknown Region"}),t.jsx("span",{className:m.metadataTag,children:d.countries.map(a=>a.label).join(", ")})]}),d.image_count&&d.image_count>1&&t.jsxs("span",{className:m.metadataTag,title:`Multi-upload with ${d.image_count} images`,children:["ðŸ“· ",d.image_count]}),(!d.image_count||d.image_count<=1)&&t.jsx("span",{className:m.metadataTag,title:"Single Upload",children:"Single"})]})})]}),t.jsx("div",{className:m.detailsSection,children:d.edited&&d.edited.includes("Description:")||d.generated&&d.generated.includes("Description:")?t.jsx(P,{heading:"AI Generated Content",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,spacing:"comfortable",children:t.jsx("div",{className:m.captionContainer,children:t.jsx("div",{className:m.captionText,children:(d.edited||d.generated||"").split(`
`).map((a,s)=>t.jsx("div",{children:a.startsWith("Description:")||a.startsWith("Analysis:")||a.startsWith("Recommended Actions:")?t.jsx("h4",{className:"font-semibold text-gray-800 mt-4 mb-2",children:a}):a.trim()===""?t.jsx("br",{}):t.jsx("p",{className:"mb-2",children:a})},s))})})}):t.jsx(P,{heading:"Description",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,spacing:"comfortable",children:t.jsx("div",{className:m.captionContainer,children:d.generated?t.jsx("div",{className:m.captionText,children:t.jsx("p",{children:d.edited||d.generated})}):t.jsx("p",{children:"â€” no caption yet â€”"})})})})]}),t.jsx("div",{className:"flex items-center justify-center mt-8",children:t.jsx(P,{withInternalPadding:!0,className:"bg-white/20 backdrop-blur-sm rounded-lg p-4",children:t.jsxs("div",{className:"flex items-center gap-4",children:[Me&&t.jsx(P,{withInternalPadding:!0,className:"rounded-md p-2",children:t.jsx(L,{name:"previous-item",variant:"tertiary",size:1,className:`bg-white/90 hover:bg-white shadow-lg border border-gray-200 ${B?"opacity-50 cursor-not-allowed":"hover:scale-110"}`,onClick:()=>ve("previous"),disabled:B,children:t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsxs("div",{className:"flex -space-x-1",children:[t.jsx(ie,{className:"w-4 h-4"}),t.jsx(ie,{className:"w-4 h-4"})]}),t.jsx("span",{className:"font-semibold",children:"Previous"})]})})}),oe&&t.jsx(P,{withInternalPadding:!0,className:"rounded-md p-2",children:t.jsx(L,{name:"delete",variant:"tertiary",size:1,className:"bg-red-50 hover:bg-red-100 text-red-700 border border-red-200 hover:border-red-300",onClick:Ge,title:"Delete","aria-label":"Delete saved image",children:t.jsx(ia,{className:"w-4 h-4"})})}),t.jsx(P,{withInternalPadding:!0,className:"rounded-md p-2",children:t.jsx(L,{name:"contribute",onClick:Qe,children:"Contribute"})}),oe&&t.jsx(P,{withInternalPadding:!0,className:"rounded-md p-2",children:t.jsx(L,{name:"toggle-star",variant:"tertiary",size:1,className:`${e?.starred?"bg-red-100 hover:bg-red-200 text-red-800 border-2 border-red-400":"bg-gray-100 hover:bg-gray-200 text-gray-600 border-2 border-gray-300"} w-16 h-8 rounded-full transition-all duration-200 flex items-center justify-center`,onClick:qe,title:e?.starred?"Unstar image":"Star image","aria-label":e?.starred?"Unstar image":"Star image",children:t.jsx("span",{className:`text-lg transition-all duration-200 ${e?.starred?"text-red-600":"text-gray-500"}`,children:e?.starred?"â˜…":"â˜†"})})}),Fe&&t.jsx(P,{withInternalPadding:!0,className:"rounded-md p-2",children:t.jsx(L,{name:"next-item",variant:"tertiary",size:1,className:`bg-white/90 hover:bg-white shadow-lg border border-gray-200 ${B?"opacity-50 cursor-not-allowed":"hover:scale-110"}`,onClick:()=>ve("next"),disabled:B,children:t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"font-semibold",children:"Next"}),t.jsxs("div",{className:"flex -space-x-1",children:[t.jsx(ne,{className:"w-4 h-4"}),t.jsx(ne,{className:"w-4 h-4"})]})]})})})]})})})]}):t.jsxs("div",{className:"text-center py-12",children:[t.jsx("div",{className:"text-xl font-semibold text-gray-600 mb-4",children:"No matches found"}),t.jsx("div",{className:"mt-4",children:t.jsx(L,{name:"clear-filters",variant:"secondary",onClick:Ue,children:"Clear Filters"})})]})}):null]}),Pe&&t.jsx("div",{className:m.fullSizeModalOverlay,onClick:()=>K(!1),children:t.jsx("div",{className:m.fullSizeModalContent,onClick:a=>a.stopPropagation(),children:t.jsxs("div",{className:m.ratingWarningContent,children:[t.jsx("h3",{className:m.ratingWarningTitle,children:"Delete Image?"}),t.jsx("p",{className:m.ratingWarningText,children:"This action cannot be undone. Are you sure you want to delete this saved image and all related data?"}),t.jsxs("div",{className:m.ratingWarningButtons,children:[t.jsx(L,{name:"confirm-delete",variant:"secondary",onClick:Ke,children:"Delete"}),t.jsx(L,{name:"cancel-delete",variant:"tertiary",onClick:()=>K(!1),children:"Cancel"})]})]})})}),ue&&t.jsx(ca,{isOpen:ue,onClose:()=>{Z(!1),te(!1),ae(!1)},onExport:(a,s)=>{s.includes(e.image_type)&&Xe(a)},filteredCount:1,totalCount:1,hasFilters:!1,crisisMapsCount:e.image_type==="crisis_map"?1:0,droneImagesCount:e.image_type==="drone_image"?1:0,isLoading:Ee,exportSuccess:$e,variant:"single",onNavigateToList:()=>{Z(!1),x("/explore")},onNavigateAndExport:()=>{Z(!1),x("/explore?export=true")}}),t.jsx(na,{isOpen:Re,imageUrl:Ae?.image_url||null,preview:null,selectedImageData:null,onClose:He,isLoading:ze})]})}export{st as default};
