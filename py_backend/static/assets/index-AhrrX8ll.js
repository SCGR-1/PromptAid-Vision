const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jszip.min-DF7oyuhK.js","assets/vendor-DuH7A22H.js","assets/utils-C_jntNQX.js"])))=>i.map(i=>d[i]);
import{j as e,N as ga,G as ms,U as St,S as us,A as gs,z as J,n as _,M as hs,Q as ps,a as fs,F as xs,O as ge,f as da,C as it,_ as ja,L as $a,b as xt,c as _s,B as ot,D as Ra,d as Ga,e as Ja,g as vs,R as Ia,h as ys,s as js,V as It,i as Cs,k as bs,o as _t,P as vt,K as Ea,y as ta,l as sa,m as ws,t as Ns}from"./ui-D_eh9MPL.js";import{d as Ss,u as Mt,e as Aa,a as s,O as Is,L as Ms,f as kt,g as ks,h as Ts,R as Ds}from"./vendor-DuH7A22H.js";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const b of document.querySelectorAll('link[rel="modulepreload"]'))h(b);new MutationObserver(b=>{for(const f of b)if(f.type==="childList")for(const o of f.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&h(o)}).observe(document,{childList:!0,subtree:!0});function v(b){const f={};return b.integrity&&(f.integrity=b.integrity),b.referrerPolicy&&(f.referrerPolicy=b.referrerPolicy),b.crossOrigin==="use-credentials"?f.credentials="include":b.crossOrigin==="anonymous"?f.credentials="omit":f.credentials="same-origin",f}function h(b){if(b.ep)return;b.ep=!0;const f=v(b);fetch(b.href,f)}})();var Wa={},yt;function Ps(){if(yt)return Wa;yt=1;var r=Ss();return Wa.createRoot=r.createRoot,Wa.hydrateRoot=r.hydrateRoot,Wa}var Ls=Ps();function Fs(r){return typeof r=="number"?Number.isNaN(r):!1}function Es(r){return r==null||Fs(r)}function $s(r,i){if(Es(r))return;const v={},h=[];return r.forEach(b=>{const f=i?i(b):JSON.stringify(b);v[f]||(v[f]=!0,h.push(b))}),r.length===h.length?r:h}const Rs=["Boolean","Number","String","Function","Array","Date","RegExp","Object","Error","Symbol"];Rs.reduce((r,i)=>({...r,[`[object ${i}]`]:i.toLowerCase()}),{});const As="_dropdownContainer_1six7_3",Os="_dropdownMenu_1six7_15",Bs="_dropdownContent_1six7_43",nt={dropdownContainer:As,dropdownMenu:Os,dropdownContent:Bs},zs=[{to:"/upload",label:"Upload",Icon:St},{to:"/explore",label:"Explore",Icon:us},{to:"/analytics",label:"Analytics",Icon:gs}];function Us(){const r=Mt(),i=Aa(),[v,h]=s.useState(!1),b=s.useRef(null);return s.useEffect(()=>{const f=o=>{b.current&&!b.current.contains(o.target)&&h(!1)};return document.addEventListener("mousedown",f),()=>{document.removeEventListener("mousedown",f)}},[]),e.jsx("nav",{className:"border-b border-gray-200 bg-white shadow-sm sticky top-0 z-50 backdrop-blur-sm bg-white/95",children:e.jsxs(ga,{className:"border-b-2 border-ifrcRed",contentClassName:"grid grid-cols-3 items-center py-6",children:[e.jsxs("div",{className:"flex items-center gap-4 min-w-0 cursor-pointer group transition-all duration-200 hover:scale-105",onClick:()=>{if(!(r.pathname==="/upload"||r.pathname==="/")){if(r.pathname==="/upload"){if(window.confirmNavigationIfNeeded){window.confirmNavigationIfNeeded("/");return}if(!confirm("You have unsaved changes. Are you sure you want to leave?"))return}i("/")}},children:[e.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-ifrcRed/10 to-ifrcRed/20 group-hover:from-ifrcRed/20 group-hover:to-ifrcRed/30 transition-all duration-200",children:e.jsx(ms,{className:"h-8 w-8 flex-shrink-0 text-ifrcRed"})}),e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"font-bold text-xl text-gray-900 leading-tight",children:"PromptAid Vision"})})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx("nav",{className:"flex items-center space-x-4 bg-gray-50/80 rounded-xl p-2 backdrop-blur-sm",children:zs.map(({to:f,label:o,Icon:M})=>{const G=r.pathname===f||f==="/upload"&&r.pathname==="/"||f==="/explore"&&r.pathname.startsWith("/map/"),w=r.pathname==="/upload"||r.pathname==="/",N=f==="/upload"||f==="/";return e.jsxs("div",{className:"relative",children:[e.jsx(J,{withInternalPadding:!0,className:"p-2",children:e.jsxs(_,{name:o.toLowerCase(),variant:G?"primary":"tertiary",size:1,className:`transition-all duration-200 ${G?"shadow-lg shadow-ifrcRed/20 transform scale-105":"hover:bg-white hover:shadow-md hover:scale-105"}`,onClick:()=>{if(!(w&&N)){if(r.pathname==="/upload"){if(window.confirmNavigationIfNeeded){window.confirmNavigationIfNeeded(f);return}if(!confirm("You have unsaved changes. Are you sure you want to leave?"))return}i(f)}},children:[e.jsx(M,{className:`w-4 h-4 transition-transform duration-200 ${G?"scale-110":"group-hover:scale-110"}`}),e.jsx("span",{className:"inline ml-2 font-semibold",children:o})]})}),G&&e.jsx("div",{className:"absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-8 h-1 bg-ifrcRed rounded-full animate-pulse"})]},f)})})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("div",{className:nt.dropdownContainer,ref:b,children:[e.jsx(J,{withInternalPadding:!0,className:"p-2",children:e.jsx(_,{name:"more-options",variant:v?"primary":"tertiary",size:1,className:"transition-all duration-200",onClick:()=>h(!v),children:e.jsx(hs,{className:"w-4 h-4"})})}),v&&e.jsx("div",{className:nt.dropdownMenu,children:e.jsxs("div",{className:nt.dropdownContent,children:[e.jsx(J,{withInternalPadding:!0,className:"p-2",children:e.jsxs(_,{name:"help-support",variant:"tertiary",size:1,className:"w-full justify-start",onClick:()=>{if(h(!1),r.pathname==="/upload"){if(window.confirmNavigationIfNeeded){window.confirmNavigationIfNeeded("/help");return}if(!confirm("You have unsaved changes. Are you sure you want to leave?"))return}i("/help")},children:[e.jsx(ps,{className:"w-4 h-4"}),e.jsx("span",{className:"ml-2 font-semibold",children:"Help & Support"})]})}),e.jsx(J,{withInternalPadding:!0,className:"p-2",children:e.jsxs(_,{name:"dev",variant:"tertiary",size:1,className:"w-full justify-start",onClick:()=>{if(h(!1),r.pathname==="/upload"){if(window.confirmNavigationIfNeeded){window.confirmNavigationIfNeeded("/admin");return}if(!confirm("You have unsaved changes. Are you sure you want to leave?"))return}i("/admin")},children:[e.jsx(fs,{className:"w-4 h-4"}),e.jsx("span",{className:"ml-2 font-semibold",children:"Dev"})]})})]})})]})})]})})}function Ws(){return e.jsxs(e.Fragment,{children:[e.jsx(Us,{}),e.jsx(Is,{})]})}const Hs="_uploadContainer_1w5i1_1",Vs="_dropZone_1w5i1_9",Gs="_hasFile_1w5i1_30",Js="_dropZoneIcon_1w5i1_37",qs="_dropZoneText_1w5i1_43",Ys="_dropZoneSubtext_1w5i1_49",Qs="_filePreview_1w5i1_55",Zs="_filePreviewImage_1w5i1_64",Ks="_fileName_1w5i1_110",Xs="_fileInfo_1w5i1_118",en="_helpLink_1w5i1_125",an="_loadingContainer_1w5i1_145",tn="_loadingText_1w5i1_153",sn="_generateButtonContainer_1w5i1_157",nn="_uploadedMapContainer_1w5i1_165",on="_uploadedMapImage_1w5i1_169",ln="_formGrid_1w5i1_209",rn="_titleField_1w5i1_222",cn="_ratingDescription_1w5i1_230",dn="_ratingSlider_1w5i1_235",mn="_ratingLabel_1w5i1_242",un="_ratingInput_1w5i1_251",gn="_ratingValue_1w5i1_256",hn="_submitSection_1w5i1_266",pn="_successContainer_1w5i1_275",fn="_successHeading_1w5i1_280",xn="_successText_1w5i1_285",_n="_successButton_1w5i1_291",vn="_viewFullSizeButton_1w5i1_297",yn="_fullSizeModalOverlay_1w5i1_306",jn="_lightModalOverlay_1w5i1_320",Cn="_fullSizeModalContent_1w5i1_334",bn="_fullSizeModalHeader_1w5i1_345",wn="_fullSizeModalImage_1w5i1_361",Nn="_confirmSection_1w5i1_398",Sn="_step2Layout_1w5i1_407",In="_topRow_1w5i1_413",Mn="_ratingHidden_1w5i1_421",kn="_imageSection_1w5i1_425",Tn="_ratingContent_1w5i1_435",Dn="_mapColumn_1w5i1_453",Pn="_contentColumn_1w5i1_458",Ln="_step2bLayout_1w5i1_465",Fn="_metadataSectionCard_1w5i1_562",En="_droneMetadataSection_1w5i1_571",$n="_droneMetadataHeading_1w5i1_577",Rn="_droneMetadataGrid_1w5i1_585",An="_rtkFixContainer_1w5i1_591",On="_rtkFixLabel_1w5i1_597",Bn="_rtkFixCheckbox_1w5i1_606",zn="_confirmButtonContainer_1w5i1_621",Un="_ratingWarningContent_1w5i1_629",Wn="_ratingWarningTitle_1w5i1_637",Hn="_ratingWarningText_1w5i1_644",Vn="_ratingWarningButtons_1w5i1_651",Gn="_preprocessingProgress_1w5i1_658",Jn="_carouselContainer_1w5i1_711",qn="_carouselImageWrapper_1w5i1_716",Yn="_carouselImage_1w5i1_716",Qn="_carouselNavigation_1w5i1_739",Zn="_carouselButton_1w5i1_751",Kn="_carouselIndicators_1w5i1_775",Xn="_carouselIndicator_1w5i1_775",ei="_carouselIndicatorActive_1w5i1_804",ai="_viewImageButtonContainer_1w5i1_840",g={uploadContainer:Hs,dropZone:Vs,hasFile:Gs,dropZoneIcon:Js,dropZoneText:qs,dropZoneSubtext:Ys,filePreview:Qs,filePreviewImage:Zs,fileName:Ks,fileInfo:Xs,helpLink:en,loadingContainer:an,loadingText:tn,generateButtonContainer:sn,uploadedMapContainer:nn,uploadedMapImage:on,formGrid:ln,titleField:rn,ratingDescription:cn,ratingSlider:dn,ratingLabel:mn,ratingInput:un,ratingValue:gn,submitSection:hn,successContainer:pn,successHeading:fn,successText:xn,successButton:_n,viewFullSizeButton:vn,fullSizeModalOverlay:yn,lightModalOverlay:jn,fullSizeModalContent:Cn,fullSizeModalHeader:bn,fullSizeModalImage:wn,confirmSection:Nn,step2Layout:Sn,topRow:In,ratingHidden:Mn,imageSection:kn,ratingContent:Tn,mapColumn:Dn,contentColumn:Pn,step2bLayout:Ln,metadataSectionCard:Fn,droneMetadataSection:En,droneMetadataHeading:$n,droneMetadataGrid:Rn,rtkFixContainer:An,rtkFixLabel:On,rtkFixCheckbox:Bn,confirmButtonContainer:zn,ratingWarningContent:Un,ratingWarningTitle:Wn,ratingWarningText:Hn,ratingWarningButtons:Vn,preprocessingProgress:Gn,carouselContainer:Jn,carouselImageWrapper:qn,carouselImage:Yn,carouselNavigation:Qn,carouselButton:Zn,carouselIndicators:Kn,carouselIndicator:Xn,carouselIndicatorActive:ei,viewImageButtonContainer:ai},Tt=s.createContext(void 0),ti=({children:r})=>{const[i,v]=s.useState(""),[h,b]=s.useState(""),[f,o]=s.useState(""),[M,G]=s.useState(""),[w,N]=s.useState(""),[D,se]=s.useState(""),[q,R]=s.useState(""),[re,ye]=s.useState(!1),de={search:i,srcFilter:h,catFilter:f,regionFilter:M,countryFilter:w,imageTypeFilter:D,uploadTypeFilter:q,showReferenceExamples:re,setSearch:v,setSrcFilter:b,setCatFilter:o,setRegionFilter:G,setCountryFilter:N,setImageTypeFilter:se,setUploadTypeFilter:R,setShowReferenceExamples:ye,clearAllFilters:()=>{v(""),b(""),o(""),G(""),N(""),se(""),R(""),ye(!1)}};return e.jsx(Tt.Provider,{value:de,children:r})},qa=()=>{const r=s.useContext(Tt);if(r===void 0)throw new Error("useFilterContext must be used within a FilterProvider");return r};function Dt({sources:r,types:i,regions:v,countries:h,imageTypes:b,isLoadingFilters:f=!1}){const[o,M]=s.useState(!1),{search:G,setSearch:w,srcFilter:N,setSrcFilter:D,catFilter:se,setCatFilter:q,regionFilter:R,setRegionFilter:re,countryFilter:ye,setCountryFilter:he,imageTypeFilter:de,setImageTypeFilter:je,uploadTypeFilter:Ye,setUploadTypeFilter:be,showReferenceExamples:we,setShowReferenceExamples:ee,clearAllFilters:Ne}=qa();return e.jsxs("div",{className:"mb-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsx(J,{withInternalPadding:!0,className:"bg-white/20 backdrop-blur-sm rounded-md p-2",children:e.jsx(_,{name:"toggle-filters",variant:"secondary",onClick:()=>M(!o),className:"whitespace-nowrap",title:o?"Hide Filters":"Show Filters",children:e.jsx(xs,{className:"w-4 h-4"})})}),e.jsx(J,{withInternalPadding:!0,className:"bg-white/20 backdrop-blur-sm rounded-md p-2 flex-1 min-w-[300px]",children:e.jsx(ge,{name:"search",placeholder:"Search examples...",value:G,onChange:I=>w(I||"")})}),e.jsx(J,{withInternalPadding:!0,className:"bg-white/20 backdrop-blur-sm rounded-md p-2",children:e.jsx(_,{name:"clear-filters",variant:"secondary",onClick:Ne,children:"Clear Filters"})})]}),o&&e.jsx("div",{className:"bg-white/20 backdrop-blur-sm rounded-md p-4",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[e.jsx(J,{withInternalPadding:!0,className:"p-2",children:e.jsx(da,{name:"source",placeholder:f?"Loading...":"All Sources",options:r,value:N||null,onChange:I=>D(I||""),keySelector:I=>I.s_code,labelSelector:I=>I.label,required:!1,disabled:f})}),e.jsx(J,{withInternalPadding:!0,className:"p-2",children:e.jsx(da,{name:"category",placeholder:f?"Loading...":"All Categories",options:i,value:se||null,onChange:I=>q(I||""),keySelector:I=>I.t_code,labelSelector:I=>I.label,required:!1,disabled:f})}),e.jsx(J,{withInternalPadding:!0,className:"p-2",children:e.jsx(da,{name:"region",placeholder:f?"Loading...":"All Regions",options:v,value:R||null,onChange:I=>re(I||""),keySelector:I=>I.r_code,labelSelector:I=>I.label,required:!1,disabled:f})}),e.jsx(J,{withInternalPadding:!0,className:"p-2",children:e.jsx(it,{name:"country",placeholder:f?"Loading...":"All Countries",options:h,value:ye?[ye]:[],onChange:I=>he(I[0]||""),keySelector:I=>I.c_code,labelSelector:I=>I.label,disabled:f})}),e.jsx(J,{withInternalPadding:!0,className:"p-2",children:e.jsx(da,{name:"imageType",placeholder:f?"Loading...":"All Image Types",options:b,value:de||null,onChange:I=>je(I||""),keySelector:I=>I.image_type,labelSelector:I=>I.label,required:!1,disabled:f})}),e.jsx(J,{withInternalPadding:!0,className:"p-2",children:e.jsx(da,{name:"uploadType",placeholder:"All Upload Types",options:[{key:"single",label:"Single Upload"},{key:"multiple",label:"Multiple Upload"}],value:Ye||null,onChange:I=>be(I||""),keySelector:I=>I.key,labelSelector:I=>I.label,required:!1,disabled:!1})})]})})]})}const si="_fullSizeModalOverlay_cyz3b_1",ni="_fullSizeModalContent_cyz3b_29",ii="_ratingWarningContent_cyz3b_53",oi="_ratingWarningTitle_cyz3b_65",li="_exportModeSection_cyz3b_133",ri="_splitConfigSection_cyz3b_143",ci="_splitConfigTitle_cyz3b_153",di="_splitInputsContainer_cyz3b_167",mi="_splitInputGroup_cyz3b_183",ui="_splitInputLabel_cyz3b_197",gi="_splitInput_cyz3b_167",hi="_splitTotal_cyz3b_247",pi="_splitTotalError_cyz3b_261",fi="_checkboxesContainer_cyz3b_271",xi="_ratingWarningButtons_cyz3b_289",_i="_singleExportMessage_cyz3b_309",vi="_navigateButtonContainer_cyz3b_333",yi="_loadingOverlay_cyz3b_349",ve={fullSizeModalOverlay:si,fullSizeModalContent:ni,ratingWarningContent:ii,ratingWarningTitle:oi,exportModeSection:li,splitConfigSection:ri,splitConfigTitle:ci,splitInputsContainer:di,splitInputGroup:mi,splitInputLabel:ui,splitInput:gi,splitTotal:hi,splitTotalError:pi,checkboxesContainer:fi,ratingWarningButtons:xi,singleExportMessage:_i,navigateButtonContainer:vi,loadingOverlay:yi};function Pt({isOpen:r,onClose:i,onExport:v,crisisMapsCount:h,droneImagesCount:b,isLoading:f=!1,exportSuccess:o=!1,variant:M="bulk",onNavigateAndExport:G}){const[w,N]=s.useState("standard"),[D,se]=s.useState(80),[q,R]=s.useState(10),[re,ye]=s.useState(10),[he,de]=s.useState(!0),[je,Ye]=s.useState(!0),be=()=>{if(M==="single"){v(w,["crisis_map","drone_image"]);return}if(!he&&!je){alert("Please select at least one image type to export.");return}const ee=[];he&&ee.push("crisis_map"),je&&ee.push("drone_image"),v(w,ee)},we=()=>{i()};return r?M==="single"?e.jsx("div",{className:ve.fullSizeModalOverlay,onClick:we,children:e.jsxs("div",{className:ve.fullSizeModalContent,onClick:ee=>ee.stopPropagation(),children:[f&&e.jsx("div",{className:ve.loadingOverlay,children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx(ja,{className:"text-ifrcRed"}),e.jsx("div",{className:"text-lg font-medium",children:"Exporting..."}),e.jsx("div",{className:"text-sm text-gray-600",children:"This might take a few seconds"})]})}),o&&e.jsx("div",{className:ve.loadingOverlay,children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"text-lg font-medium",children:"Export Successful!"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Your dataset has been downloaded"}),e.jsx(_,{name:"close-export-success",onClick:we,className:"mt-4",children:"Close"})]})}),e.jsxs("div",{className:ve.ratingWarningContent,children:[e.jsx("h3",{className:ve.ratingWarningTitle,children:"Export Single Item"}),e.jsxs("div",{className:ve.singleExportMessage,children:[e.jsx("p",{children:"This only exports the 1 item currently on display."}),e.jsx("p",{children:'You may export the entire dataset from the "list view" here:'})]}),e.jsx("div",{className:ve.navigateButtonContainer,children:e.jsx(_,{name:"navigate-to-list",variant:"secondary",onClick:G,children:"Navigate to List View"})}),e.jsxs("div",{className:ve.ratingWarningButtons,children:[e.jsx(_,{name:"continue-export",onClick:be,disabled:f,children:f?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ja,{className:"text-white"}),"Exporting..."]}):"Continue"}),e.jsx(_,{name:"cancel-export",variant:"tertiary",onClick:we,disabled:f,children:"Cancel"})]})]})]})}):e.jsx("div",{className:ve.fullSizeModalOverlay,onClick:we,children:e.jsxs("div",{className:ve.fullSizeModalContent,onClick:ee=>ee.stopPropagation(),children:[f&&e.jsx("div",{className:ve.loadingOverlay,children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx(ja,{className:"text-ifrcRed"}),e.jsx("div",{className:"text-lg font-medium",children:"Exporting..."}),e.jsx("div",{className:"text-sm text-gray-600",children:"This might take a few seconds"})]})}),o&&e.jsx("div",{className:ve.loadingOverlay,children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"text-lg font-medium",children:"Export Successful!"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Your dataset has been downloaded"}),e.jsx(_,{name:"close-export-success",onClick:we,className:"mt-4",children:"Close"})]})}),e.jsxs("div",{className:ve.ratingWarningContent,children:[e.jsx("h3",{className:ve.ratingWarningTitle,children:"Export Dataset"}),e.jsx("div",{className:ve.exportModeSection,children:e.jsx($a,{name:"export-mode",value:w,onChange:ee=>{(ee==="standard"||ee==="fine-tuning")&&N(ee)},options:[{key:"standard",label:"Standard"},{key:"fine-tuning",label:"Fine-tuning"}],keySelector:ee=>ee.key,labelSelector:ee=>ee.label,disabled:f})}),w==="fine-tuning"&&e.jsxs("div",{className:ve.splitConfigSection,children:[e.jsx("div",{className:ve.splitConfigTitle,children:"Dataset Split Configuration"}),e.jsxs("div",{className:ve.splitInputsContainer,children:[e.jsxs("div",{className:ve.splitInputGroup,children:[e.jsx("label",{htmlFor:"train-split",className:ve.splitInputLabel,children:"Train (%)"}),e.jsx("input",{id:"train-split",type:"number",min:"0",max:"100",value:D,onChange:ee=>{const Ne=parseInt(ee.target.value)||0,I=100-Ne;I>=0&&(se(Ne),q+re>I&&(R(Math.floor(I/2)),ye(I-Math.floor(I/2))))},className:ve.splitInput,disabled:f})]}),e.jsxs("div",{className:ve.splitInputGroup,children:[e.jsx("label",{htmlFor:"test-split",className:ve.splitInputLabel,children:"Test (%)"}),e.jsx("input",{id:"test-split",type:"number",min:"0",max:"100",value:q,onChange:ee=>{const Ne=parseInt(ee.target.value)||0,I=100-D-Ne;I>=0&&(R(Ne),ye(I))},className:ve.splitInput,disabled:f})]}),e.jsxs("div",{className:ve.splitInputGroup,children:[e.jsx("label",{htmlFor:"val-split",className:ve.splitInputLabel,children:"Val (%)"}),e.jsx("input",{id:"val-split",type:"number",min:"0",max:"100",value:re,onChange:ee=>{const Ne=parseInt(ee.target.value)||0,I=100-D-Ne;I>=0&&(ye(Ne),R(I))},className:ve.splitInput,disabled:f})]})]}),D+q+re!==100&&e.jsx("div",{className:ve.splitTotal,children:e.jsx("span",{className:ve.splitTotalError,children:"Must equal 100%"})})]}),e.jsxs("div",{className:ve.checkboxesContainer,children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsx(xt,{name:"crisis-maps",label:`Crisis Maps (${h} images)`,value:he,onChange:ee=>de(ee),disabled:f})}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsx(xt,{name:"drone-images",label:`Drone Images (${b} images)`,value:je,onChange:ee=>Ye(ee),disabled:f})})]}),e.jsxs("div",{className:ve.ratingWarningButtons,children:[e.jsx(_,{name:"confirm-export",onClick:be,disabled:f,children:f?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ja,{className:"text-white"}),"Exporting..."]}):"Export Selected"}),e.jsx(_,{name:"cancel-export",variant:"tertiary",onClick:we,disabled:f,children:"Cancel"})]})]})]})}):null}function jt({files:r,file:i,preview:v,imageType:h,onFileChange:b,onRemoveImage:f,onAddImage:o,onImageTypeChange:M,onChangeFile:G}){const w=N=>{N.preventDefault();const D=N.dataTransfer.files?.[0];D&&b(D)};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-gray-700 leading-relaxed max-w-2xl mx-auto",children:"This app evaluates how well multimodal AI models analyze and describe crisis maps and drone imagery. Upload an image and the AI will generate a description. Then you can review and rate the result based on your expertise."}),e.jsx("div",{className:g.helpLink,children:e.jsxs(Ms,{to:"/help",className:g.helpLink,children:["More ",e.jsx(_s,{className:"w-3 h-3"})]})}),e.jsx("div",{className:"flex justify-center",children:e.jsx(J,{withInternalPadding:!0,className:"bg-transparent border-none shadow-none",children:e.jsx($a,{name:"image-type",value:h,onChange:N=>M(N),options:[{key:"crisis_map",label:"Crisis Maps"},{key:"drone_image",label:"Drone Imagery"}],keySelector:N=>N.key,labelSelector:N=>N.label})})}),e.jsxs("div",{className:`${g.dropZone} ${i?g.hasFile:""}`,onDragOver:N=>N.preventDefault(),onDrop:w,children:[r.length>1?e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-4",children:r.map((N,D)=>e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:URL.createObjectURL(N),alt:`Image ${D+1}`,className:"w-full h-32 object-cover rounded"}),e.jsx(ot,{name:"remove-image",variant:"tertiary",onClick:()=>f(D),title:"Remove image",ariaLabel:"Remove image",className:"absolute top-2 right-2 bg-white/90 hover:bg-white shadow-md hover:shadow-lg border border-gray-200 hover:border-red-300 transition-all duration-200 backdrop-blur-sm",children:e.jsx(Ra,{className:"w-4 h-4"})}),e.jsx("div",{className:"text-xs text-center mt-1",children:N.name})]},D))}):i&&v?e.jsxs("div",{className:g.filePreview,children:[e.jsx("div",{className:g.filePreviewImage,children:e.jsx("img",{src:v,alt:"File preview"})}),e.jsx("p",{className:g.fileName,children:i.name}),e.jsxs("p",{className:g.fileInfo,children:[(i.size/1024/1024).toFixed(2)," MB"]})]}):e.jsxs(e.Fragment,{children:[e.jsx(St,{className:g.dropZoneIcon}),e.jsx("p",{className:g.dropZoneText,children:"Drag & Drop any file here"}),e.jsx("p",{className:g.dropZoneSubtext,children:"or"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("label",{className:"inline-block cursor-pointer",children:[e.jsx("input",{type:"file",className:"sr-only",accept:".jpg,.jpeg,.png,.tiff,.tif,.heic,.heif,.webp,.gif,.pdf",onChange:N=>{i&&G?G(N.target.files?.[0]):b(N.target.files?.[0])}}),e.jsx(_,{name:"upload",variant:"secondary",size:1,onClick:()=>document.querySelector('input[type="file"]')?.click(),children:i?"Change Image":"Browse Files"})]}),i&&r.length<5&&e.jsx(_,{name:"add-image",variant:"secondary",size:1,onClick:o,children:"Add Image"})]})]})]})}function Ct({files:r,imageUrl:i,preview:v,onViewFullSize:h,currentImageIndex:b=0,onGoToPrevious:f,onGoToNext:o,onGoToImage:M,showCarousel:G=!1}){return G&&r.length>1?e.jsx(J,{heading:"Uploaded Images",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsxs("div",{className:g.carouselContainer,children:[e.jsx("div",{className:g.carouselImageWrapper,children:r[b]?e.jsx("img",{src:URL.createObjectURL(r[b]),alt:`Image ${b+1}`,className:g.carouselImage}):e.jsx("div",{className:g.imagePlaceholder,children:"No image available"})}),e.jsxs("div",{className:g.carouselNavigation,children:[e.jsx(_,{name:"previous-image",variant:"tertiary",size:1,onClick:f,className:g.carouselButton,children:e.jsx(Ga,{className:"w-4 h-4"})}),e.jsx("div",{className:g.carouselIndicators,children:r.map((w,N)=>e.jsx("button",{onClick:()=>M?.(N),className:`${g.carouselIndicator} ${N===b?g.carouselIndicatorActive:""}`,children:N+1},N))}),e.jsx(_,{name:"next-image",variant:"tertiary",size:1,onClick:o,className:g.carouselButton,children:e.jsx(Ja,{className:"w-4 h-4"})})]}),e.jsx("div",{className:g.viewImageButtonContainer,children:e.jsx(_,{name:"view-full-size-carousel",variant:"secondary",size:1,onClick:()=>h({file:r[b],index:b}),disabled:!r[b],children:"View Image"})})]})}):r.length>1?e.jsx("div",{className:"space-y-6",children:r.map((w,N)=>e.jsx(J,{heading:`Image ${N+1}: ${w.name}`,headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsxs("div",{className:g.uploadedMapContainer,children:[e.jsx("div",{className:g.uploadedMapImage,children:e.jsx("img",{src:URL.createObjectURL(w),alt:`Image ${N+1}`})}),e.jsx("div",{className:g.viewFullSizeButton,children:e.jsx(_,{name:`view-full-size-${N}`,variant:"secondary",size:1,onClick:()=>h({file:w,index:N}),children:"View Image"})})]})},N))}):e.jsx(J,{heading:"Uploaded Image",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsxs("div",{className:g.uploadedMapContainer,children:[e.jsx("div",{className:g.uploadedMapImage,children:e.jsx("img",{src:i||v||void 0,alt:"Uploaded image preview"})}),e.jsx("div",{className:g.viewFullSizeButton,children:e.jsx(_,{name:"view-full-size",variant:"secondary",size:1,onClick:()=>h(),children:"View Image"})})]})})}function ji({files:r,imageType:i,title:v,source:h,eventType:b,epsg:f,countries:o,centerLon:M,centerLat:G,amslM:w,aglM:N,headingDeg:D,yawDeg:se,pitchDeg:q,rollDeg:R,rtkFix:re,stdHM:ye,stdVM:he,metadataArray:de,sources:je,types:Ye,spatialReferences:be,imageTypes:we,countriesOptions:ee,onTitleChange:Ne,onSourceChange:I,onEventTypeChange:pe,onEpsgChange:ne,onCountriesChange:la,onCenterLonChange:He,onCenterLatChange:ma,onAmslMChange:Ve,onAglMChange:ea,onHeadingDegChange:Ee,onYawDegChange:Y,onPitchDegChange:xe,onRollDegChange:Ge,onRtkFixChange:Xe,onStdHMChange:Te,onStdVMChange:ra,onImageTypeChange:Qe,updateMetadataForImage:ue}){return r.length>1?e.jsxs("div",{children:[e.jsx("div",{className:"mb-4",children:e.jsx(ge,{label:"Shared Title",name:"title",value:v,onChange:Ne,placeholder:"Enter a title for all images...",required:!0})}),r.map((me,$)=>e.jsx("div",{className:"mb-6",children:e.jsx(J,{heading:`Image ${$+1}: ${me.name}`,headingLevel:4,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsxs("div",{className:g.formGrid,children:[i!=="drone_image"&&e.jsx(da,{label:"Source",name:`source_${$}`,value:de[$]?.source||"",onChange:T=>ue($,"source",T),options:je,keySelector:T=>T.s_code,labelSelector:T=>T.label,required:!0}),e.jsx(da,{label:"Event Type",name:`event_type_${$}`,value:de[$]?.eventType||"",onChange:T=>ue($,"eventType",T),options:Ye,keySelector:T=>T.t_code,labelSelector:T=>T.label,required:i!=="drone_image"}),e.jsx(da,{label:"EPSG",name:`epsg_${$}`,value:de[$]?.epsg||"",onChange:T=>ue($,"epsg",T),options:be,keySelector:T=>T.epsg,labelSelector:T=>`${T.srid} (EPSG:${T.epsg})`,placeholder:"EPSG",required:i!=="drone_image"}),e.jsx(it,{label:"Countries (optional)",name:`countries_${$}`,value:de[$]?.countries||[],onChange:T=>ue($,"countries",T),options:ee,keySelector:T=>T.c_code,labelSelector:T=>T.label,placeholder:"Select one or more"}),i==="drone_image"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:g.droneMetadataSection,children:[e.jsx("h4",{className:g.droneMetadataHeading,children:"Drone Flight Data"}),e.jsxs("div",{className:g.droneMetadataGrid,children:[e.jsx(ge,{label:"Center Longitude",name:`center_lon_${$}`,value:de[$]?.centerLon||"",onChange:T=>ue($,"centerLon",T),placeholder:"e.g., -122.4194",step:"any"}),e.jsx(ge,{label:"Center Latitude",name:`center_lat_${$}`,value:de[$]?.centerLat||"",onChange:T=>ue($,"centerLat",T),placeholder:"e.g., 37.7749",step:"any"}),e.jsx(ge,{label:"Altitude AMSL (m)",name:`amsl_m_${$}`,value:de[$]?.amslM||"",onChange:T=>ue($,"amslM",T),placeholder:"e.g., 100.5",step:"any"}),e.jsx(ge,{label:"Altitude AGL (m)",name:`agl_m_${$}`,value:de[$]?.aglM||"",onChange:T=>ue($,"aglM",T),placeholder:"e.g., 50.2",step:"any"}),e.jsx(ge,{label:"Heading (degrees)",name:`heading_deg_${$}`,value:de[$]?.headingDeg||"",onChange:T=>ue($,"headingDeg",T),placeholder:"e.g., 180.0",step:"any"}),e.jsx(ge,{label:"Yaw (degrees)",name:`yaw_deg_${$}`,value:de[$]?.yawDeg||"",onChange:T=>ue($,"yawDeg",T),placeholder:"e.g., 90.0",step:"any"}),e.jsx(ge,{label:"Pitch (degrees)",name:`pitch_deg_${$}`,value:de[$]?.pitchDeg||"",onChange:T=>ue($,"pitchDeg",T),placeholder:"e.g., 0.0",step:"any"}),e.jsx(ge,{label:"Roll (degrees)",name:`roll_deg_${$}`,value:de[$]?.rollDeg||"",onChange:T=>ue($,"rollDeg",T),placeholder:"e.g., 0.0",step:"any"}),e.jsx("div",{className:g.rtkFixContainer,children:e.jsxs("label",{className:g.rtkFixLabel,children:[e.jsx("input",{type:"checkbox",checked:de[$]?.rtkFix||!1,onChange:T=>ue($,"rtkFix",T.target.checked),className:g.rtkFixCheckbox}),"RTK Fix Available"]})}),e.jsx(ge,{label:"Horizontal Std Dev (m)",name:`std_h_m_${$}`,value:de[$]?.stdHM||"",onChange:T=>ue($,"stdHM",T),placeholder:"e.g., 0.1",step:"any"}),e.jsx(ge,{label:"Vertical Std Dev (m)",name:`std_v_m_${$}`,value:de[$]?.stdVM||"",onChange:T=>ue($,"stdVM",T),placeholder:"e.g., 0.2",step:"any"})]})]})})]})})},$))]}):e.jsxs("div",{className:g.formGrid,children:[e.jsx("div",{className:g.titleField,children:e.jsx(ge,{label:"Title",name:"title",value:v,onChange:Ne,placeholder:"Enter a title for this map...",required:!0})}),i!=="drone_image"&&e.jsx(da,{label:"Source",name:"source",value:h,onChange:I,options:je,keySelector:me=>me.s_code,labelSelector:me=>me.label,required:!0}),e.jsx(da,{label:"Event Type",name:"event_type",value:b,onChange:pe,options:Ye,keySelector:me=>me.t_code,labelSelector:me=>me.label,required:i!=="drone_image"}),e.jsx(da,{label:"EPSG",name:"epsg",value:f,onChange:ne,options:be,keySelector:me=>me.epsg,labelSelector:me=>`${me.srid} (EPSG:${me.epsg})`,placeholder:"EPSG",required:i!=="drone_image"}),e.jsx(da,{label:"Image Type",name:"image_type",value:i,onChange:Qe,options:we,keySelector:me=>me.image_type,labelSelector:me=>me.label,required:!0}),e.jsx(it,{label:"Countries (optional)",name:"countries",value:o,onChange:la,options:ee,keySelector:me=>me.c_code,labelSelector:me=>me.label,placeholder:"Select one or more"}),i==="drone_image"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:g.droneMetadataSection,children:[e.jsx("h4",{className:g.droneMetadataHeading,children:"Drone Flight Data"}),e.jsxs("div",{className:g.droneMetadataGrid,children:[e.jsx(ge,{label:"Center Longitude",name:"center_lon",value:M,onChange:He,placeholder:"e.g., -122.4194",step:"any"}),e.jsx(ge,{label:"Center Latitude",name:"center_lat",value:G,onChange:ma,placeholder:"e.g., 37.7749",step:"any"}),e.jsx(ge,{label:"Altitude AMSL (m)",name:"amsl_m",value:w,onChange:Ve,placeholder:"e.g., 100.5",step:"any"}),e.jsx(ge,{label:"Altitude AGL (m)",name:"agl_m",value:N,onChange:ea,placeholder:"e.g., 50.2",step:"any"}),e.jsx(ge,{label:"Heading (degrees)",name:"heading_deg",value:D,onChange:Ee,placeholder:"e.g., 180.0",step:"any"}),e.jsx(ge,{label:"Yaw (degrees)",name:"yaw_deg",value:se,onChange:Y,placeholder:"e.g., 90.0",step:"any"}),e.jsx(ge,{label:"Pitch (degrees)",name:"pitch_deg",value:q,onChange:xe,placeholder:"e.g., 0.0",step:"any"}),e.jsx(ge,{label:"Roll (degrees)",name:"roll_deg",value:R,onChange:Ge,placeholder:"e.g., 0.0",step:"any"}),e.jsx("div",{className:g.rtkFixContainer,children:e.jsxs("label",{className:g.rtkFixLabel,children:[e.jsx("input",{type:"checkbox",checked:re,onChange:me=>Xe(me.target.checked),className:g.rtkFixCheckbox}),"RTK Fix Available"]})}),e.jsx(ge,{label:"Horizontal Std Dev (m)",name:"std_h_m",value:ye,onChange:Te,placeholder:"e.g., 0.1",step:"any"}),e.jsx(ge,{label:"Vertical Std Dev (m)",name:"std_v_m",value:he,onChange:ra,placeholder:"e.g., 0.2",step:"any"})]})]})})]})}function Ci({isPerformanceConfirmed:r,scores:i,onScoreChange:v,onConfirmRatings:h,onEditRatings:b}){return r?null:e.jsx(J,{heading:"AI Performance Rating",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsxs("div",{className:g.ratingContent,children:[e.jsx("p",{className:g.ratingDescription,children:"How well did the AI perform on the task?"}),["accuracy","context","usability"].map(f=>e.jsxs("div",{className:g.ratingSlider,children:[e.jsx("label",{className:g.ratingLabel,children:f}),e.jsx("input",{type:"range",min:0,max:100,value:i[f],onChange:o=>v(f,Number(o.target.value)),className:g.ratingInput}),e.jsx("span",{className:g.ratingValue,children:i[f]})]},f)),e.jsx("div",{className:g.confirmButtonContainer,children:e.jsx(_,{name:"confirm-ratings",variant:"secondary",onClick:h,children:"Confirm Ratings"})})]})})}function bi({description:r,analysis:i,recommendedActions:v,onDescriptionChange:h,onAnalysisChange:b,onRecommendedActionsChange:f,onBack:o,onDelete:M,onSubmit:G,onEditRatings:w,isPerformanceConfirmed:N=!1}){const D=se=>{if(se){const q=se.split(`
`),R=q.findIndex(he=>he.startsWith("Description:")),re=q.findIndex(he=>he.startsWith("Analysis:")),ye=q.findIndex(he=>he.startsWith("Recommended Actions:"));R!==-1&&re!==-1&&ye!==-1&&(h(q.slice(R+1,re).join(`
`).trim()),b(q.slice(re+1,ye).join(`
`).trim()),f(q.slice(ye+1).join(`
`).trim()))}};return e.jsxs(J,{heading:"Generated Text",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:[e.jsx("div",{className:"text-left space-y-4",children:e.jsx("div",{children:e.jsx(vs,{name:"generatedContent",value:`Description:
${r||"AI-generated description will appear here..."}

Analysis:
${i||"AI-generated analysis will appear here..."}

Recommended Actions:
${v||"AI-generated recommended actions will appear here..."}`,onChange:D,rows:12,placeholder:"AI-generated content will appear here..."})})}),e.jsxs("div",{className:g.submitSection,children:[e.jsx(_,{name:"back",variant:"secondary",onClick:o,children:"Back"}),N&&w&&e.jsx(_,{name:"edit-ratings",variant:"secondary",onClick:w,children:"Edit Ratings"}),e.jsx(ot,{name:"delete",variant:"tertiary",onClick:M,title:"Delete",ariaLabel:"Delete uploaded image",children:e.jsx(Ra,{})}),e.jsx(_,{name:"submit",onClick:G,children:"Submit"})]})]})}function Lt({isOpen:r,imageUrl:i,preview:v,selectedImageData:h,onClose:b}){if(!r)return null;let f,o;return h?(f=URL.createObjectURL(h.file),o=`Image ${h.index+1}: ${h.file.name}`):(f=i||v||void 0,o="Full size map"),e.jsx("div",{className:g.fullSizeModalOverlay,onClick:b,children:e.jsxs("div",{className:g.fullSizeModalContent,onClick:M=>M.stopPropagation(),children:[e.jsx("div",{className:g.fullSizeModalHeader,children:e.jsx(_,{name:"close-modal",variant:"tertiary",size:1,onClick:b,children:"✕"})}),e.jsx("div",{className:g.fullSizeModalImage,children:e.jsx("img",{src:f,alt:o})})]})})}function wi({isOpen:r,onClose:i}){return r?e.jsx("div",{className:g.fullSizeModalOverlay,onClick:i,children:e.jsx("div",{className:g.fullSizeModalContent,onClick:v=>v.stopPropagation(),children:e.jsxs("div",{className:g.ratingWarningContent,children:[e.jsx("h3",{className:g.ratingWarningTitle,children:"Please Confirm Your Ratings"}),e.jsx("p",{className:g.ratingWarningText,children:'You must confirm your performance ratings before submitting. Please go back to the rating section and click "Confirm Ratings".'}),e.jsx("div",{className:g.ratingWarningButtons,children:e.jsx(_,{name:"close-warning",variant:"secondary",onClick:i,children:"Close"})})]})})}):null}function Ni({isOpen:r,onConfirm:i,onCancel:v}){return r?e.jsx("div",{className:g.fullSizeModalOverlay,onClick:v,children:e.jsx("div",{className:g.fullSizeModalContent,onClick:h=>h.stopPropagation(),children:e.jsxs("div",{className:g.ratingWarningContent,children:[e.jsx("h3",{className:g.ratingWarningTitle,children:"Delete Image?"}),e.jsx("p",{className:g.ratingWarningText,children:"This action cannot be undone. Are you sure you want to delete this uploaded image?"}),e.jsxs("div",{className:g.ratingWarningButtons,children:[e.jsx(_,{name:"confirm-delete",variant:"secondary",onClick:i,children:"Delete"}),e.jsx(_,{name:"cancel-delete",variant:"tertiary",onClick:v,children:"Cancel"})]})]})})}):null}function Si({isOpen:r,onConfirm:i,onCancel:v}){return r?e.jsx("div",{className:g.fullSizeModalOverlay,onClick:v,children:e.jsx("div",{className:g.fullSizeModalContent,onClick:h=>h.stopPropagation(),children:e.jsxs("div",{className:g.ratingWarningContent,children:[e.jsx("h3",{className:g.ratingWarningTitle,children:"Leave Page?"}),e.jsx("p",{className:g.ratingWarningText,children:"Your uploaded image will be deleted if you leave this page. Are you sure you want to continue?"}),e.jsxs("div",{className:g.ratingWarningButtons,children:[e.jsx(_,{name:"confirm-navigation",variant:"secondary",onClick:i,children:"Leave Page"}),e.jsx(_,{name:"cancel-navigation",variant:"tertiary",onClick:v,children:"Stay"})]})]})})}):null}function Ii({isOpen:r,fallbackInfo:i,onClose:v}){return!r||!i?null:e.jsx("div",{className:g.fullSizeModalOverlay,onClick:v,children:e.jsx("div",{className:g.fullSizeModalContent,onClick:h=>h.stopPropagation(),children:e.jsxs("div",{className:g.ratingWarningContent,children:[e.jsx("h3",{className:g.ratingWarningTitle,children:"Model Changed"}),e.jsxs("p",{className:g.ratingWarningText,children:[i.originalModel," is currently unavailable. We've automatically switched to ",i.fallbackModel," to complete your request."]}),e.jsx("div",{className:g.ratingWarningButtons,children:e.jsx(_,{name:"close-fallback",variant:"secondary",onClick:v,children:"Got it"})})]})})})}function Mi({isOpen:r,preprocessingInfo:i,onClose:v}){return!r||!i?null:e.jsx("div",{className:g.fullSizeModalOverlay,onClick:v,children:e.jsx("div",{className:g.fullSizeModalContent,onClick:h=>h.stopPropagation(),children:e.jsxs("div",{className:g.ratingWarningContent,children:[e.jsx("h3",{className:g.ratingWarningTitle,children:"File Converted"}),e.jsxs("p",{className:g.ratingWarningText,children:["Your file ",e.jsx("strong",{children:i.original_filename})," has been converted from",e.jsxs("strong",{children:[" ",i.original_mime_type]})," to",e.jsxs("strong",{children:[" ",i.processed_mime_type]})," for optimal processing.",e.jsx("br",{}),e.jsx("br",{}),"This conversion ensures your file is in the best format for our AI models to analyze."]}),e.jsx("div",{className:g.ratingWarningButtons,children:e.jsx(_,{name:"close-preprocessing",variant:"secondary",onClick:v,children:"Got it"})})]})})})}function ki({isOpen:r,preprocessingFile:i,isPreprocessing:v,preprocessingProgress:h,onConfirm:b,onCancel:f}){return r?e.jsx("div",{className:g.fullSizeModalOverlay,onClick:v?void 0:f,children:e.jsx("div",{className:g.fullSizeModalContent,onClick:o=>o.stopPropagation(),children:e.jsxs("div",{className:g.ratingWarningContent,children:[e.jsx("h3",{className:g.ratingWarningTitle,children:"File Conversion Required"}),e.jsx("p",{className:g.ratingWarningText,children:"The file you selected will be converted to PNG format. This ensures optimal compatibility and processing by our AI models."}),!v&&e.jsxs("div",{className:g.ratingWarningButtons,children:[e.jsx(_,{name:"confirm-preprocessing",variant:"secondary",onClick:b,children:"Convert File"}),e.jsx(_,{name:"cancel-preprocessing",variant:"tertiary",onClick:f,children:"Cancel"})]}),v&&e.jsxs("div",{className:g.preprocessingProgress,children:[e.jsx("p",{children:h}),e.jsx(ja,{className:"text-ifrcRed"})]})]})})}):null}function Ti({isOpen:r,unsupportedFile:i,onClose:v}){return!r||!i?null:e.jsx("div",{className:g.fullSizeModalOverlay,onClick:v,children:e.jsx("div",{className:g.fullSizeModalContent,onClick:h=>h.stopPropagation(),children:e.jsxs("div",{className:g.ratingWarningContent,children:[e.jsx("h3",{className:g.ratingWarningTitle,children:"Unsupported File Format"}),e.jsxs("p",{className:g.ratingWarningText,children:["The file ",e.jsx("strong",{children:i.name})," is not supported for upload.",e.jsx("br",{}),e.jsx("br",{}),e.jsx("strong",{children:"Supported formats:"}),e.jsx("br",{}),"• Images: JPEG, PNG, TIFF, HEIC, WebP, GIF",e.jsx("br",{}),"• Documents: PDF (will be converted to image)",e.jsx("br",{}),e.jsx("br",{}),e.jsx("strong",{children:"Recommendation:"})," Convert your file to JPEG or PNG format for best compatibility."]}),e.jsx("div",{className:g.ratingWarningButtons,children:e.jsx(_,{name:"close-unsupported",variant:"secondary",onClick:v,children:"Got it"})})]})})})}function Di({isOpen:r,oversizedFile:i,onClose:v,onCancel:h}){return!r||!i?null:e.jsx("div",{className:g.lightModalOverlay,onClick:h,children:e.jsx("div",{className:g.fullSizeModalContent,onClick:b=>b.stopPropagation(),children:e.jsxs("div",{className:g.ratingWarningContent,children:[e.jsx("h3",{className:g.ratingWarningTitle,children:"File Size Warning"}),e.jsxs("p",{className:g.ratingWarningText,children:["The file ",e.jsx("strong",{children:i.name})," is large (",(i.size/(1024*1024)).toFixed(1),"MB).",e.jsx("br",{}),e.jsx("br",{}),e.jsx("strong",{children:"Warning:"})," This file size might exceed the limits of the AI models we use.",e.jsx("br",{}),e.jsx("br",{}),"You can still proceed, but consider using a smaller file if you encounter issues."]}),e.jsxs("div",{className:g.ratingWarningButtons,children:[e.jsx(_,{name:"continue-size-warning",variant:"secondary",onClick:v,children:"Continue"}),e.jsx(_,{name:"cancel-size-warning",variant:"tertiary",onClick:h,children:"Cancel"})]})]})})})}const Ha="selectedVlmModel";function bt(){const[r]=kt(),i=Aa(),[v,h]=s.useState(1),[b,f]=s.useState(!1),[o,M]=s.useState(!1),G=s.useRef(v),w=s.useRef(null),[N,D]=s.useState(null),[se,q]=s.useState(null),[R,re]=s.useState([]),[ye,he]=s.useState(""),[de,je]=s.useState(""),[Ye,be]=s.useState(""),[we,ee]=s.useState("crisis_map"),[Ne,I]=s.useState([]),[pe,ne]=s.useState(""),[la,He]=s.useState(""),[ma,Ve]=s.useState(""),[ea,Ee]=s.useState(""),[Y,xe]=s.useState(""),[Ge,Xe]=s.useState(""),[Te,ra]=s.useState(""),[Qe,ue]=s.useState(""),[me,$]=s.useState(""),[T,Ca]=s.useState(!1),[ba,na]=s.useState(""),[d,z]=s.useState(""),[K,Se]=s.useState([]),[Re,ia]=s.useState([]),[Ie,aa]=s.useState([]),[$e,Le]=s.useState([]),[ae,oa]=s.useState([]),[O,A]=s.useState([]),[X,ua]=s.useState(null),[Ce,Ze]=s.useState([]),[P,t]=s.useState(null),[a,m]=s.useState(""),[l,c]=s.useState(""),[u,y]=s.useState(""),[ie,Ae]=s.useState(""),[Oe,C]=s.useState({accuracy:50,context:50,usability:50}),[Fe,Be]=s.useState(!1),[ha,pa]=s.useState(null),[_a,Na]=s.useState(!1),[Ya,Ma]=s.useState(!1),[Oa,Ta]=s.useState(!1),[Qa,ka]=s.useState(!1),[ce,Da]=s.useState(null),[Za,ca]=s.useState(!1),[Ka,p]=s.useState(null),[B,oe]=s.useState(!1),[S,U]=s.useState(null),[F,E]=s.useState(!1),[H,L]=s.useState(null),[De,ze]=s.useState(!1),[Je,Q]=s.useState(""),[Ue,_e]=s.useState(!1),[qe,wa]=s.useState(null),[va,Sa]=s.useState(!1),[$t,Xa]=s.useState(null),[Rt,Ba]=s.useState(0);G.current=v,w.current=X;const At=n=>he(n||""),Ot=n=>je(n||""),Bt=n=>be(n||""),et=n=>ee(n||""),zt=n=>I(Array.isArray(n)?n:[]),Ut=n=>He(n||""),Wt=n=>Ve(n||""),Ht=n=>Ee(n||""),Vt=n=>xe(n||""),Gt=n=>Xe(n||""),Jt=n=>ra(n||""),qt=n=>ue(n||""),Yt=n=>$(n||""),Qt=n=>Ca(n||!1),Zt=n=>na(n||""),Kt=n=>z(n||""),za=n=>h(n),Xt=s.useCallback(()=>{R.length>1&&Ba(n=>n>0?n-1:R.length-1)},[R.length]),es=s.useCallback(()=>{R.length>1&&Ba(n=>n<R.length-1?n+1:0)},[R.length]),as=s.useCallback(n=>{n>=0&&n<R.length&&Ba(n)},[R.length]),rt=()=>{if(R.length<5){const n=document.createElement("input");n.type="file",n.accept=".jpg,.jpeg,.png,.tiff,.tif,.heic,.heif,.webp,.gif,.pdf",n.onchange=Z=>{const W=Z.target;if(W.files&&W.files[0]){const V=W.files[0];at(V)}},n.click()}},ct=n=>{re(Z=>{const W=Z.filter((V,k)=>k!==n);return W.length===1?q(W[0]):W.length===0&&q(null),W}),Se(Z=>Z.filter((W,V)=>V!==n))},ts=(n,Z,W)=>{Se(V=>{const k=[...V];return k[n]||(k[n]={source:"",eventType:"",epsg:"",countries:[],centerLon:"",centerLat:"",amslM:"",aglM:"",headingDeg:"",yawDeg:"",pitchDeg:"",rollDeg:"",rtkFix:!1,stdHM:"",stdVM:""}),k[n]={...k[n],[Z]:W},k})},dt=n=>{const Z=["image/jpeg","image/jpg","image/png"],W=[".jpg",".jpeg",".png"];let V=!Z.includes(n.type);if(!V&&n.name){const k=n.name.toLowerCase().substring(n.name.lastIndexOf("."));V=!W.includes(k)}return V},mt=n=>{const Z=["text/html","text/css","application/javascript","application/json","text/plain","application/xml","text/xml","application/zip","application/x-zip-compressed","application/x-rar-compressed","application/x-7z-compressed","audio/","video/","text/csv","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"];for(const W of Z)if(n.type.startsWith(W))return!0;if(n.name){const W=n.name.toLowerCase().substring(n.name.lastIndexOf("."));if([".html",".htm",".css",".js",".json",".txt",".xml",".zip",".rar",".7z",".csv",".xlsx",".xls",".pptx",".ppt",".docx",".doc",".mp3",".mp4",".avi",".mov"].includes(W))return!0}return!1},at=n=>{if(n){if(console.log("File selected:",n.name,"Type:",n.type,"Size:",n.size),n.size/(1024*1024)>5&&(console.log("File too large, showing size warning modal"),Xa(n),Sa(!0)),mt(n)){console.log("File format not supported at all, showing unsupported format modal"),wa(n),_e(!0);return}dt(n)?(console.log("File needs preprocessing, showing modal"),L(n),E(!0)):(console.log("File does not need preprocessing, setting directly"),R.length===0?(q(n),re([n])):re(W=>[...W,n]))}},ut=n=>{if(n){if(console.log("File changed:",n.name,"Type:",n.type,"Size:",n.size),n.size/(1024*1024)>5&&(console.log("File too large, showing size warning modal"),Xa(n),Sa(!0)),mt(n)){console.log("File format not supported at all, showing unsupported format modal"),wa(n),_e(!0);return}dt(n)?(console.log("File needs preprocessing, showing modal"),L(n),E(!0)):(console.log("File does not need preprocessing, replacing last file"),R.length>1?(re(W=>{const V=[...W];return V[V.length-1]=n,V}),R.length===1&&q(n)):(q(n),re([n])))}};async function Pa(n){const Z=await n.text();try{return Z?JSON.parse(Z):{}}catch{return{error:Z}}}function tt(n,Z){const W=n instanceof Error?n.message:`Failed to ${Z.toLowerCase()}`;alert(W)}async function gt(){if(R.length!==0){f(!0);try{R.length===1?await ss():await ns()}catch(n){tt(n,"Upload")}finally{f(!1)}}}async function ss(){console.log("DEBUG: Starting single image upload");const n=new FormData;n.append("file",R[0]),n.append("title",pe),n.append("image_type",we),ye&&n.append("source",ye),de&&n.append("event_type",de),Ye&&n.append("epsg",Ye),Ne.length>0&&Ne.forEach(k=>n.append("countries",k)),we==="drone_image"&&(la&&n.append("center_lon",la),ma&&n.append("center_lat",ma),ea&&n.append("amsl_m",ea),Y&&n.append("agl_m",Y),Ge&&n.append("heading_deg",Ge),Te&&n.append("yaw_deg",Te),Qe&&n.append("pitch_deg",Qe),me&&n.append("roll_deg",me),T&&n.append("rtk_fix",T.toString()),ba&&n.append("std_h_m",ba),d&&n.append("std_v_m",d));const Z=localStorage.getItem(Ha);Z&&n.append("model_name",Z);const W=await fetch("/api/images/",{method:"POST",body:n}),V=await Pa(W);if(!W.ok)throw new Error(V.error||"Upload failed");console.log("DEBUG: Single upload response:",V),await ht(V,!1)}async function ns(){console.log("DEBUG: Starting multi-image upload");const n=new FormData;R.forEach(k=>n.append("files",k)),n.append("title",pe),n.append("image_type",we),K.forEach((k,te)=>{k.source&&n.append(`source_${te}`,k.source),k.eventType&&n.append(`event_type_${te}`,k.eventType),k.epsg&&n.append(`epsg_${te}`,k.epsg),k.countries.length>0&&k.countries.forEach(We=>n.append(`countries_${te}`,We)),we==="drone_image"&&(k.centerLon&&n.append(`center_lon_${te}`,k.centerLon),k.centerLat&&n.append(`center_lat_${te}`,k.centerLat),k.amslM&&n.append(`amsl_m_${te}`,k.amslM),k.aglM&&n.append(`agl_m_${te}`,k.aglM),k.headingDeg&&n.append(`heading_deg_${te}`,k.headingDeg),k.yawDeg&&n.append(`yaw_deg_${te}`,k.yawDeg),k.pitchDeg&&n.append(`pitch_deg_${te}`,k.pitchDeg),k.rollDeg&&n.append(`roll_deg_${te}`,k.rollDeg),k.rtkFix&&n.append(`rtk_fix_${te}`,k.rtkFix.toString()),k.stdHM&&n.append(`std_h_m_${te}`,k.stdHM),k.stdVM&&n.append(`std_v_m_${te}`,k.stdVM))});const Z=localStorage.getItem(Ha);Z&&n.append("model_name",Z);const W=await fetch("/api/images/multi",{method:"POST",body:n}),V=await Pa(W);if(!W.ok)throw new Error(V.error||"Upload failed");console.log("DEBUG: Multi upload response:",V),await ht(V,!0)}async function ht(n,Z){t(n.image_url),n.preprocessing_info&&typeof n.preprocessing_info=="object"&&"was_preprocessed"in n.preprocessing_info&&n.preprocessing_info.was_preprocessed===!0&&(U(n.preprocessing_info),oe(!0));const W=n.image_id;if(!W)throw new Error("Upload failed: image_id not found");if(ua(W),Z)if(n.image_ids&&Array.isArray(n.image_ids)){const fe=n.image_ids;console.log("DEBUG: Storing image IDs for multi-upload:",fe),Ze(fe)}else console.log("DEBUG: Multi-upload but no image_ids found, using single ID"),Ze([W]);else console.log("DEBUG: Storing single image ID:",W),Ze([W]);const V=n,k=V.raw_json?.fallback_info;k&&(p({originalModel:k.original_model,fallbackModel:k.fallback_model,reason:k.reason}),ca(!0));const te=V.raw_json?.metadata;if(te){const fe=te.metadata||te;if(fe&&typeof fe=="object"){const fa=[];if(Z){const Me=fe.metadata_images;if(Me&&typeof Me=="object")for(let ya=1;ya<=R.length;ya++){const La=`image${ya}`,st=Me[La];if(st&&typeof st=="object"){const Fa=st;fa.push({source:Fa.source||"",eventType:Fa.type||"",epsg:Fa.epsg||"",countries:Array.isArray(Fa.countries)?Fa.countries:[],centerLon:"",centerLat:"",amslM:"",aglM:"",headingDeg:"",yawDeg:"",pitchDeg:"",rollDeg:"",rtkFix:!1,stdHM:"",stdVM:""})}else fa.push({source:"",eventType:"",epsg:"",countries:[],centerLon:"",centerLat:"",amslM:"",aglM:"",headingDeg:"",yawDeg:"",pitchDeg:"",rollDeg:"",rtkFix:!1,stdHM:"",stdVM:""})}else{const ya={source:fe.source||"",eventType:fe.type||"",epsg:fe.epsg||"",countries:Array.isArray(fe.countries)?fe.countries:[],centerLon:"",centerLat:"",amslM:"",aglM:"",headingDeg:"",yawDeg:"",pitchDeg:"",rollDeg:"",rtkFix:!1,stdHM:"",stdVM:""};for(let La=0;La<R.length;La++)fa.push({...ya})}}else{const Me={source:fe.source||"",eventType:fe.type||"",epsg:fe.epsg||"",countries:Array.isArray(fe.countries)?fe.countries:[],centerLon:"",centerLat:"",amslM:"",aglM:"",headingDeg:"",yawDeg:"",pitchDeg:"",rollDeg:"",rtkFix:!1,stdHM:"",stdVM:""};fa.push(Me)}if(Se(fa),fa.length>0){const Me=fa[0];if(fe&&typeof fe=="object"){const ya=fe.title;ya&&ne(ya||"")}he(Me.source||""),je(Me.eventType||""),be(Me.epsg||""),I(Me.countries||[]),we==="drone_image"&&(He(Me.centerLon||""),Ve(Me.centerLat||""),Ee(Me.amslM||""),xe(Me.aglM||""),Xe(Me.headingDeg||""),ra(Me.yawDeg||""),ue(Me.pitchDeg||""),$(Me.rollDeg||""),Ca(Me.rtkFix||!1),na(Me.stdHM||""),z(Me.stdVM||""))}}}const We=V.raw_json?.metadata;We&&(We.description&&c(We.description),We.analysis&&y(We.analysis),We.recommended_actions&&Ae(We.recommended_actions)),V.generated&&m(V.generated),za("2a")}async function is(){if(console.log("handleSubmit called with:",{uploadedImageId:X,title:pe,draft:a}),!X)return alert("No image to submit");if(!_a){Ma(!0);return}try{const n=Ce.length>0?Ce:[X];console.log("DEBUG: Submit - Using image IDs:",n),console.log("DEBUG: Submit - uploadedImageIds:",Ce),console.log("DEBUG: Submit - uploadedImageId:",X);for(let te=0;te<n.length;te++){const We=n[te],fe=K[te]||{source:ye||"OTHER",eventType:de||"OTHER",epsg:Ye||"OTHER",countries:Ne||[]},fa={source:we==="drone_image"?void 0:fe.source||"OTHER",event_type:fe.eventType||"OTHER",epsg:fe.epsg||"OTHER",image_type:we,countries:fe.countries||[]};console.log(`Updating metadata for image ${te+1}:`,fa);const Me=await fetch(`/api/images/${We}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(fa)}),ya=await Pa(Me);if(!Me.ok)throw new Error(ya.error||`Metadata update failed for image ${te+1}`)}const Z=`Description: ${l}

Analysis: ${u}

Recommended Actions: ${ie}`,W={title:pe,edited:Z,accuracy:Oe.accuracy,context:Oe.context,usability:Oe.usability};console.log("Updating caption:",W);const V=await fetch(`/api/images/${X}/caption`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(W)}),k=await Pa(V);if(!V.ok)throw new Error(k.error||"Caption update failed");ua(null),Ze([]),za(3)}catch(n){tt(n,"Submit")}}async function pt(){if(console.log("handleDelete called with uploadedImageId:",X),!X){alert("No image to delete. Please try refreshing the page.");return}Ta(!0)}async function os(){try{console.log("Deleting image with ID:",X);const n=await fetch(`/api/images/${X}`,{method:"DELETE"});if(!n.ok){const Z=await Pa(n);throw new Error(Z.error||`Delete failed with status ${n.status}`)}Ta(!1),ft()}catch(n){tt(n,"Delete")}}const ft=()=>{Na(!1),h(1),q(null),re([]),D(null),ua(null),Ze([]),t(null),ne(""),he(""),je(""),be(""),I([]),He(""),Ve(""),Ee(""),xe(""),Xe(""),ra(""),ue(""),$(""),Ca(!1),na(""),z(""),C({accuracy:50,context:50,usability:50}),m(""),c(""),y(""),Ae(""),Se([]),ca(!1),p(null),oe(!1),U(null),E(!1),L(null),ze(!1),Q(""),_e(!1),wa(null),Sa(!1),Xa(null),i("/upload",{replace:!0})},Ua=s.useCallback(n=>{n==="/upload"||n==="/"||(w.current?(Da(n),ka(!0)):i(n))},[i]);async function ls(){if(ce&&w.current)try{await fetch(`/api/images/${w.current}`,{method:"DELETE"}),ka(!1),Da(null),i(ce)}catch(n){console.error("Failed to delete image before navigation:",n),ka(!1),Da(null),i(ce)}}const rs=async()=>{if(H){ze(!0),Q("Starting file conversion...");try{const n=new FormData;n.append("file",H),n.append("preprocess_only","true"),Q("Converting file format...");const Z=await fetch("/api/images/preprocess",{method:"POST",body:n});if(!Z.ok)throw new Error("Preprocessing failed");const W=await Z.json();Q("Finalizing conversion...");const V=atob(W.processed_content),k=new Uint8Array(V.length);for(let fe=0;fe<V.length;fe++)k[fe]=V.charCodeAt(fe);const te=new File([k],W.processed_filename,{type:W.processed_mime_type}),We=URL.createObjectURL(te);R.length===0?(q(te),re([te])):re(fe=>[...fe,te]),D(We),Q("Conversion complete!"),setTimeout(()=>{E(!1),L(null),ze(!1),Q("")},1e3)}catch(n){console.error("Preprocessing error:",n),Q("Conversion failed. Please try again."),setTimeout(()=>{E(!1),L(null),ze(!1),Q("")},2e3)}}},cs=()=>{E(!1),L(null),ze(!1),Q("")},ds=async n=>{M(!0);try{const Z=n.map(async te=>{const We=await fetch(`/api/images/${te}`);if(!We.ok)throw new Error(`Failed to fetch image ${te}`);const fe=await We.json(),fa=await fetch(`/api/images/${te}/file`);if(!fa.ok)throw new Error(`Failed to fetch image file ${te}`);const Me=await fa.blob(),ya=fe.file_key.split("/").pop()||`contributed_${te}.png`;return{file:new File([Me],ya,{type:Me.type}),imageData:fe}}),W=await Promise.all(Z),V=W.map(te=>te.file),k=W[0]?.imageData;re(V),Ze(n),n.length===1&&ua(n[0]),V.length>=1&&q(V[0]),k?.image_type&&ee(k.image_type)}catch(Z){console.error("Failed to fetch contributed images:",Z),alert(`Failed to load contributed images: ${Z instanceof Error?Z.message:"Unknown error"}`)}finally{M(!1)}};return s.useEffect(()=>{Promise.all([fetch("/api/sources").then(n=>n.json()),fetch("/api/types").then(n=>n.json()),fetch("/api/spatial-references").then(n=>n.json()),fetch("/api/image-types").then(n=>n.json()),fetch("/api/countries").then(n=>n.json()),fetch("/api/models").then(n=>n.json())]).then(([n,Z,W,V,k,te])=>{!localStorage.getItem(Ha)&&te?.length&&localStorage.setItem(Ha,te[0].m_code),ia(n),aa(Z),Le(W),oa(V),A(k),n.length>0&&he(n[0].s_code),je("OTHER"),be("OTHER"),V.length>0&&!r.get("imageType")&&!we&&ee(V[0].image_type)})},[r,we]),s.useEffect(()=>(window.confirmNavigationIfNeeded=n=>{Ua(n)},()=>{delete window.confirmNavigationIfNeeded}),[Ua]),s.useEffect(()=>{const n=V=>{if(w.current){const k="You have an uploaded image that will be deleted if you leave this page. Are you sure you want to leave?";return V.preventDefault(),V.returnValue=k,k}},Z=()=>{w.current&&fetch(`/api/images/${w.current}`,{method:"DELETE"}).catch(console.error)},W=V=>{const k=V.target,te=k.closest("a[href]")||k.closest("[data-navigate]");if(te&&w.current){const We=te.getAttribute("href")||te.getAttribute("data-navigate");We&&We!=="#"&&!We.startsWith("javascript:")&&!We.startsWith("mailto:")&&(V.preventDefault(),V.stopPropagation(),Ua(We))}};return window.addEventListener("beforeunload",n),document.addEventListener("click",W,!0),()=>{window.removeEventListener("beforeunload",n),document.removeEventListener("click",W,!0),Z()}},[Ua]),s.useEffect(()=>{if(!se){D(null);return}const n=URL.createObjectURL(se);return D(n),()=>URL.revokeObjectURL(n)},[se]),s.useEffect(()=>{const n=r.get("contribute"),Z=r.get("imageIds");if(n==="true"&&Z){const W=Z.split(",").filter(V=>V.trim());W.length>0&&ds(W)}},[r]),s.useEffect(()=>{v==="2b"&&Ba(0)},[v]),e.jsxs(ga,{children:[v!==3&&e.jsx("div",{className:"max-w-7xl mx-auto",children:e.jsxs("div",{className:g.uploadContainer,"data-step":v,children:[v===1&&!r.get("step")&&!o&&e.jsx(jt,{files:R,file:se,preview:N,imageType:we,onFileChange:at,onRemoveImage:ct,onAddImage:rt,onImageTypeChange:et,onChangeFile:ut}),v===1&&r.get("contribute")==="true"&&!o&&R.length>0&&e.jsx(jt,{files:R,file:se,preview:N,imageType:we,onFileChange:at,onRemoveImage:ct,onAddImage:rt,onImageTypeChange:et,onChangeFile:ut}),b&&e.jsxs("div",{className:g.loadingContainer,children:[e.jsx(ja,{className:"text-ifrcRed"}),e.jsx("p",{className:g.loadingText,children:"Generating..."})]}),o&&e.jsxs("div",{className:g.loadingContainer,children:[e.jsx(ja,{className:"text-ifrcRed"}),e.jsx("p",{className:g.loadingText,children:"Loading contribution..."})]}),(v===1&&!b&&!o||v===1&&r.get("contribute")==="true"&&!b&&!o&&R.length>0)&&e.jsx("div",{className:g.generateButtonContainer,children:P?e.jsx(_,{name:"generate-from-url",onClick:gt,children:"Generate Caption"}):e.jsx(_,{name:"generate",disabled:R.length===0,onClick:gt,children:"Generate"})}),v==="2a"&&e.jsxs("div",{className:g.step2Layout,children:[e.jsx("div",{className:g.mapColumn,children:e.jsx(Ct,{files:R,imageUrl:P,preview:N,onViewFullSize:n=>{pa(n||null),Be(!0)}})}),e.jsx("div",{className:g.contentColumn,children:e.jsxs("div",{className:g.metadataSectionCard,children:[e.jsx(ji,{files:R,imageType:we,title:pe,source:ye,eventType:de,epsg:Ye,countries:Ne,centerLon:la,centerLat:ma,amslM:ea,aglM:Y,headingDeg:Ge,yawDeg:Te,pitchDeg:Qe,rollDeg:me,rtkFix:T,stdHM:ba,stdVM:d,metadataArray:K,sources:Re,types:Ie,spatialReferences:$e,imageTypes:ae,countriesOptions:O,onTitleChange:n=>ne(n||""),onSourceChange:At,onEventTypeChange:Ot,onEpsgChange:Bt,onCountriesChange:zt,onCenterLonChange:Ut,onCenterLatChange:Wt,onAmslMChange:Ht,onAglMChange:Vt,onHeadingDegChange:Gt,onYawDegChange:Jt,onPitchDegChange:qt,onRollDegChange:Yt,onRtkFixChange:Qt,onStdHMChange:Zt,onStdVMChange:Kt,onImageTypeChange:et,updateMetadataForImage:ts}),e.jsxs("div",{className:g.confirmSection,children:[e.jsx(ot,{name:"delete",variant:"tertiary",onClick:pt,title:"Delete",ariaLabel:"Delete uploaded image",children:e.jsx(Ra,{})}),e.jsx(_,{name:"confirm-metadata",onClick:()=>za("2b"),children:"Next"})]})]})})]}),v==="2b"&&e.jsxs("div",{className:g.step2bLayout,children:[e.jsxs("div",{className:`${g.topRow} ${_a?g.ratingHidden:""}`,children:[e.jsx("div",{className:g.imageSection,children:e.jsx(Ct,{files:R,imageUrl:P,preview:N,onViewFullSize:n=>{pa(n||null),Be(!0)},currentImageIndex:Rt,onGoToPrevious:Xt,onGoToNext:es,onGoToImage:as,showCarousel:!0})}),!_a&&e.jsx("div",{className:g.metadataSectionCard,children:e.jsx(Ci,{isPerformanceConfirmed:_a,scores:Oe,onScoreChange:(n,Z)=>C(W=>({...W,[n]:Z})),onConfirmRatings:()=>Na(!0),onEditRatings:()=>Na(!1)})})]}),e.jsx("div",{className:g.metadataSectionCard,children:e.jsx(bi,{description:l,analysis:u,recommendedActions:ie,onDescriptionChange:n=>c(n||""),onAnalysisChange:n=>y(n||""),onRecommendedActionsChange:n=>Ae(n||""),onBack:()=>za("2a"),onDelete:pt,onSubmit:is,onEditRatings:()=>Na(!1),isPerformanceConfirmed:_a})})]})]})}),v===3&&e.jsxs("div",{className:g.successContainer,children:[e.jsx(Ia,{level:2,className:g.successHeading,children:"Saved!"}),e.jsx("p",{className:g.successText,children:r.get("contribute")==="true"?"Your contribution has been successfully saved.":"Your caption has been successfully saved."}),e.jsx("div",{className:g.successButton,children:e.jsx(_,{name:"upload-another",onClick:()=>{ft()},children:"Upload Another"})})]}),e.jsx(Lt,{isOpen:Fe,imageUrl:P,preview:N,selectedImageData:ha,onClose:()=>{Be(!1),pa(null)}}),e.jsx(wi,{isOpen:Ya,onClose:()=>Ma(!1)}),e.jsx(Ni,{isOpen:Oa,onConfirm:os,onCancel:()=>Ta(!1)}),e.jsx(Si,{isOpen:Qa,onConfirm:ls,onCancel:()=>ka(!1)}),e.jsx(Ii,{isOpen:Za,fallbackInfo:Ka,onClose:()=>ca(!1)}),e.jsx(Mi,{isOpen:B,preprocessingInfo:S,onClose:()=>oe(!1)}),e.jsx(ki,{isOpen:F,preprocessingFile:H,isPreprocessing:De,preprocessingProgress:Je,onConfirm:rs,onCancel:cs}),e.jsx(Ti,{isOpen:Ue,unsupportedFile:qe,onClose:()=>_e(!1)}),e.jsx(Di,{isOpen:va,oversizedFile:$t,onClose:()=>Sa(!1),onCancel:()=>Sa(!1)})]})}const wt={};function xa(r,i,v,h){return{id:r,title:i,columnClassName:h?.columnClassName,headerCellRenderer:It,headerCellRendererClassName:h?.headerCellRendererClassName,headerContainerClassName:h?.headerContainerClassName,headerCellRendererParams:{sortable:h?.sortable,infoTitle:h?.headerInfoTitle,infoDescription:h?.headerInfoDescription},cellRendererClassName:h?.cellRendererClassName,cellContainerClassName:h?.cellContainerClassName,cellRenderer:js,cellRendererParams:(b,f)=>({value:v(f)||"--"}),valueSelector:v,valueComparator:(b,f)=>ys(v(b),v(f)),columnWidth:h?.columnWidth,columnStretch:h?.columnStretch,columnStyle:h?.columnStyle}}function Pe(r,i,v,h){return{id:r,title:i,columnClassName:h?.columnClassName,headerCellRenderer:It,headerCellRendererClassName:_t(wt.numberCellHeader,h?.headerCellRendererClassName),headerContainerClassName:h?.headerContainerClassName,headerCellRendererParams:{sortable:h?.sortable,infoTitle:h?.headerInfoTitle,infoDescription:h?.headerInfoDescription},cellRendererClassName:_t(wt.numberCell,h?.cellRendererClassName),cellContainerClassName:h?.cellContainerClassName,cellRenderer:bs,cellRendererParams:(b,f)=>({value:v(f),suffix:h?.suffix,maximumFractionDigits:h?.maximumFractionDigits,invalidText:"--"}),valueSelector:v,valueComparator:(b,f)=>Cs(v(b),v(f)),columnWidth:h?.columnWidth,columnStretch:h?.columnStretch,columnStyle:h?.columnStyle}}const Pi="_tabSelector_vlxoe_1",Li="_progressSection_vlxoe_14",Fi="_progressLabel_vlxoe_20",Ei="_chartGrid_vlxoe_28",$i="_chartContainer_vlxoe_40",Ri="_tableContainer_vlxoe_51",Ai="_modelPerformance_vlxoe_59",Oi="_loadingContainer_vlxoe_67",Bi="_errorContainer_vlxoe_77",zi="_userInteractionCards_vlxoe_96",Ui="_userInteractionCard_vlxoe_96",Wi="_userInteractionCardValue_vlxoe_116",Hi="_userInteractionCardLabel_vlxoe_123",Vi="_userInteractionCardButton_vlxoe_130",Gi="_summaryStatsCards_vlxoe_148",Ji="_summaryStatsCard_vlxoe_148",qi="_summaryStatsCardValue_vlxoe_169",Yi="_summaryStatsCardLabel_vlxoe_176",j={tabSelector:Pi,progressSection:Li,progressLabel:Fi,chartGrid:Ei,chartContainer:$i,tableContainer:Ri,modelPerformance:Ai,loadingContainer:Oi,errorContainer:Bi,userInteractionCards:zi,userInteractionCard:Ui,userInteractionCardValue:Wi,userInteractionCardLabel:Hi,userInteractionCardButton:Vi,summaryStatsCards:Gi,summaryStatsCard:Ji,summaryStatsCardValue:qi,summaryStatsCardLabel:Yi};function Qi(){const[r]=kt(),[i,v]=s.useState(null),[h,b]=s.useState(!0),[f,o]=s.useState("crisis_maps"),[M,G]=s.useState([]),[w,N]=s.useState([]),[D,se]=s.useState([]),[q,R]=s.useState([]),[re,ye]=s.useState(!1),[he,de]=s.useState(!1),[je,Ye]=s.useState(!1),[be,we]=s.useState(!1),[ee,Ne]=s.useState(!1),[I,pe]=s.useState(!1),ne=a=>{ye(a==="editTime"),de(a==="percentage"),Ye(a==="delete"),we(a==="regions"),Ne(a==="sources"),pe(a==="types")},la=[{key:"crisis_maps",label:"Crisis Maps"},{key:"drone_images",label:"Drone Images"}],He=s.useCallback((a,m)=>{if(!a||!m)return 0;const l=a.toLowerCase().replace(/[^\w\s]/g,"").split(/\s+/).filter(C=>C.length>0),c=m.toLowerCase().replace(/[^\w\s]/g,"").split(/\s+/).filter(C=>C.length>0);if(l.length===0&&c.length===0)return 1;if(l.length===0||c.length===0)return 0;const u=new Set(l),y=new Set(c),ie=new Set([...u].filter(C=>y.has(C))),Ae=new Set([...u,...y]);return ie.size/Ae.size},[]),ma=s.useCallback(async()=>{b(!0);try{const m=await(await fetch("/api/images")).json(),l={},c=m.filter(C=>C.image_type==="crisis_map"),u=m.filter(C=>C.image_type==="drone_image"),y={totalCaptions:m.length,sources:{},types:{},regions:{},models:{},modelEditTimes:l,percentageModified:0,modelPercentageData:{},totalDeleteCount:0,deleteRate:0,crisisMaps:c,droneImages:u};m.forEach(C=>{if(C.source&&(y.sources[C.source]=(y.sources[C.source]||0)+1),C.event_type&&(y.types[C.event_type]=(y.types[C.event_type]||0)+1),C.countries&&C.countries.forEach(Fe=>{Fe.r_code&&(y.regions[Fe.r_code]=(y.regions[Fe.r_code]||0)+1)}),C.model){const Fe=C.model,Be=y.models[Fe]||={count:0,avgAccuracy:0,avgContext:0,avgUsability:0,totalScore:0,deleteCount:0};if(Be.count++,C.accuracy!=null&&(Be.avgAccuracy+=C.accuracy),C.context!=null&&(Be.avgContext+=C.context),C.usability!=null&&(Be.avgUsability+=C.usability),C.created_at&&C.updated_at){const ha=new Date(C.created_at).getTime(),_a=new Date(C.updated_at).getTime()-ha;_a>0&&(l[Fe]||(l[Fe]=[]),l[Fe].push(_a))}}}),M.forEach(C=>{C.s_code&&!y.sources[C.s_code]&&(y.sources[C.s_code]=0)}),w.forEach(C=>{C.t_code&&!y.types[C.t_code]&&(y.types[C.t_code]=0)}),D.forEach(C=>{C.r_code&&!y.regions[C.r_code]&&(y.regions[C.r_code]=0)}),["GPT-4","Claude","Gemini","Llama","Other"].forEach(C=>{y.models[C]||(y.models[C]={count:0,avgAccuracy:0,avgContext:0,avgUsability:0,totalScore:0,deleteCount:0})}),Object.values(y.models).forEach(C=>{C.count>0&&(C.avgAccuracy=Math.round(C.avgAccuracy/C.count),C.avgContext=Math.round(C.avgContext/C.count),C.avgUsability=Math.round(C.avgUsability/C.count),C.totalScore=Math.round((C.avgAccuracy+C.avgContext+C.avgUsability)/3))});const Ae=m.filter(C=>C.generated&&C.edited);if(Ae.length>0){const Fe=[...Ae.map(pa=>He(pa.generated,pa.edited))].sort((pa,_a)=>pa-_a),Be=Math.floor(Fe.length/2),ha=Fe.length%2===0?(Fe[Be-1]+Fe[Be])/2:Fe[Be];y.percentageModified=Math.round((1-ha)*100)}const Oe={};m.forEach(C=>{if(C.model&&C.generated&&C.edited){const Fe=He(C.generated,C.edited),Be=Math.round((1-Fe)*100);Oe[C.model]||(Oe[C.model]=[]),Oe[C.model].push(Be)}}),y.modelPercentageData=Oe;try{const C=await fetch("/api/models");if(C.ok){const Fe=await C.json();if(Fe.models){Fe.models.forEach(ha=>{y.models[ha.m_code]&&(y.models[ha.m_code].deleteCount=ha.delete_count||0)});const Be=Fe.models.reduce((ha,pa)=>ha+(pa.delete_count||0),0);y.totalDeleteCount=Be,y.deleteRate=Be>0?Math.round(Be/(Be+m.length)*100):0}}}catch(C){console.log("Could not fetch model delete counts:",C)}v(y)}catch{v(null)}finally{b(!1)}},[M,w,D,He]),Ve=s.useCallback(async()=>{try{const[a,m,l,c]=await Promise.all([fetch("/api/sources"),fetch("/api/types"),fetch("/api/regions"),fetch("/api/models")]),u=await a.json(),y=await m.json(),ie=await l.json(),Ae=await c.json();G(u),N(y),se(ie),R(Ae.models||[])}catch(a){console.log("Could not fetch lookup data:",a)}},[]);s.useEffect(()=>{const a=r.get("view");(a==="crisis_maps"||a==="drone_images")&&o(a)},[r]),s.useEffect(()=>{Ve()},[Ve]),s.useEffect(()=>{M.length>0&&w.length>0&&D.length>0&&q.length>0&&ma()},[M,w,D,q,ma]);const ea=s.useCallback(a=>{const m=M.find(l=>l.s_code===a);return m?m.label:a},[M]),Ee=s.useCallback(a=>{if(a.length===0)return 0;const m=[...a].sort((c,u)=>c-u),l=Math.floor(m.length/2);return m.length%2===0?Math.round((m[l-1]+m[l])/2):m[l]},[]),Y=s.useCallback(a=>{const m=Math.floor(a/1e3),l=Math.floor(m/60),c=Math.floor(l/60);return c>0?`${c}h ${l%60}m`:l>0?`${l}m ${m%60}s`:`${m}s`},[]),xe=s.useCallback(a=>{const m=w.find(l=>l.t_code===a);return m?m.label:a},[w]),Ge=s.useCallback(a=>{const m=q.find(l=>l.m_code===a);return m?m.label:a},[q]),Xe=s.useMemo(()=>i?Object.entries(i.modelEditTimes||{}).filter(([,a])=>a.length>0).sort(([,a],[,m])=>Ee(m)-Ee(a)).map(([a,m],l)=>({id:l+1,name:Ge(a),count:m.length,avgEditTime:Ee(m),minEditTime:Math.min(...m),maxEditTime:Math.max(...m)})):[],[i,Ee,Ge]),Te=s.useMemo(()=>i?Object.entries(i.modelPercentageData||{}).filter(([,a])=>a.length>0).sort(([,a],[,m])=>{const l=[...a].sort((Oe,C)=>Oe-C),c=[...m].sort((Oe,C)=>Oe-C),u=Math.floor(l.length/2),y=Math.floor(c.length/2),ie=l.length%2===0?(l[u-1]+l[u])/2:l[u];return(c.length%2===0?(c[y-1]+c[y])/2:c[y])-ie}).map(([a,m],l)=>{const c=[...m].sort((ie,Ae)=>ie-Ae),u=Math.floor(c.length/2),y=c.length%2===0?Math.round((c[u-1]+c[u])/2):c[u];return{id:l+1,name:Ge(a),count:m.length,avgPercentageModified:y,minPercentageModified:Math.min(...m),maxPercentageModified:Math.max(...m)}}):[],[i,Ge]),ra=s.useMemo(()=>i?Object.entries(i.models).filter(([,a])=>a.count>0).map(([a,m],l)=>{const c=[m.avgAccuracy,m.avgContext,m.avgUsability],u=c.reduce((Ae,Oe)=>Ae+Oe,0)/c.length,y=c.reduce((Ae,Oe)=>Ae+Math.pow(Oe-u,2),0)/c.length,ie=Math.round(100-Math.sqrt(y));return{id:l+1,name:Ge(a),consistency:Math.max(0,ie),avgScore:Math.round(u),count:m.count}}).sort((a,m)=>m.consistency-a.consistency):[],[i,Ge]),Qe=s.useMemo(()=>[xa("name","Region",a=>a.name),Pe("count","Count",a=>a.count),Pe("percentage","% of Total",a=>a.percentage,{suffix:"%",maximumFractionDigits:0})],[]),ue=s.useMemo(()=>[xa("name","Type",a=>a.name),Pe("count","Count",a=>a.count),Pe("percentage","% of Total",a=>a.percentage,{suffix:"%",maximumFractionDigits:0})],[]),me=s.useMemo(()=>[xa("name","Source",a=>a.name),Pe("count","Count",a=>a.count),Pe("percentage","% of Total",a=>a.percentage,{suffix:"%",maximumFractionDigits:0})],[]),$=s.useMemo(()=>[xa("name","Model",a=>a.name),Pe("count","Count",a=>a.count),Pe("accuracy","Accuracy",a=>a.accuracy,{suffix:"%",maximumFractionDigits:0}),Pe("context","Context",a=>a.context,{suffix:"%",maximumFractionDigits:0}),Pe("usability","Usability",a=>a.usability,{suffix:"%",maximumFractionDigits:0}),Pe("totalScore","Total Score",a=>a.totalScore,{suffix:"%",maximumFractionDigits:0})],[]),T=s.useMemo(()=>[xa("name","Model",a=>a.name),Pe("count","Count",a=>a.count),xa("avgEditTime","Median Edit Time",a=>Y(a.avgEditTime)),xa("minEditTime","Min Edit Time",a=>Y(a.minEditTime)),xa("maxEditTime","Max Edit Time",a=>Y(a.maxEditTime))],[]),Ca=s.useMemo(()=>[xa("name","Model",a=>a.name),Pe("count","Count",a=>a.count),Pe("avgPercentageModified","Median % Modified",a=>a.avgPercentageModified,{suffix:"%",maximumFractionDigits:0}),Pe("minPercentageModified","Min % Modified",a=>a.minPercentageModified,{suffix:"%",maximumFractionDigits:0}),Pe("maxPercentageModified","Max % Modified",a=>a.maxPercentageModified,{suffix:"%",maximumFractionDigits:0})],[]),ba=s.useMemo(()=>[xa("name","Model",a=>a.name),Pe("count","Total Count",a=>a.count),Pe("deleteCount","Delete Count",a=>a.deleteCount),Pe("deleteRate","Delete Rate",a=>a.deleteRate,{suffix:"%",maximumFractionDigits:1})],[]),na=s.useMemo(()=>[xa("source","Source",a=>a.source),Pe("avgQuality","Average Quality",a=>a.avgQuality,{suffix:"%",maximumFractionDigits:0}),Pe("count","Count",a=>a.count)],[]),d=s.useMemo(()=>[xa("eventType","Event Type",a=>a.eventType),Pe("avgQuality","Average Quality",a=>a.avgQuality,{suffix:"%",maximumFractionDigits:0}),Pe("count","Count",a=>a.count)],[]),z=s.useMemo(()=>[xa("name","Model",a=>a.name),Pe("consistency","Consistency",a=>a.consistency,{suffix:"%",maximumFractionDigits:0}),Pe("avgScore","Average Score",a=>a.avgScore,{suffix:"%",maximumFractionDigits:0}),Pe("count","Count",a=>a.count)],[]),K=s.useCallback(a=>i?a==="crisis_map"?i.crisisMaps.length:a==="drone_image"?i.droneImages.length:0:0,[i]),Se=s.useCallback(a=>{if(!i)return[];const m=a==="crisis_map"?i.crisisMaps:i.droneImages,l={};return m.forEach(c=>{c.countries&&c.countries.forEach(u=>{u.r_code&&(l[u.r_code]=(l[u.r_code]||0)+1)})}),Object.entries(l).filter(([,c])=>c>0).map(([c,u])=>({name:D.find(y=>y.r_code===c)?.label||c,value:u}))},[i,D]),Re=s.useCallback(a=>{if(!i)return[];const m=a==="crisis_map"?i.crisisMaps:i.droneImages,l={};m.forEach(u=>{u.countries&&u.countries.forEach(y=>{y.r_code&&(l[y.r_code]=(l[y.r_code]||0)+1)})});const c=D.reduce((u,y)=>(y.r_code&&(u[y.r_code]={name:y.label,count:l[y.r_code]||0}),u),{});return Object.entries(c).sort(([,u],[,y])=>y.count-u.count).map(([,{name:u,count:y}],ie)=>({id:ie+1,name:u,count:y,percentage:m.length>0?Math.round(y/m.length*100):0}))},[i,D]),ia=s.useCallback(a=>{if(!i)return[];const m=a==="crisis_map"?i.crisisMaps:i.droneImages,l={};return m.forEach(c=>{c.source&&(l[c.source]=(l[c.source]||0)+1)}),Object.entries(l).filter(([,c])=>c>0).map(([c,u])=>({name:M.find(y=>y.s_code===c)?.label||c,value:u}))},[i,M]),Ie=s.useCallback(a=>{if(!i)return[];const m=a==="crisis_map"?i.crisisMaps:i.droneImages,l={};return m.forEach(c=>{c.source&&(l[c.source]=(l[c.source]||0)+1)}),Object.entries(l).sort(([,c],[,u])=>u-c).map(([c,u],y)=>({id:y+1,name:ea(c),count:u,percentage:m.length>0?Math.round(u/m.length*100):0}))},[i,ea]),aa=s.useCallback(a=>{if(!i)return[];const m=a==="crisis_map"?i.crisisMaps:i.droneImages,l={};return m.forEach(c=>{c.event_type&&(l[c.event_type]=(l[c.event_type]||0)+1)}),Object.entries(l).filter(([,c])=>c>0).map(([c,u])=>({name:w.find(y=>y.t_code===c)?.label||c,value:u}))},[i,w]),$e=s.useCallback(a=>{if(!i)return[];const m=a==="crisis_map"?i.crisisMaps:i.droneImages,l={};return m.forEach(c=>{c.event_type&&(l[c.event_type]=(l[c.event_type]||0)+1)}),Object.entries(l).sort(([,c],[,u])=>u-c).map(([c,u],y)=>({id:y+1,name:xe(c),count:u,percentage:m.length>0?Math.round(u/m.length*100):0}))},[i,xe]),Le=s.useCallback(a=>{if(!i)return"No data available";const m=a==="crisis_map"?i.crisisMaps:i.droneImages,l=new Set;m.forEach(y=>{y.model&&l.add(y.model)}),console.log(`Debug ${a}:`,{totalImages:m.length,usedModels:Array.from(l),availableEditTimes:Object.keys(i.modelEditTimes),modelEditTimesData:i.modelEditTimes});const u=Object.entries(i.modelEditTimes).filter(([y])=>l.has(y)).flatMap(([,y])=>y);return u.length===0?"No data available":Y(Ee(u))},[i,Y,Ee]),ae=s.useCallback(()=>{if(!i)return"No data available";const a=i.totalCaptions||0,m=i.percentageModified||0;return a>0?Math.round(m/a*100):0},[i]),oa=s.useCallback(()=>i&&i.deleteRate>=0?`${i.deleteRate}%`:"No data available",[i]),O=s.useCallback(a=>{if(!i)return[];const m=a==="crisis_map"?i.crisisMaps:i.droneImages,l=new Set;return m.forEach(u=>{u.model&&l.add(u.model)}),Xe.filter(u=>{const y=q.find(ie=>ie.label===u.name)?.m_code;return y&&l.has(y)})},[i,Xe,q]),A=s.useCallback(a=>{if(!i)return[];const m=a==="crisis_map"?i.crisisMaps:i.droneImages,l=new Set;return m.forEach(u=>{u.model&&l.add(u.model)}),Te.filter(u=>{const y=q.find(ie=>ie.label===u.name)?.m_code;return y&&l.has(y)})},[i,Te,q]),X=s.useCallback(a=>{if(!i)return[];const m=a==="crisis_map"?i.crisisMaps:i.droneImages,l={};return m.forEach(c=>{c.model&&(l[c.model]||(l[c.model]={count:0,deleteCount:0}),l[c.model].count++)}),Object.entries(l).map(([c,u],y)=>{const Ae=i.models?.[c]?.deleteCount||0,Oe=u.count>0?Math.round(Ae/u.count*100*10)/10:0;return{id:y+1,name:Ge(c),count:u.count,deleteCount:Ae,deleteRate:Oe}}).sort((c,u)=>u.count-c.count)},[i,Ge]),ua=s.useCallback(a=>{if(!i)return[];const m=a==="crisis_map"?i.crisisMaps:i.droneImages,l={};return m.forEach(c=>{c.model&&(l[c.model]||(l[c.model]={count:0,totalAccuracy:0,totalContext:0,totalUsability:0}),l[c.model].count++,c.accuracy!=null&&(l[c.model].totalAccuracy+=c.accuracy),c.context!=null&&(l[c.model].totalContext+=c.context),c.usability!=null&&(l[c.model].totalUsability+=c.usability))}),Object.entries(l).map(([c,u],y)=>({id:y+1,name:Ge(c),count:u.count,accuracy:u.count>0?Math.round(u.totalAccuracy/u.count):0,context:u.count>0?Math.round(u.totalContext/u.count):0,usability:u.count>0?Math.round(u.totalUsability/u.count):0,totalScore:u.count>0?Math.round((u.totalAccuracy+u.totalContext+u.totalUsability)/(3*u.count)):0})).sort((c,u)=>u.totalScore-c.totalScore)},[i,Ge]),Ce=s.useCallback(a=>{if(!i)return[];const m=a==="crisis_map"?i.crisisMaps:i.droneImages,l={};return m.forEach(c=>{c.source&&(l[c.source]||(l[c.source]={total:0,count:0,totalImages:0}),l[c.source].totalImages+=1,c.accuracy!=null&&(l[c.source].total+=c.accuracy,l[c.source].count+=1))}),Object.entries(l).map(([c,u],y)=>({id:y+1,source:ea(c),avgQuality:u.count>0?Math.round(u.total/u.count):0,count:u.totalImages}))},[i,ea]),Ze=s.useCallback(a=>{if(!i)return[];const m=a==="crisis_map"?i.crisisMaps:i.droneImages,l={};return m.forEach(c=>{c.event_type&&(l[c.event_type]||(l[c.event_type]={total:0,count:0,totalImages:0}),l[c.event_type].totalImages+=1,c.accuracy!=null&&(l[c.event_type].total+=c.accuracy,l[c.event_type].count+=1))}),Object.entries(l).map(([c,u],y)=>({id:y+1,eventType:xe(c),avgQuality:u.count>0?Math.round(u.total/u.count):0,count:u.totalImages}))},[i,xe]),P=s.useCallback(a=>{if(!i)return[];const m=a==="crisis_map"?i.crisisMaps:i.droneImages,l=new Set;return m.forEach(u=>{u.model&&l.add(u.model)}),ra.filter(u=>{const y=q.find(ie=>ie.label===u.name)?.m_code;return y&&l.has(y)})},[i,ra,q]);if(h)return e.jsx(ga,{children:e.jsx("div",{className:j.loadingContainer,children:e.jsx(ja,{})})});if(!i)return e.jsx(ga,{children:e.jsx("div",{className:j.errorContainer,children:e.jsx("div",{className:"text-red-500",children:"Failed to load analytics data. Please try again."})})});const t=["#F5333F","#F64752","#F75C65","#F87079","#F9858C","#FA999F","#FBADB2","#FCC2C5"];return e.jsx(ga,{children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx("div",{className:j.tabSelector,children:e.jsx($a,{name:"analytics-view",value:f,onChange:a=>{(a==="crisis_maps"||a==="drone_images")&&o(a)},options:la,keySelector:a=>a.key,labelSelector:a=>a.label})}),f==="crisis_maps"?e.jsxs("div",{className:j.chartGrid,children:[e.jsxs(J,{heading:"Summary Statistics",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:[e.jsxs("div",{className:j.summaryStatsCards,children:[e.jsxs("div",{className:j.summaryStatsCard,children:[e.jsx("div",{className:j.summaryStatsCardValue,children:K("crisis_map")}),e.jsx("div",{className:j.summaryStatsCardLabel,children:"Total Crisis Maps"})]}),e.jsxs("div",{className:j.summaryStatsCard,children:[e.jsx("div",{className:j.summaryStatsCardValue,children:"2000"}),e.jsx("div",{className:j.summaryStatsCardLabel,children:"Target Amount"})]})]}),e.jsxs("div",{className:j.progressSection,children:[e.jsxs("div",{className:j.progressLabel,children:[e.jsx("span",{children:"Progress towards target"}),e.jsxs("span",{children:[Math.round(K("crisis_map")/2e3*100),"%"]})]}),e.jsx(vt,{value:K("crisis_map"),totalValue:2e3})]})]}),e.jsxs(J,{heading:"Distribution Analysis",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:[e.jsxs("div",{className:j.userInteractionCards,children:[e.jsxs("div",{className:j.userInteractionCard,children:[e.jsx("div",{className:j.userInteractionCardLabel,children:"Regions Distribution"}),e.jsx("div",{className:j.chartContainer,children:e.jsx(Ea,{data:Se("crisis_map"),valueSelector:a=>a.value,labelSelector:a=>a.name,keySelector:a=>a.name,colors:t,showPercentageInLegend:!0})}),e.jsx(_,{name:"view-regions-details",variant:be?"primary":"secondary",onClick:()=>ne(be?"none":"regions"),className:j.userInteractionCardButton,children:be?"Hide Details":"View Details"})]}),e.jsxs("div",{className:j.userInteractionCard,children:[e.jsx("div",{className:j.userInteractionCardLabel,children:"Sources Distribution"}),e.jsx("div",{className:j.chartContainer,children:e.jsx(Ea,{data:ia("crisis_map"),valueSelector:a=>a.value,labelSelector:a=>a.name,keySelector:a=>a.name,colors:t,showPercentageInLegend:!0})}),e.jsx(_,{name:"view-sources-details",variant:ee?"primary":"secondary",onClick:()=>ne(ee?"none":"sources"),className:j.userInteractionCardButton,children:ee?"Hide Details":"View Details"})]}),e.jsxs("div",{className:j.userInteractionCard,children:[e.jsx("div",{className:j.userInteractionCardLabel,children:"Types Distribution"}),e.jsx("div",{className:j.chartContainer,children:e.jsx(Ea,{data:aa("crisis_map"),valueSelector:a=>a.value,labelSelector:a=>a.name,keySelector:a=>a.name,colors:t,showPercentageInLegend:!0})}),e.jsx(_,{name:"view-types-details",variant:I?"primary":"secondary",onClick:()=>ne(I?"none":"types"),className:j.userInteractionCardButton,children:I?"Hide Details":"View Details"})]})]}),be&&e.jsx("div",{className:j.modelPerformance,children:e.jsx(ta,{data:Re("crisis_map"),columns:Qe,keySelector:sa,filtered:!1,pending:!1})}),ee&&e.jsx("div",{className:j.modelPerformance,children:e.jsx(ta,{data:Ie("crisis_map"),columns:me,keySelector:sa,filtered:!1,pending:!1})}),I&&e.jsx("div",{className:j.modelPerformance,children:e.jsx(ta,{data:$e("crisis_map"),columns:ue,keySelector:sa,filtered:!1,pending:!1})})]}),e.jsxs(J,{heading:"User Interaction Statistics",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:[e.jsxs("div",{className:j.userInteractionCards,children:[e.jsxs("div",{className:j.userInteractionCard,children:[e.jsx("div",{className:j.userInteractionCardValue,children:Le("crisis_map")}),e.jsx("div",{className:j.userInteractionCardLabel,children:"Median Edit Time"}),e.jsx(_,{name:"view-edit-time-details",variant:re?"primary":"secondary",onClick:()=>ne(re?"none":"editTime"),className:j.userInteractionCardButton,children:re?"Hide Details":"View Details"})]}),e.jsxs("div",{className:j.userInteractionCard,children:[e.jsx("div",{className:j.userInteractionCardValue,children:ae()}),e.jsx("div",{className:j.userInteractionCardLabel,children:"Median % Modified"}),e.jsx(_,{name:"view-percentage-details",variant:he?"primary":"secondary",onClick:()=>ne(he?"none":"percentage"),className:j.userInteractionCardButton,children:he?"Hide Details":"View Details"})]}),e.jsxs("div",{className:j.userInteractionCard,children:[e.jsx("div",{className:j.userInteractionCardValue,children:oa()}),e.jsx("div",{className:j.userInteractionCardLabel,children:"Delete Rate"}),e.jsx(_,{name:"view-delete-details",variant:je?"primary":"secondary",onClick:()=>ne(je?"none":"delete"),className:j.userInteractionCardButton,children:je?"Hide Details":"View Details"})]})]}),re&&e.jsx("div",{className:j.modelPerformance,children:e.jsx(ta,{data:O("crisis_map"),columns:T,keySelector:sa,filtered:!1,pending:!1})}),he&&e.jsx("div",{className:j.modelPerformance,children:e.jsx(ta,{data:A("crisis_map"),columns:Ca,keySelector:sa,filtered:!1,pending:!1})}),je&&e.jsx("div",{className:j.modelPerformance,children:e.jsx(ta,{data:X("crisis_map"),columns:ba,keySelector:sa,filtered:!1,pending:!1})})]}),e.jsx(J,{heading:"Model Performance",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsx("div",{className:j.modelPerformance,children:e.jsx(ta,{data:ua("crisis_map"),columns:$,keySelector:sa,filtered:!1,pending:!1})})}),e.jsx(J,{heading:"Quality-Source Correlation",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsx("div",{className:j.tableContainer,children:e.jsx(ta,{data:Ce("crisis_map"),columns:na,keySelector:sa,filtered:!1,pending:!1})})}),e.jsx(J,{heading:"Quality-Event Type Correlation",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsx("div",{className:j.tableContainer,children:e.jsx(ta,{data:Ze("crisis_map"),columns:d,keySelector:sa,filtered:!1,pending:!1})})}),e.jsx(J,{heading:"Model Consistency Analysis",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsx("div",{className:j.tableContainer,children:e.jsx(ta,{data:P("crisis_map"),columns:z,keySelector:sa,filtered:!1,pending:!1})})})]}):e.jsxs("div",{className:j.chartGrid,children:[e.jsxs(J,{heading:"Summary Statistics",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:[e.jsxs("div",{className:j.summaryStatsCards,children:[e.jsxs("div",{className:j.summaryStatsCard,children:[e.jsx("div",{className:j.summaryStatsCardValue,children:K("drone_image")}),e.jsx("div",{className:j.summaryStatsCardLabel,children:"Total Drone Images"})]}),e.jsxs("div",{className:j.summaryStatsCard,children:[e.jsx("div",{className:j.summaryStatsCardValue,children:"2000"}),e.jsx("div",{className:j.summaryStatsCardLabel,children:"Target Amount"})]})]}),e.jsxs("div",{className:j.progressSection,children:[e.jsxs("div",{className:j.progressLabel,children:[e.jsx("span",{children:"Progress towards target"}),e.jsxs("span",{children:[Math.round(K("drone_image")/2e3*100),"%"]})]}),e.jsx(vt,{value:K("drone_image"),totalValue:2e3})]})]}),e.jsxs(J,{heading:"Distribution Analysis",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:[e.jsxs("div",{className:j.userInteractionCards,children:[e.jsxs("div",{className:j.userInteractionCard,children:[e.jsx("div",{className:j.userInteractionCardLabel,children:"Regions Distribution"}),e.jsx("div",{className:j.chartContainer,children:e.jsx(Ea,{data:Se("drone_image"),valueSelector:a=>a.value,labelSelector:a=>a.name,keySelector:a=>a.name,colors:t,showPercentageInLegend:!0})}),e.jsx(_,{name:"view-regions-details",variant:be?"primary":"secondary",onClick:()=>ne(be?"none":"regions"),className:j.userInteractionCardButton,children:be?"Hide Details":"View Details"})]}),e.jsxs("div",{className:j.userInteractionCard,children:[e.jsx("div",{className:j.userInteractionCardLabel,children:"Types Distribution"}),e.jsx("div",{className:j.chartContainer,children:e.jsx(Ea,{data:aa("drone_image"),valueSelector:a=>a.value,labelSelector:a=>a.name,keySelector:a=>a.name,colors:t,showPercentageInLegend:!0})}),e.jsx(_,{name:"view-types-details",variant:I?"primary":"secondary",onClick:()=>ne(I?"none":"types"),className:j.userInteractionCardButton,children:I?"Hide Details":"View Details"})]})]}),be&&e.jsx("div",{className:j.modelPerformance,children:e.jsx(ta,{data:Re("drone_image"),columns:Qe,keySelector:sa,filtered:!1,pending:!1})}),I&&e.jsx("div",{className:j.modelPerformance,children:e.jsx(ta,{data:$e("drone_image"),columns:ue,keySelector:sa,filtered:!1,pending:!1})})]}),e.jsxs(J,{heading:"User Interaction Statistics",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:[e.jsxs("div",{className:j.userInteractionCards,children:[e.jsxs("div",{className:j.userInteractionCard,children:[e.jsx("div",{className:j.userInteractionCardValue,children:Le("drone_image")}),e.jsx("div",{className:j.userInteractionCardLabel,children:"Median Edit Time"}),e.jsx(_,{name:"view-edit-time-details",variant:re?"primary":"secondary",onClick:()=>ne(re?"none":"editTime"),className:j.userInteractionCardButton,children:re?"Hide Details":"View Details"})]}),e.jsxs("div",{className:j.userInteractionCard,children:[e.jsx("div",{className:j.userInteractionCardValue,children:ae()}),e.jsx("div",{className:j.userInteractionCardLabel,children:"Median % Modified"}),e.jsx(_,{name:"view-percentage-details",variant:he?"primary":"secondary",onClick:()=>ne(he?"none":"percentage"),className:j.userInteractionCardButton,children:he?"Hide Details":"View Details"})]}),e.jsxs("div",{className:j.userInteractionCard,children:[e.jsx("div",{className:j.userInteractionCardValue,children:oa()}),e.jsx("div",{className:j.userInteractionCardLabel,children:"Delete Rate"}),e.jsx(_,{name:"view-delete-details",variant:je?"primary":"secondary",onClick:()=>ne(je?"none":"delete"),className:j.userInteractionCardButton,children:je?"Hide Details":"View Details"})]})]}),re&&e.jsx("div",{className:j.modelPerformance,children:e.jsx(ta,{data:O("drone_image"),columns:T,keySelector:sa,filtered:!1,pending:!1})}),he&&e.jsx("div",{className:j.modelPerformance,children:e.jsx(ta,{data:A("drone_image"),columns:Ca,keySelector:sa,filtered:!1,pending:!1})}),je&&e.jsx("div",{className:j.modelPerformance,children:e.jsx(ta,{data:X("drone_image"),columns:ba,keySelector:sa,filtered:!1,pending:!1})})]}),e.jsx(J,{heading:"Model Performance",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsx("div",{className:j.modelPerformance,children:e.jsx(ta,{data:ua("drone_image"),columns:$,keySelector:sa,filtered:!1,pending:!1})})}),e.jsx(J,{heading:"Quality-Event Type Correlation",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsx("div",{className:j.tableContainer,children:e.jsx(ta,{data:Ze("drone_image"),columns:d,keySelector:sa,filtered:!1,pending:!1})})}),e.jsx(J,{heading:"Model Consistency Analysis",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsx("div",{className:j.tableContainer,children:e.jsx(ta,{data:P("drone_image"),columns:z,keySelector:sa,filtered:!1,pending:!1})})})]})]})})}const Zi="modulepreload",Ki=function(r){return"/app/"+r},Nt={},Ft=function(i,v,h){let b=Promise.resolve();if(v&&v.length>0){let G=function(w){return Promise.all(w.map(N=>Promise.resolve(N).then(D=>({status:"fulfilled",value:D}),D=>({status:"rejected",reason:D}))))};document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),M=o?.nonce||o?.getAttribute("nonce");b=G(v.map(w=>{if(w=Ki(w),w in Nt)return;Nt[w]=!0;const N=w.endsWith(".css"),D=N?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${w}"]${D}`))return;const se=document.createElement("link");if(se.rel=N?"stylesheet":Zi,N||(se.as="script"),se.crossOrigin="",se.href=w,M&&se.setAttribute("nonce",M),document.head.appendChild(se),N)return new Promise((q,R)=>{se.addEventListener("load",q),se.addEventListener("error",()=>R(new Error(`Unable to preload CSS for ${w}`)))})}))}function f(o){const M=new Event("vite:preloadError",{cancelable:!0});if(M.payload=o,window.dispatchEvent(M),!M.defaultPrevented)throw o}return b.then(o=>{for(const M of o||[])M.status==="rejected"&&f(M.reason);return i().catch(f)})},Et=s.createContext(void 0),Xi=({children:r})=>{const[i,v]=s.useState(!1),[h,b]=s.useState(!0),f=async()=>{const w=localStorage.getItem("adminToken");if(!w){v(!1),b(!1);return}try{(await fetch("/api/admin/verify",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${w}`}})).ok?v(!0):(localStorage.removeItem("adminToken"),v(!1))}catch(N){console.error("Error verifying admin token:",N),localStorage.removeItem("adminToken"),v(!1)}finally{b(!1)}},o=async w=>{try{const N=await fetch("/api/admin/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:w})});if(N.ok){const D=await N.json();return localStorage.setItem("adminToken",D.access_token),v(!0),!0}else return!1}catch(N){return console.error("Login error:",N),!1}},M=()=>{localStorage.removeItem("adminToken"),v(!1)};s.useEffect(()=>{f()},[]);const G={isAuthenticated:i,isLoading:h,login:o,logout:M,verifyToken:f};return e.jsx(Et.Provider,{value:G,children:r})},lt=()=>{const r=s.useContext(Et);if(r===void 0)throw new Error("useAdmin must be used within an AdminProvider");return r},eo="_tabSelector_o9y1f_1",ao="_metadataTags_o9y1f_8",to="_metadataTag_o9y1f_8",so="_metadataTagSource_o9y1f_32",no="_metadataTagType_o9y1f_43",io="_mapItem_o9y1f_54",oo="_mapItemImage_o9y1f_72",lo="_mapItemContent_o9y1f_92",ro="_mapItemTitle_o9y1f_97",co="_mapItemMetadata_o9y1f_105",mo="_fullSizeModalOverlay_o9y1f_134",uo="_fullSizeModalContent_o9y1f_148",go="_ratingWarningContent_o9y1f_159",ho="_ratingWarningTitle_o9y1f_165",po="_ratingWarningText_o9y1f_172",fo="_ratingWarningButtons_o9y1f_179",Ke={tabSelector:eo,metadataTags:ao,metadataTag:to,metadataTagSource:so,metadataTagType:no,mapItem:io,mapItemImage:oo,mapItemContent:lo,mapItemTitle:ro,mapItemMetadata:co,fullSizeModalOverlay:mo,fullSizeModalContent:uo,ratingWarningContent:go,ratingWarningTitle:ho,ratingWarningText:po,ratingWarningButtons:fo};function xo(){const r=Aa(),i=Mt(),{isAuthenticated:v}=lt(),[h,b]=s.useState("explore"),[f,o]=s.useState([]),{search:M,srcFilter:G,catFilter:w,regionFilter:N,countryFilter:D,imageTypeFilter:se,uploadTypeFilter:q,showReferenceExamples:R,setShowReferenceExamples:re}=qa(),[ye,he]=s.useState([]),[de,je]=s.useState([]),[Ye,be]=s.useState([]),[we,ee]=s.useState([]),[Ne,I]=s.useState([]),[pe,ne]=s.useState(!0),[la,He]=s.useState(!0),[ma,Ve]=s.useState(!1),[ea,Ee]=s.useState(!1),[Y,xe]=s.useState(!1),[Ge,Xe]=s.useState(!1),[Te,ra]=s.useState(""),[Qe,ue]=s.useState(!1),me=[{key:"explore",label:"List"},{key:"mapDetails",label:"Carousel"}],$=()=>{He(!0),fetch("/api/images/grouped").then(d=>d.ok?d.json():(console.error("ExplorePage: Grouped endpoint failed, trying legacy endpoint"),fetch("/api/captions/legacy").then(z=>z.ok?z.json():(console.error("ExplorePage: Legacy endpoint failed, trying regular images endpoint"),fetch("/api/images").then(K=>{if(!K.ok)throw new Error(`HTTP ${K.status}: ${K.statusText}`);return K.json()}))))).then(d=>{if(console.log("ExplorePage: API response data:",d),Array.isArray(d)){const z=d.filter(K=>{const Se=K.generated&&K.model,Re=K.image_id&&K.image_id!=="undefined"&&K.image_id!=="null";return Re||console.error("ExplorePage: Item missing valid image_id:",K),Se&&Re});console.log("ExplorePage: Filtered images with captions:",z.length),o(z)}else console.error("ExplorePage: API response is not an array:",d),o([])}).catch(()=>{o([])}).finally(()=>{He(!1)})};s.useEffect(()=>{$()},[]),s.useEffect(()=>{const d=()=>{document.hidden||$()};return document.addEventListener("visibilitychange",d),()=>{document.removeEventListener("visibilitychange",d)}},[]),s.useEffect(()=>{new URLSearchParams(i.search).get("export")==="true"&&(Ve(!0),r("/explore",{replace:!0}))},[i.search,r,M,G,w,N,D,se,R]),s.useEffect(()=>{ne(!0),Promise.all([fetch("/api/sources").then(d=>{if(!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);return d.json()}),fetch("/api/types").then(d=>{if(!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);return d.json()}),fetch("/api/regions").then(d=>{if(!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);return d.json()}),fetch("/api/countries").then(d=>{if(!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);return d.json()}),fetch("/api/image-types").then(d=>{if(!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);return d.json()})]).then(([d,z,K,Se,Re])=>{he(d),je(z),be(K),ee(Se),I(Re)}).catch(()=>{}).finally(()=>{ne(!1)})},[]);const T=s.useMemo(()=>f.filter(d=>{const z=!M||d.title?.toLowerCase().includes(M.toLowerCase())||d.generated?.toLowerCase().includes(M.toLowerCase())||d.source?.toLowerCase().includes(M.toLowerCase())||d.event_type?.toLowerCase().includes(M.toLowerCase()),K=!G||d.source&&d.source.split(", ").some(Le=>Le.trim()===G),Se=!w||d.event_type&&d.event_type.split(", ").some(Le=>Le.trim()===w),Re=!N||d.countries.some(Le=>Le.r_code===N),ia=!D||d.countries.some(Le=>Le.c_code===D),Ie=!se||d.image_type===se,aa=!q||q==="single"&&(!d.image_count||d.image_count<=1)||q==="multiple"&&d.image_count&&d.image_count>1,$e=!R||d.starred===!0;return z&&K&&Se&&Re&&ia&&Ie&&aa&&$e}),[f,M,G,w,N,D,se,q,R]),Ca=async(d,z="fine-tuning")=>{if(d.length===0){alert("No images to export");return}Ee(!0),xe(!1);try{const K=(await Ft(async()=>{const{default:ae}=await import("./jszip.min-DF7oyuhK.js").then(oa=>oa.j);return{default:ae}},__vite__mapDeps([0,1,2]))).default,Se=new K,Re=d.filter(ae=>ae.image_type==="crisis_map"),ia=d.filter(ae=>ae.image_type==="drone_image");if(Re.length>0){const ae=Se.folder("crisis_maps_dataset"),oa=ae?.folder("images");if(oa){let O=1;for(const A of Re)try{const X=A.image_count&&A.image_count>1?A.all_image_ids||[A.image_id]:[A.image_id],ua=X.map(async(P,t)=>{try{const a=await fetch(`/api/images/${P}/file`);if(!a.ok)throw new Error(`Failed to fetch image ${P}`);const m=await a.blob(),l=A.file_key.split(".").pop()||"jpg",c=`${String(O).padStart(4,"0")}_${String(t+1).padStart(2,"0")}.${l}`;return oa.file(c,m),{success:!0,fileName:c,imageId:P}}catch(a){return console.error(`Failed to process image ${P}:`,a),{success:!1,fileName:"",imageId:P}}}),Ze=(await Promise.all(ua)).filter(P=>P.success);if(Ze.length>0){if(z==="fine-tuning"){const P=Ze.map(m=>`images/${m.fileName}`),t=Math.random(),a={image:P.length===1?P[0]:P,caption:A.edited||A.generated||"",metadata:{image_id:X,title:A.title,source:A.source,event_type:A.event_type,image_type:A.image_type,countries:A.countries,starred:A.starred,image_count:A.image_count||1}};if(!ae)continue;if(t<.8){const m=ae.file("train.jsonl");if(m){const l=await m.async("string").then(c=>JSON.parse(c||"[]")).catch(()=>[]);l.push(a),ae.file("train.jsonl",JSON.stringify(l,null,2))}else ae.file("train.jsonl",JSON.stringify([a],null,2))}else if(t<.9){const m=ae.file("test.jsonl");if(m){const l=await m.async("string").then(c=>JSON.parse(c||"[]")).catch(()=>[]);l.push(a),ae.file("test.jsonl",JSON.stringify(l,null,2))}else ae.file("test.jsonl",JSON.stringify([a],null,2))}else{const m=ae.file("val.jsonl");if(m){const l=await m.async("string").then(c=>JSON.parse(c||"[]")).catch(()=>[]);l.push(a),ae.file("val.jsonl",JSON.stringify(l,null,2))}else ae.file("val.jsonl",JSON.stringify([a],null,2))}}else{const P=Ze.map(a=>`images/${a.fileName}`),t={image:P.length===1?P[0]:P,caption:A.edited||A.generated||"",metadata:{image_id:X,title:A.title,source:A.source,event_type:A.event_type,image_type:A.image_type,countries:A.countries,starred:A.starred,image_count:A.image_count||1}};ae&&ae.file(`${String(O).padStart(4,"0")}.json`,JSON.stringify(t,null,2))}O++}}catch(X){console.error(`Failed to process caption ${A.image_id}:`,X)}}}if(ia.length>0){const ae=Se.folder("drone_images_dataset"),oa=ae?.folder("images");if(oa){let O=1;for(const A of ia)try{const X=A.image_count&&A.image_count>1?A.all_image_ids||[A.image_id]:[A.image_id],ua=X.map(async(P,t)=>{try{const a=await fetch(`/api/images/${P}/file`);if(!a.ok)throw new Error(`Failed to fetch image ${P}`);const m=await a.blob(),l=A.file_key.split(".").pop()||"jpg",c=`${String(O).padStart(4,"0")}_${String(t+1).padStart(2,"0")}.${l}`;return oa.file(c,m),{success:!0,fileName:c,imageId:P}}catch(a){return console.error(`Failed to process image ${P}:`,a),{success:!1,fileName:"",imageId:P}}}),Ze=(await Promise.all(ua)).filter(P=>P.success);if(Ze.length>0){if(z==="fine-tuning"){const P=Ze.map(m=>`images/${m.fileName}`),t=Math.random(),a={image:P.length===1?P[0]:P,caption:A.edited||A.generated||"",metadata:{image_id:X,title:A.title,source:A.source,event_type:A.event_type,image_type:A.image_type,countries:A.countries,starred:A.starred,image_count:A.image_count||1}};if(!ae)continue;if(t<.8){const m=ae.file("train.jsonl");if(m){const l=await m.async("string").then(c=>JSON.parse(c||"[]")).catch(()=>[]);l.push(a),ae.file("train.jsonl",JSON.stringify(l,null,2))}else ae.file("train.jsonl",JSON.stringify([a],null,2))}else if(t<.9){const m=ae.file("test.jsonl");if(m){const l=await m.async("string").then(c=>JSON.parse(c||"[]")).catch(()=>[]);l.push(a),ae.file("test.jsonl",JSON.stringify(l,null,2))}else ae.file("test.jsonl",JSON.stringify([a],null,2))}else{const m=ae.file("val.jsonl");if(m){const l=await m.async("string").then(c=>JSON.parse(c||"[]")).catch(()=>[]);l.push(a),ae.file("val.jsonl",JSON.stringify(l,null,2))}else ae.file("val.jsonl",JSON.stringify([a],null,2))}}else{const P=Ze.map(a=>`images/${a.fileName}`),t={image:P.length===1?P[0]:P,caption:A.edited||A.generated||"",metadata:{image_id:X,title:A.title,source:A.source,event_type:A.event_type,image_type:A.image_type,countries:A.countries,starred:A.starred,image_count:A.image_count||1}};ae&&ae.file(`${String(O).padStart(4,"0")}.json`,JSON.stringify(t,null,2))}O++}}catch(X){console.error(`Failed to process caption ${A.image_id}:`,X)}}}const Ie=await Se.generateAsync({type:"blob"}),aa=URL.createObjectURL(Ie),$e=document.createElement("a");$e.href=aa,$e.download=`datasets_${z}_${new Date().toISOString().split("T")[0]}.zip`,document.body.appendChild($e),$e.click(),document.body.removeChild($e),URL.revokeObjectURL(aa);const Le=(Re.length||0)+(ia.length||0);console.log(`Exported ${z} datasets with ${Le} total images:`),Re.length>0&&console.log(`- Crisis maps: ${Re.length} images`),ia.length>0&&console.log(`- Drone images: ${ia.length} images`),xe(!0)}catch(K){console.error("Export failed:",K),alert("Failed to export dataset. Please try again.")}finally{Ee(!1)}},ba=d=>{ra(d),Xe(!0)},na=async()=>{if(Te){ue(!0);try{console.log("Deleting image with ID:",Te),(await fetch(`/api/images/${Te}`,{method:"DELETE"})).ok?(o(z=>z.filter(K=>K.image_id!==Te)),Xe(!1),ra("")):(console.error("Delete failed"),alert("Failed to delete image. Please try again."))}catch(d){console.error("Delete failed:",d),alert("Failed to delete image. Please try again.")}finally{ue(!1)}}};return e.jsxs(ga,{children:[la?e.jsx("div",{className:"flex flex-col items-center justify-center min-h-[60vh]",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx(ja,{className:"text-ifrcRed"}),e.jsx("div",{children:"Loading examples..."})]})}):e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:Ke.tabSelector,children:[e.jsx($a,{name:"explore-view",value:h,onChange:d=>{(d==="explore"||d==="mapDetails")&&(b(d),d==="mapDetails"&&f.length>0&&(f[0]?.image_id&&f[0].image_id!=="undefined"&&f[0].image_id!=="null"?r(`/map/${f[0].image_id}`):console.error("Invalid image_id for navigation:",f[0]?.image_id)))},options:me,keySelector:d=>d.key,labelSelector:d=>d.label}),e.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[e.jsx(J,{withInternalPadding:!0,className:"bg-white/20 backdrop-blur-sm rounded-md p-2",children:e.jsxs(_,{name:"reference-examples",variant:R?"primary":"secondary",onClick:()=>re(!R),className:"whitespace-nowrap",children:[e.jsx("span",{className:"mr-2",children:R?e.jsx("span",{className:"text-yellow-400",children:"★"}):e.jsx("span",{className:"text-yellow-400",children:"☆"})}),"Reference Examples"]})}),e.jsx(_,{name:"export-dataset",variant:"secondary",onClick:()=>Ve(!0),children:"Export"})]})]}),h==="explore"?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"mb-6 space-y-4",children:e.jsx("div",{className:"flex flex-wrap items-center gap-4",children:e.jsx(J,{withInternalPadding:!0,className:"bg-white/20 backdrop-blur-sm rounded-md p-2 flex-1 min-w-[300px]",children:e.jsx(Dt,{sources:ye,types:de,regions:Ye,countries:we,imageTypes:Ne,isLoadingFilters:pe})})})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("p",{className:"text-sm text-gray-600",children:[T.length," of ",f.length," examples"]})}),la&&e.jsx("div",{className:"text-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx(ja,{className:"text-ifrcRed"}),e.jsx("div",{children:"Loading examples..."})]})}),!la&&e.jsxs("div",{className:"space-y-4",children:[T.map(d=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:`${Ke.mapItem} flex-1`,onClick:()=>{console.log("ExplorePage: Clicking on image with ID:",d.image_id),console.log("ExplorePage: Image data:",d),d.image_id&&d.image_id!=="undefined"&&d.image_id!=="null"?(console.log("ExplorePage: Navigating to:",`/map/${d.image_id}`),console.log("ExplorePage: Full navigation URL:",`/#/map/${d.image_id}`),r(`/map/${d.image_id}`)):(console.error("Invalid image_id for navigation:",d.image_id),console.error("Full item data:",JSON.stringify(d,null,2)),alert(`Cannot navigate: Invalid image ID (${d.image_id})`))},children:[e.jsx("div",{className:Ke.mapItemImage,style:{width:"120px",height:"80px"},children:d.image_url?e.jsxs(e.Fragment,{children:[console.log("ExplorePage: Rendering image with URL:",d.image_url),e.jsx("img",{src:d.image_url,alt:d.file_key,onError:z=>{console.error("ExplorePage: Image failed to load:",d.image_url);const K=z.target;K.style.display="none",K.parentElement.innerHTML="Img"},onLoad:()=>console.log("ExplorePage: Image loaded successfully:",d.image_url)})]}):e.jsxs(e.Fragment,{children:[console.log("ExplorePage: No image_url provided for item:",d),"'Img'"]})}),e.jsxs("div",{className:Ke.mapItemContent,children:[e.jsx("h3",{className:Ke.mapItemTitle,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:d.title||"Untitled"}),d.starred&&e.jsx("span",{className:"text-red-500 text-lg",title:"Starred image",children:"★"})]})}),e.jsx("div",{className:Ke.mapItemMetadata,children:e.jsxs("div",{className:Ke.metadataTags,children:[d.image_type!=="drone_image"&&e.jsx("span",{className:Ke.metadataTagSource,children:d.source&&d.source.includes(", ")?d.source.split(", ").map(z=>ye.find(K=>K.s_code===z.trim())?.label||z.trim()).join(", "):ye.find(z=>z.s_code===d.source)?.label||d.source}),e.jsx("span",{className:Ke.metadataTagType,children:d.event_type&&d.event_type.includes(", ")?d.event_type.split(", ").map(z=>de.find(K=>K.t_code===z.trim())?.label||z.trim()).join(", "):de.find(z=>z.t_code===d.event_type)?.label||d.event_type}),e.jsx("span",{className:Ke.metadataTag,children:Ne.find(z=>z.image_type===d.image_type)?.label||d.image_type}),d.image_count&&d.image_count>1&&e.jsxs("span",{className:Ke.metadataTag,title:`Multi-upload with ${d.image_count} images`,children:["📷 ",d.image_count]}),(!d.image_count||d.image_count<=1)&&e.jsx("span",{className:Ke.metadataTag,title:"Single Upload",children:"Single"}),d.countries&&d.countries.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:Ke.metadataTag,children:Ye.find(z=>z.r_code===d.countries[0].r_code)?.label||"Unknown Region"}),e.jsx("span",{className:Ke.metadataTag,children:d.countries.map(z=>z.label).join(", ")})]})]})})]})]}),v&&e.jsx(J,{withInternalPadding:!0,className:"bg-white/20 backdrop-blur-sm rounded-md p-2",children:e.jsx(_,{name:`delete-${d.image_id}`,variant:"tertiary",size:1,className:"bg-red-50 hover:bg-red-100 text-red-700 border border-red-200 hover:border-red-300",onClick:()=>ba(d.image_id),title:"Delete","aria-label":"Delete saved image",children:e.jsx(Ra,{className:"w-4 h-4"})})})]},d.image_id)),!T.length&&e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-gray-500",children:"No examples found."})})]})]})]}):e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-gray-500",children:"Map Details view coming soon..."}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"This will show detailed information about individual maps"})]})})]}),Ge&&e.jsx("div",{className:Ke.fullSizeModalOverlay,onClick:()=>Xe(!1),children:e.jsx("div",{className:Ke.fullSizeModalContent,onClick:d=>d.stopPropagation(),children:e.jsxs("div",{className:Ke.ratingWarningContent,children:[e.jsx("h3",{className:Ke.ratingWarningTitle,children:"Delete Image?"}),e.jsx("p",{className:Ke.ratingWarningText,children:"This action cannot be undone. Are you sure you want to delete this saved image and all related data?"}),e.jsxs("div",{className:Ke.ratingWarningButtons,children:[e.jsx(_,{name:"confirm-delete",variant:"secondary",onClick:na,disabled:Qe,children:Qe?"Deleting...":"Delete"}),e.jsx(_,{name:"cancel-delete",variant:"tertiary",onClick:()=>Xe(!1),disabled:Qe,children:"Cancel"})]})]})})}),e.jsx(Pt,{isOpen:ma,onClose:()=>{Ve(!1),xe(!1),Ee(!1)},onExport:(d,z)=>{const K=T.filter(Se=>z.includes(Se.image_type));Ca(K,d)},filteredCount:T.length,totalCount:f.length,hasFilters:!!(M||G||w||N||D||se||q||R),crisisMapsCount:T.filter(d=>d.image_type==="crisis_map").length,droneImagesCount:T.filter(d=>d.image_type==="drone_image").length,isLoading:ea,exportSuccess:Y})]})}const _o="_helpContainer_1wavj_1",vo="_helpSection_1wavj_13",yo="_sectionHeader_1wavj_49",jo="_sectionTitle_1wavj_91",Co="_sectionContent_1wavj_105",bo="_guidelinesList_1wavj_119",wo="_buttonContainer_1wavj_181",ke={helpContainer:_o,helpSection:vo,sectionHeader:yo,sectionTitle:jo,sectionContent:Co,guidelinesList:bo,buttonContainer:wo};function No(){const r=Aa(),{setShowReferenceExamples:i}=qa(),v=()=>{r("/upload")},h=()=>{i(!0),r("/explore")},b=()=>{r("/analytics?view=crisis_maps")};return e.jsx(ga,{className:"py-10",children:e.jsx("div",{className:ke.helpContainer,children:e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:ke.helpSection,children:[e.jsx("div",{className:ke.sectionHeader,children:e.jsx(Ia,{level:3,className:ke.sectionTitle,children:"Introduction"})}),e.jsx("div",{className:ke.sectionContent,children:"In collaboration with the IFRC, PromptAid Vision is a tool that generates textual descriptions of crisis maps/crisis drone images utiliing Visual language models. This prototype is for collecting data for the fine-tuning of our own models. We aim to utilize AI tools to support national societies with rapid decision making during emergencies."}),e.jsx("div",{className:ke.buttonContainer,children:e.jsx(_,{name:"upload-now",variant:"secondary",onClick:v,children:"Upload now →"})})]}),e.jsxs("div",{className:ke.helpSection,children:[e.jsx("div",{className:ke.sectionHeader,children:e.jsx(Ia,{level:3,className:ke.sectionTitle,children:"Guidelines"})}),e.jsxs("div",{className:ke.sectionContent,children:["To make the process smoother, please follow the guidelines below:",e.jsxs("ul",{className:ke.guidelinesList,children:[e.jsx("li",{children:"Avoid uploading images that are not crisis maps/crisis drone images."}),e.jsx("li",{children:"Confirm the image details prior to modifying the description."}),e.jsx("li",{children:"Before the modification, please read the description generated and provide a rating via the rating sliders."}),e.jsx("li",{children:'Click the "Submit" button to save the description.'})]})]}),e.jsx("div",{className:ke.buttonContainer,children:e.jsx(_,{name:"see-examples",variant:"secondary",onClick:h,children:"See examples →"})})]}),e.jsxs("div",{className:ke.helpSection,children:[e.jsx("div",{className:ke.sectionHeader,children:e.jsx(Ia,{level:3,className:ke.sectionTitle,children:"VLMs"})}),e.jsx("div",{className:ke.sectionContent,children:"PromptAid Vision uses a variety of Visual Language Models (VLMs). A random VLM is selected for each upload. Therefore feel free to delete and reupload. You can view performance details here:"}),e.jsx("div",{className:ke.buttonContainer,children:e.jsx(_,{name:"view-vlm-details",variant:"secondary",onClick:b,children:"View VLM details →"})})]}),e.jsxs("div",{className:ke.helpSection,children:[e.jsx("div",{className:ke.sectionHeader,children:e.jsx(Ia,{level:3,className:ke.sectionTitle,children:"Dataset"})}),e.jsx("div",{className:ke.sectionContent,children:"All users are able to export the dataset. You could apply filters when exporting, and it have the option to organize based on model fine-tuning formats."}),e.jsx("div",{className:ke.buttonContainer,children:e.jsx(_,{name:"export-dataset",variant:"secondary",onClick:()=>{i(!1),r("/explore"),setTimeout(()=>{const f=document.querySelector('[name="export-dataset"]');f&&f.click()},100)},children:"Export dataset →"})})]}),e.jsxs("div",{className:ke.helpSection,children:[e.jsx("div",{className:ke.sectionHeader,children:e.jsx(Ia,{level:3,className:ke.sectionTitle,children:"Contact us"})}),e.jsx("div",{className:ke.sectionContent,children:"Need help or have questions about PromptAid Vision? Our team is here to support you."}),e.jsx("div",{className:ke.buttonContainer,children:e.jsx(_,{name:"contact-support",variant:"secondary",disabled:!0,children:"Get in touch →"})})]})]})})})}const So="_tabSelector_usssr_1",Io="_imageContainer_usssr_12",Mo="_imagePlaceholder_usssr_33",ko="_metadataTags_usssr_45",To="_metadataTag_usssr_45",Do="_captionContainer_usssr_67",Po="_captionText_usssr_74",Lo="_gridLayout_usssr_131",Fo="_detailsSection_usssr_155",Eo="_loadingContainer_usssr_161",$o="_errorContainer_usssr_171",Ro="_fullSizeModalOverlay_usssr_205",Ao="_fullSizeModalContent_usssr_219",Oo="_ratingWarningContent_usssr_230",Bo="_ratingWarningTitle_usssr_236",zo="_ratingWarningText_usssr_243",Uo="_ratingWarningButtons_usssr_250",Wo="_carouselContainer_usssr_365",Ho="_carouselImageWrapper_usssr_370",Vo="_carouselImage_usssr_370",Go="_carouselNavigation_usssr_393",Jo="_carouselButton_usssr_405",qo="_carouselIndicators_usssr_429",Yo="_carouselIndicator_usssr_429",Qo="_carouselIndicatorActive_usssr_458",Zo="_singleImageContainer_usssr_488",Ko="_viewImageButtonContainer_usssr_494",le={tabSelector:So,imageContainer:Io,imagePlaceholder:Mo,metadataTags:ko,metadataTag:To,captionContainer:Do,captionText:Po,gridLayout:Lo,detailsSection:Fo,loadingContainer:Eo,errorContainer:$o,fullSizeModalOverlay:Ro,fullSizeModalContent:Ao,ratingWarningContent:Oo,ratingWarningTitle:Bo,ratingWarningText:zo,ratingWarningButtons:Uo,carouselContainer:Wo,carouselImageWrapper:Ho,carouselImage:Vo,carouselNavigation:Go,carouselButton:Jo,carouselIndicators:qo,carouselIndicator:Yo,carouselIndicatorActive:Qo,singleImageContainer:Zo,viewImageButtonContainer:Ko};function Xo(){const{mapId:r}=ks(),i=Aa(),{isAuthenticated:v}=lt();console.log("MapDetailsPage: Current URL:",window.location.href),console.log("MapDetailsPage: Hash:",window.location.hash),console.log("MapDetailsPage: mapId from useParams:",r),console.log("MapDetailsPage: mapId type:",typeof r),console.log("MapDetailsPage: mapId length:",r?.length),console.log("MapDetailsPage: mapId value:",JSON.stringify(r));const h=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;if(!r||r==="undefined"||r==="null"||r.trim()===""||!h.test(r))return e.jsx(ga,{children:e.jsxs("div",{className:"flex flex-col items-center gap-4 text-center py-12",children:[e.jsx("div",{className:"text-4xl",children:"⚠️"}),e.jsx("div",{className:"text-xl font-semibold",children:"Invalid Map ID"}),e.jsx("div",{children:"The map ID provided is not valid."}),e.jsxs("div",{className:"text-sm text-gray-500 mt-2",children:['Debug Info: mapId = "',r,'" (type: ',typeof r,")"]}),e.jsx(_,{name:"back-to-explore",variant:"secondary",onClick:()=>i("/explore"),children:"Return to Explore"})]})});const[b,f]=s.useState("mapDetails"),[o,M]=s.useState(null),[G,w]=s.useState(!0),[N,D]=s.useState(null),[se,q]=s.useState([]),[R,re]=s.useState([]),[ye,he]=s.useState([]),[de,je]=s.useState([]),[Ye,be]=s.useState([]),[we,ee]=s.useState(!1),[Ne,I]=s.useState(!1),[pe,ne]=s.useState(!1),[la,He]=s.useState(!1),[ma,Ve]=s.useState(!1),[ea,Ee]=s.useState(!1),[Y,xe]=s.useState(!1),[Ge,Xe]=s.useState("standard"),[Te,ra]=s.useState(80),[Qe,ue]=s.useState(10),[me,$]=s.useState(10),[T,Ca]=s.useState(!0),[ba,na]=s.useState(!0),[d,z]=s.useState(!1),[K,Se]=s.useState(!1),[Re,ia]=s.useState(null),[Ie,aa]=s.useState([]),[$e,Le]=s.useState(0),[ae,oa]=s.useState(!1),{search:O,setSearch:A,srcFilter:X,setSrcFilter:ua,catFilter:Ce,setCatFilter:Ze,regionFilter:P,setRegionFilter:t,countryFilter:a,setCountryFilter:m,imageTypeFilter:l,setImageTypeFilter:c,uploadTypeFilter:u,setUploadTypeFilter:y,showReferenceExamples:ie,setShowReferenceExamples:Ae,clearAllFilters:Oe}=qa(),C=[{key:"explore",label:"List"},{key:"mapDetails",label:"Carousel"}],Fe=s.useCallback(async p=>{if(console.log("fetchMapData called with id:",p),console.log("fetchMapData id type:",typeof p),!p||p==="undefined"||p==="null"||p.trim()===""){console.log("fetchMapData: Invalid ID detected:",p),D("Invalid Map ID"),w(!1);return}if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(p)){console.log("fetchMapData: Invalid UUID format:",p),D("Invalid Map ID format"),w(!1);return}console.log("fetchMapData: Making API call for id:",p),ne(!0),w(!0);try{const oe=await fetch(`/api/images/${p}`);if(!oe.ok)throw new Error("Map not found");const S=await oe.json();if(M(S),S.all_image_ids&&S.all_image_ids.length>1)await Be(S.all_image_ids);else if(S.image_count&&S.image_count>1){console.log("Multi-upload detected but no all_image_ids, trying grouped endpoint");try{const U=await fetch("/api/images/grouped");if(U.ok){const E=(await U.json()).find(H=>H.all_image_ids&&H.all_image_ids.includes(S.image_id));E&&E.all_image_ids?await Be(E.all_image_ids):(aa([S]),Le(0))}else aa([S]),Le(0)}catch(U){console.error("Failed to fetch from grouped endpoint:",U),aa([S]),Le(0)}}else aa([S]),Le(0);await Ma(p)}catch(oe){D(oe instanceof Error?oe.message:"Unknown error occurred")}finally{w(!1),ne(!1)}},[]),Be=s.useCallback(async p=>{console.log("fetchAllImages called with imageIds:",p),oa(!0);try{const B=p.map(async S=>{const U=await fetch(`/api/images/${S}`);if(!U.ok)throw new Error(`Failed to fetch image ${S}`);return U.json()}),oe=await Promise.all(B);aa(oe),Le(0),console.log("fetchAllImages: Loaded",oe.length,"images")}catch(B){console.error("fetchAllImages error:",B),D(B instanceof Error?B.message:"Failed to load all images")}finally{oa(!1)}},[]),ha=s.useCallback(()=>{Ie.length>1&&Le(p=>p>0?p-1:Ie.length-1)},[Ie.length]),pa=s.useCallback(()=>{Ie.length>1&&Le(p=>p<Ie.length-1?p+1:0)},[Ie.length]),_a=s.useCallback(p=>{p>=0&&p<Ie.length&&Le(p)},[Ie.length]),Na=s.useCallback(p=>{const B=p||(Ie.length>0?Ie[$e]:o);B&&(ia(B),Se(!0))},[Ie,$e,o]),Ya=s.useCallback(()=>{Se(!1),ia(null)},[]);s.useEffect(()=>{if(console.log("MapDetailsPage: mapId from useParams:",r),console.log("MapDetailsPage: mapId type:",typeof r),console.log("MapDetailsPage: mapId value:",r),!r||r==="undefined"||r==="null"||r.trim()===""||r===void 0||r===null){console.log("MapDetailsPage: Invalid mapId, setting error"),D("Map ID is required"),w(!1);return}if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(r)){console.log("MapDetailsPage: Invalid UUID format:",r),D("Invalid Map ID format"),w(!1);return}console.log("MapDetailsPage: Fetching data for mapId:",r),Fe(r)},[r,Fe]),s.useEffect(()=>{if(!o||G||d)return;if(!r||r==="undefined"||r==="null"||r.trim()===""){console.log("Auto-navigation skipped: Invalid mapId");return}if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(r)){console.log("Auto-navigation skipped: Invalid mapId format");return}(()=>{const oe=!O||o.title?.toLowerCase().includes(O.toLowerCase())||o.generated?.toLowerCase().includes(O.toLowerCase())||o.source?.toLowerCase().includes(O.toLowerCase())||o.event_type?.toLowerCase().includes(O.toLowerCase()),S=!X||o.source===X,U=!Ce||o.event_type===Ce,F=!P||o.countries.some(ze=>ze.r_code===P),E=!a||o.countries.some(ze=>ze.c_code===a),H=!l||o.image_type===l,L=!ie||o.starred===!0,De=oe&&S&&U&&F&&E&&H&&L;return console.log("Auto-navigation check:",{mapId:r,search:O,srcFilter:X,catFilter:Ce,regionFilter:P,countryFilter:a,imageTypeFilter:l,showReferenceExamples:ie,matchesSearch:oe,matchesSource:S,matchesCategory:U,matchesRegion:F,matchesCountry:E,matchesImageType:H,matchesReferenceExamples:L,matches:De}),De})()||(console.log("Current map does not match filters, looking for first matching item"),fetch("/api/images").then(oe=>oe.json()).then(oe=>{console.log("Auto-navigation: Received images from API:",oe.length),console.log("Auto-navigation: First few images:",oe.slice(0,3).map(U=>({image_id:U.image_id,title:U.title})));const S=oe.find(U=>{const F=!O||U.title?.toLowerCase().includes(O.toLowerCase())||U.generated?.toLowerCase().includes(O.toLowerCase())||U.source?.toLowerCase().includes(O.toLowerCase())||U.event_type?.toLowerCase().includes(O.toLowerCase()),E=!X||U.source===X,H=!Ce||U.event_type===Ce,L=!P||U.countries?.some(Q=>Q.r_code===P),De=!a||U.countries?.some(Q=>Q.c_code===a),ze=!l||U.image_type===l,Je=!ie||U.starred===!0;return F&&E&&H&&L&&De&&ze&&Je});console.log("Auto-navigation: Found first matching image:",S?{image_id:S.image_id,title:S.title,source:S.source}:"No matching image found"),S&&S.image_id&&S.image_id!=="undefined"&&S.image_id!=="null"&&S.image_id.trim()!==""&&S.image_id!==r&&(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(S.image_id)?(console.log("Auto-navigating to:",S.image_id),i(`/map/${S.image_id}`)):console.error("Auto-navigation blocked: Invalid image_id format:",S.image_id))}).catch(console.error))},[o,O,X,Ce,P,a,l,ie,r,i,G,d]);const Ma=async p=>{if(!(!p||p==="undefined"||p==="null"||p.trim()===""))try{const B=await fetch("/api/images/grouped");if(B.ok){const S=(await B.json()).filter(F=>{const E=!O||F.title?.toLowerCase().includes(O.toLowerCase())||F.generated?.toLowerCase().includes(O.toLowerCase())||F.source?.toLowerCase().includes(O.toLowerCase())||F.event_type?.toLowerCase().includes(O.toLowerCase()),H=!X||F.source===X,L=!Ce||F.event_type===Ce,De=!P||F.countries?.some(_e=>_e.r_code===P),ze=!a||F.countries?.some(_e=>_e.c_code===a),Je=!l||F.image_type===l,Q=!u||u==="single"&&(!F.image_count||F.image_count<=1)||u==="multiple"&&F.image_count&&F.image_count>1,Ue=!ie||F.starred===!0;return E&&H&&L&&De&&ze&&Je&&Q&&Ue}),U=S.findIndex(F=>F.image_id===p);ee(S.length>1&&U>0),I(S.length>1&&U<S.length-1)}}catch(B){console.error("Failed to check navigation availability:",B)}},Oa=async p=>{if(!pe){ne(!0);try{const B=await fetch("/api/images/grouped");if(B.ok){const oe=await B.json(),S=oe.filter(L=>{const De=!O||L.title?.toLowerCase().includes(O.toLowerCase())||L.generated?.toLowerCase().includes(O.toLowerCase())||L.source?.toLowerCase().includes(O.toLowerCase())||L.event_type?.toLowerCase().includes(O.toLowerCase()),ze=!X||L.source===X,Je=!Ce||L.event_type===Ce,Q=!P||L.countries?.some(va=>va.r_code===P),Ue=!a||L.countries?.some(va=>va.c_code===a),_e=!l||L.image_type===l,qe=!u||u==="single"&&(!L.image_count||L.image_count<=1)||u==="multiple"&&L.image_count&&L.image_count>1,wa=!ie||L.starred===!0;return De&&ze&&Je&&Q&&Ue&&_e&&qe&&wa});if(S.findIndex(L=>L.image_id===r)===-1){const L=oe.find(De=>De.image_id===r);L&&S.push(L)}const F=S.findIndex(L=>L.image_id===r);if(F===-1){console.error("Current image not found in filtered list");return}let E;p==="previous"?E=F>0?F-1:S.length-1:E=F<S.length-1?F+1:0;const H=S[E];H&&H.image_id&&H.image_id!=="undefined"&&H.image_id!=="null"&&H.image_id.trim()!==""&&(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(H.image_id)?(console.log("Carousel navigating to:",H.image_id),i(`/map/${H.image_id}`)):console.error("Carousel navigation blocked: Invalid image_id format:",H.image_id))}}catch(B){console.error("Failed to navigate to item:",B)}finally{ne(!1)}}};s.useEffect(()=>{o&&r&&!G&&!d&&Ma(r)},[o,r,O,X,Ce,P,a,l,u,ie,G,d,Ma]),s.useEffect(()=>{Promise.all([fetch("/api/sources").then(p=>p.json()),fetch("/api/types").then(p=>p.json()),fetch("/api/image-types").then(p=>p.json()),fetch("/api/regions").then(p=>p.json()),fetch("/api/countries").then(p=>p.json())]).then(([p,B,oe,S,U])=>{q(p),re(B),he(oe),je(S),be(U)}).catch(console.error)},[]);const Ta=async()=>{o&&He(!0)},Qa=async()=>{if(o)try{(await fetch(`/api/images/${o.image_id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({starred:!o.starred})})).ok?M(B=>B?{...B,starred:!B.starred}:null):console.error("Failed to toggle starred status")}catch(p){console.error("Error toggling starred status:",p)}},ka=async()=>{if(o){z(!0);try{if(console.log("Deleting image with ID:",o.image_id),(await fetch(`/api/images/${o.image_id}`,{method:"DELETE"})).ok){M(B=>B?{...B,starred:!B.starred}:null),He(!1);try{const B=await fetch("/api/images/grouped");if(B.ok){const S=(await B.json()).filter(F=>{const E=!O||F.title?.toLowerCase().includes(O.toLowerCase())||F.generated?.toLowerCase().includes(O.toLowerCase())||F.source?.toLowerCase().includes(O.toLowerCase())||F.event_type?.toLowerCase().includes(O.toLowerCase()),H=!X||F.source===X,L=!Ce||F.event_type===Ce,De=!P||F.countries?.some(_e=>_e.r_code===P),ze=!a||F.countries?.some(_e=>_e.c_code===a),Je=!l||F.image_type===l,Q=!u||u==="single"&&(!F.image_count||F.image_count<=1)||u==="multiple"&&F.image_count&&F.image_count>1,Ue=!ie||F.starred===!0;return E&&H&&L&&De&&ze&&Je&&Q&&Ue}),U=S.filter(F=>F.image_id!==o.image_id);if(U.length>0){const F=S.findIndex(H=>H.image_id===o.image_id);let E;if(F===S.length-1?E=F-1:E=F,console.log("Navigation target:",{currentIndex:F,targetIndex:E,targetId:U[E]?.image_id}),E>=0&&E<U.length){const H=U[E];H&&H.image_id&&H.image_id!=="undefined"&&H.image_id!=="null"&&H.image_id.trim()!==""?/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(H.image_id)?(console.log("Navigating to:",H.image_id),i(`/map/${H.image_id}`)):(console.error("Navigation blocked: Invalid image_id format:",H.image_id),i("/explore")):(console.error("Navigation blocked: Invalid image_id:",H?.image_id),i("/explore"))}else U[0]&&U[0].image_id&&U[0].image_id!=="undefined"&&U[0].image_id!=="null"&&U[0].image_id.trim()!==""?/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(U[0].image_id)?(console.log("Fallback navigation to first item:",U[0].image_id),i(`/map/${U[0].image_id}`)):(console.error("Fallback navigation blocked: Invalid image_id format:",U[0].image_id),i("/explore")):(console.log("No valid remaining items, going to explore page"),i("/explore"))}else console.log("No remaining items, going to explore page"),i("/explore")}else i("/explore")}catch(B){console.error("Failed to navigate to next item:",B),i("/explore")}finally{z(!1)}}else console.error("Delete failed"),z(!1)}catch(p){console.error("Delete failed:",p),z(!1)}}},ce=s.useMemo(()=>{if(!o)return null;if(!O&&!X&&!Ce&&!P&&!a&&!l&&!u&&!ie)return o;const p=!O||o.title?.toLowerCase().includes(O.toLowerCase())||o.generated?.toLowerCase().includes(O.toLowerCase())||o.source?.toLowerCase().includes(O.toLowerCase())||o.event_type?.toLowerCase().includes(O.toLowerCase()),B=!X||o.source===X,oe=!Ce||o.event_type===Ce,S=!P||o.countries.some(De=>De.r_code===P),U=!a||o.countries.some(De=>De.c_code===a),F=!l||o.image_type===l,E=!u||u==="single"&&(!o.image_count||o.image_count<=1)||u==="multiple"&&o.image_count&&o.image_count>1,H=!ie||o.starred===!0,L=p&&B&&oe&&S&&U&&F&&E&&H;return!L&&(O||X||Ce||P||a||l||u||ie)?(setTimeout(()=>{Da()},100),o):L?o:null},[o,O,X,Ce,P,a,l,u,ie]),Da=s.useCallback(async()=>{w(!0);try{const p=await fetch("/api/images/grouped");if(p.ok){const oe=(await p.json()).filter(S=>{const U=!O||S.title?.toLowerCase().includes(O.toLowerCase())||S.generated?.toLowerCase().includes(O.toLowerCase())||S.source?.toLowerCase().includes(O.toLowerCase())||S.event_type?.toLowerCase().includes(O.toLowerCase()),F=!X||S.source===X,E=!Ce||S.event_type===Ce,H=!P||S.countries?.some(Q=>Q.r_code===P),L=!a||S.countries?.some(Q=>Q.c_code===a),De=!l||S.image_type===l,ze=!u||u==="single"&&(!S.image_count||S.image_count<=1)||u==="multiple"&&S.image_count&&S.image_count>1,Je=!ie||S.starred===!0;return U&&F&&E&&H&&L&&De&&ze&&Je});if(oe.length>0){const S=oe[0];S&&S.image_id&&i(`/map/${S.image_id}`)}else i("/explore")}}catch(p){console.error("Failed to navigate to matching image:",p),i("/explore")}finally{w(!1)}},[O,X,Ce,P,a,l,u,ie,i]),Za=()=>{if(!o)return;if(!o.all_image_ids||o.all_image_ids.length<=1){const S=`/upload?step=1&contribute=true&imageIds=${[o.image_id].join(",")}`;i(S);return}const B=`/upload?step=1&contribute=true&imageIds=${o.all_image_ids.join(",")}`;i(B)},ca=(p,B)=>({image:`images/${B}`,caption:p.edited||p.generated||"",metadata:{image_id:p.image_count&&p.image_count>1?p.all_image_ids||[p.image_id]:p.image_id,title:p.title,source:p.source,event_type:p.event_type,image_type:p.image_type,countries:p.countries,starred:p.starred,image_count:p.image_count||1}}),Ka=async p=>{if(o){Ee(!0),xe(!1);try{const B=(await Ft(async()=>{const{default:E}=await import("./jszip.min-DF7oyuhK.js").then(H=>H.j);return{default:E}},__vite__mapDeps([0,1,2]))).default,oe=new B;if(o.image_type==="crisis_map"){const E=oe.folder("crisis_maps_dataset"),H=E?.folder("images");if(H)try{const L=o.image_count&&o.image_count>1?o.all_image_ids||[o.image_id]:[o.image_id],De=L.map(async(Q,Ue)=>{try{const _e=await fetch(`/api/images/${Q}/file`);if(!_e.ok)throw new Error(`Failed to fetch image ${Q}`);const qe=await _e.blob(),wa=o.file_key.split(".").pop()||"jpg",va=`0001_${String(Ue+1).padStart(2,"0")}.${wa}`;return H.file(va,qe),{success:!0,fileName:va,imageId:Q}}catch(_e){return console.error(`Failed to process image ${Q}:`,_e),{success:!1,fileName:"",imageId:Q}}}),Je=(await Promise.all(De)).filter(Q=>Q.success);if(Je.length===0)throw new Error("No images could be processed");if(p==="fine-tuning"){const Q=[],Ue=[],_e=[],qe=Je.map(Sa=>`images/${Sa.fileName}`),wa=Math.random(),va={image:qe.length===1?qe[0]:qe,caption:o.edited||o.generated||"",metadata:{image_id:L,title:o.title,source:o.source,event_type:o.event_type,image_type:o.image_type,countries:o.countries,starred:o.starred,image_count:o.image_count||1}};wa<Te/100?Q.push(va):wa<(Te+Qe)/100?Ue.push(va):_e.push(va),E&&(E.file("train.jsonl",JSON.stringify(Q,null,2)),E.file("test.jsonl",JSON.stringify(Ue,null,2)),E.file("val.jsonl",JSON.stringify(_e,null,2)))}else{const Q=Je.map(_e=>`images/${_e.fileName}`),Ue={image:Q.length===1?Q[0]:Q,caption:o.edited||o.generated||"",metadata:{image_id:L,title:o.title,source:o.source,event_type:o.event_type,image_type:o.image_type,countries:o.countries,starred:o.starred,image_count:o.image_count||1}};E&&E.file("0001.json",JSON.stringify(Ue,null,2))}}catch(L){throw console.error(`Failed to process image ${o.image_id}:`,L),L}}else if(o.image_type==="drone_image"){const E=oe.folder("drone_images_dataset"),H=E?.folder("images");if(H)try{const L=await fetch(`/api/images/${o.image_id}/file`);if(!L.ok)throw new Error(`Failed to fetch image ${o.image_id}`);const De=await L.blob(),Je=`0001.${o.file_key.split(".").pop()||"jpg"}`;if(H.file(Je,De),p==="fine-tuning"){const Q=[],Ue=[],_e=[];if(String(o?.image_type)==="crisis_map"){const qe=Math.random();qe<Te/100?Q.push(ca(o,"0001")):qe<(Te+Qe)/100?Ue.push(ca(o,"0001")):_e.push(ca(o,"0001"))}else if(String(o?.image_type)==="drone_image"){const qe=Math.random();qe<Te/100?Q.push(ca(o,"0001")):qe<(Te+Qe)/100?Ue.push(ca(o,"0001")):_e.push(ca(o,"0001"))}E&&(E.file("train.jsonl",JSON.stringify(Q,null,2)),E.file("test.jsonl",JSON.stringify(Ue,null,2)),E.file("val.jsonl",JSON.stringify(_e,null,2)))}else{const Q={image:`images/${Je}`,caption:o.edited||o.generated||"",metadata:{image_id:o.image_count&&o.image_count>1?o.all_image_ids||[o.image_id]:o.image_id,title:o.title,source:o.source,event_type:o.event_type,image_type:o.image_type,countries:o.countries,starred:o.starred,image_count:o.image_count||1}};E&&E.file("0001.json",JSON.stringify(Q,null,2))}}catch(L){throw console.error(`Failed to process image ${o.image_id}:`,L),L}}else{const E=oe.folder("generic_dataset"),H=E?.folder("images");if(H)try{const L=await fetch(`/api/images/${o.image_id}/file`);if(!L.ok)throw new Error(`Failed to fetch image ${o.image_id}`);const De=await L.blob(),Je=`0001.${o.file_key.split(".").pop()||"jpg"}`;if(H.file(Je,De),p==="fine-tuning"){const Q=[],Ue=[],_e=[];if(String(o?.image_type)==="crisis_map"){const qe=Math.random();qe<Te/100?Q.push(ca(o,"0001")):qe<(Te+Qe)/100?Ue.push(ca(o,"0001")):_e.push(ca(o,"0001"))}else if(String(o?.image_type)==="drone_image"){const qe=Math.random();qe<Te/100?Q.push(ca(o,"0001")):qe<(Te+Qe)/100?Ue.push(ca(o,"0001")):_e.push(ca(o,"0001"))}E&&(E.file("train.jsonl",JSON.stringify(Q,null,2)),E.file("test.jsonl",JSON.stringify(Ue,null,2)),E.file("val.jsonl",JSON.stringify(_e,null,2)))}else{const Q={image:`images/${Je}`,caption:o.edited||o.generated||"",metadata:{image_id:o.image_count&&o.image_count>1?o.all_image_ids||[o.image_id]:o.image_id,title:o.title,source:o.source,event_type:o.event_type,image_type:o.image_type,countries:o.countries,starred:o.starred,image_count:o.image_count||1}};E&&E.file("0001.json",JSON.stringify(Q,null,2))}}catch(L){throw console.error(`Failed to process image ${o.image_id}:`,L),L}}const S=await oe.generateAsync({type:"blob"}),U=URL.createObjectURL(S),F=document.createElement("a");F.href=U,F.download=`dataset_${o.image_type}_${o.image_id}_${p}_${new Date().toISOString().split("T")[0]}.zip`,document.body.appendChild(F),F.click(),document.body.removeChild(F),URL.revokeObjectURL(U),console.log(`Exported ${o.image_type} dataset with 1 image in ${p} mode`),xe(!0)}catch(B){console.error("Export failed:",B),alert("Failed to export dataset. Please try again.")}finally{Ee(!1)}}};return G?e.jsx(ga,{children:e.jsx("div",{className:le.loadingContainer,children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx(ja,{className:"text-ifrcRed"}),e.jsx("div",{children:"Loading map details..."})]})})}):N||!o?e.jsx(ga,{children:e.jsx("div",{className:le.errorContainer,children:e.jsxs("div",{className:"flex flex-col items-center gap-4 text-center",children:[e.jsx("div",{className:"text-4xl",children:"⚠️"}),e.jsx("div",{className:"text-xl font-semibold",children:"Unable to load map"}),e.jsx("div",{children:N||"Map not found"}),e.jsx(_,{name:"back-to-explore",variant:"secondary",onClick:()=>i("/explore"),children:"Return to Explore"})]})})}):e.jsxs(ga,{children:[e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:le.tabSelector,children:[e.jsx($a,{name:"map-details-view",value:b,onChange:p=>{(p==="mapDetails"||p==="explore")&&(f(p),p==="explore"&&i("/explore"))},options:C,keySelector:p=>p.key,labelSelector:p=>p.label}),e.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[e.jsx(J,{withInternalPadding:!0,className:"bg-white/20 backdrop-blur-sm rounded-md p-2",children:e.jsxs(_,{name:"reference-examples",variant:ie?"primary":"secondary",onClick:()=>Ae(!ie),className:"whitespace-nowrap",children:[e.jsx("span",{className:"mr-2",children:ie?e.jsx("span",{className:"text-yellow-400",children:"★"}):e.jsx("span",{className:"text-yellow-400",children:"☆"})}),"Reference Examples"]})}),e.jsx(_,{name:"export-dataset",variant:"secondary",onClick:()=>Ve(!0),children:"Export"})]})]}),e.jsx(Dt,{sources:se,types:R,regions:de,countries:Ye,imageTypes:ye,isLoadingFilters:!1}),b==="mapDetails"?e.jsx("div",{className:"relative",children:ce?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:le.gridLayout,children:[e.jsxs(J,{heading:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:ce.title||"Map Image"}),ce.starred&&e.jsx("span",{className:"text-red-500 text-xl",title:"Starred image",children:"★"})]}),headingLevel:2,withHeaderBorder:!0,withInternalPadding:!0,spacing:"comfortable",children:[e.jsx("div",{className:le.imageContainer,children:o?.image_count&&o.image_count>1||Ie.length>1?e.jsxs("div",{className:le.carouselContainer,children:[e.jsx("div",{className:le.carouselImageWrapper,children:ae?e.jsxs("div",{className:le.imagePlaceholder,children:[e.jsx(ja,{className:"text-ifrcRed"}),e.jsx("div",{children:"Loading images..."})]}):Ie[$e]?.image_url?e.jsx("img",{src:Ie[$e].image_url,alt:Ie[$e].file_key,className:le.carouselImage}):e.jsx("div",{className:le.imagePlaceholder,children:"No image available"})}),e.jsxs("div",{className:le.carouselNavigation,children:[e.jsx(_,{name:"previous-image",variant:"tertiary",size:1,onClick:ha,disabled:ae,className:le.carouselButton,children:e.jsx(Ga,{className:"w-4 h-4"})}),e.jsx("div",{className:le.carouselIndicators,children:Ie.map((p,B)=>e.jsx("button",{onClick:()=>_a(B),className:`${le.carouselIndicator} ${B===$e?le.carouselIndicatorActive:""}`,disabled:ae,children:B+1},B))}),e.jsx(_,{name:"next-image",variant:"tertiary",size:1,onClick:pa,disabled:ae,className:le.carouselButton,children:e.jsx(Ja,{className:"w-4 h-4"})})]}),e.jsx("div",{className:le.viewImageButtonContainer,children:e.jsx(_,{name:"view-full-size-carousel",variant:"secondary",size:1,onClick:()=>Na(Ie[$e]),disabled:ae||!Ie[$e]?.image_url,children:"View Image"})})]}):e.jsxs("div",{className:le.singleImageContainer,children:[ce.image_url?e.jsx("img",{src:ce.image_url,alt:ce.file_key}):e.jsx("div",{className:le.imagePlaceholder,children:"No image available"}),e.jsx("div",{className:le.viewImageButtonContainer,children:e.jsx(_,{name:"view-full-size-single",variant:"secondary",size:1,onClick:()=>Na(ce),disabled:!ce.image_url,children:"View Image"})})]})}),e.jsx(J,{withInternalPadding:!0,className:"bg-white/20 backdrop-blur-sm rounded-md p-2",children:e.jsxs("div",{className:le.metadataTags,children:[ce.image_type!=="drone_image"&&e.jsx("span",{className:le.metadataTag,children:se.find(p=>p.s_code===ce.source)?.label||ce.source}),e.jsx("span",{className:le.metadataTag,children:R.find(p=>p.t_code===ce.event_type)?.label||ce.event_type}),e.jsx("span",{className:le.metadataTag,children:ye.find(p=>p.image_type===ce.image_type)?.label||ce.image_type}),ce.countries&&ce.countries.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:le.metadataTag,children:de.find(p=>p.r_code===ce.countries[0].r_code)?.label||"Unknown Region"}),e.jsx("span",{className:le.metadataTag,children:ce.countries.map(p=>p.label).join(", ")})]}),ce.image_count&&ce.image_count>1&&e.jsxs("span",{className:le.metadataTag,title:`Multi-upload with ${ce.image_count} images`,children:["📷 ",ce.image_count]}),(!ce.image_count||ce.image_count<=1)&&e.jsx("span",{className:le.metadataTag,title:"Single Upload",children:"Single"})]})})]}),e.jsx("div",{className:le.detailsSection,children:ce.edited&&ce.edited.includes("Description:")||ce.generated&&ce.generated.includes("Description:")?e.jsx(J,{heading:"AI Generated Content",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,spacing:"comfortable",children:e.jsx("div",{className:le.captionContainer,children:e.jsx("div",{className:le.captionText,children:(ce.edited||ce.generated||"").split(`
`).map((p,B)=>e.jsx("div",{children:p.startsWith("Description:")||p.startsWith("Analysis:")||p.startsWith("Recommended Actions:")?e.jsx("h4",{className:"font-semibold text-gray-800 mt-4 mb-2",children:p}):p.trim()===""?e.jsx("br",{}):e.jsx("p",{className:"mb-2",children:p})},B))})})}):e.jsx(J,{heading:"Description",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,spacing:"comfortable",children:e.jsx("div",{className:le.captionContainer,children:ce.generated?e.jsx("div",{className:le.captionText,children:e.jsx("p",{children:ce.edited||ce.generated})}):e.jsx("p",{children:"— no caption yet —"})})})})]}),e.jsx("div",{className:"flex items-center justify-center mt-8",children:e.jsx(J,{withInternalPadding:!0,className:"bg-white/20 backdrop-blur-sm rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[we&&e.jsx(J,{withInternalPadding:!0,className:"rounded-md p-2",children:e.jsx(_,{name:"previous-item",variant:"tertiary",size:1,className:`bg-white/90 hover:bg-white shadow-lg border border-gray-200 ${pe?"opacity-50 cursor-not-allowed":"hover:scale-110"}`,onClick:()=>Oa("previous"),disabled:pe,children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("div",{className:"flex -space-x-1",children:[e.jsx(Ga,{className:"w-4 h-4"}),e.jsx(Ga,{className:"w-4 h-4"})]}),e.jsx("span",{className:"font-semibold",children:"Previous"})]})})}),v&&e.jsx(J,{withInternalPadding:!0,className:"rounded-md p-2",children:e.jsx(_,{name:"delete",variant:"tertiary",size:1,className:"bg-red-50 hover:bg-red-100 text-red-700 border border-red-200 hover:border-red-300",onClick:Ta,title:"Delete","aria-label":"Delete saved image",children:e.jsx(Ra,{className:"w-4 h-4"})})}),e.jsx(J,{withInternalPadding:!0,className:"rounded-md p-2",children:e.jsx(_,{name:"contribute",onClick:Za,children:"Contribute"})}),v&&e.jsx(J,{withInternalPadding:!0,className:"rounded-md p-2",children:e.jsx(_,{name:"toggle-star",variant:"tertiary",size:1,className:`${o?.starred?"bg-red-100 hover:bg-red-200 text-red-800 border-2 border-red-400":"bg-gray-100 hover:bg-gray-200 text-gray-600 border-2 border-gray-300"} w-16 h-8 rounded-full transition-all duration-200 flex items-center justify-center`,onClick:Qa,title:o?.starred?"Unstar image":"Star image","aria-label":o?.starred?"Unstar image":"Star image",children:e.jsx("span",{className:`text-lg transition-all duration-200 ${o?.starred?"text-red-600":"text-gray-500"}`,children:o?.starred?"★":"☆"})})}),Ne&&e.jsx(J,{withInternalPadding:!0,className:"rounded-md p-2",children:e.jsx(_,{name:"next-item",variant:"tertiary",size:1,className:`bg-white/90 hover:bg-white shadow-lg border border-gray-200 ${pe?"opacity-50 cursor-not-allowed":"hover:scale-110"}`,onClick:()=>Oa("next"),disabled:pe,children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"font-semibold",children:"Next"}),e.jsxs("div",{className:"flex -space-x-1",children:[e.jsx(Ja,{className:"w-4 h-4"}),e.jsx(Ja,{className:"w-4 h-4"})]})]})})})]})})})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-xl font-semibold text-gray-600 mb-4",children:"No matches found"}),e.jsx("div",{className:"mt-4",children:e.jsx(_,{name:"clear-filters",variant:"secondary",onClick:Oe,children:"Clear Filters"})})]})}):null]}),la&&e.jsx("div",{className:le.fullSizeModalOverlay,onClick:()=>He(!1),children:e.jsx("div",{className:le.fullSizeModalContent,onClick:p=>p.stopPropagation(),children:e.jsxs("div",{className:le.ratingWarningContent,children:[e.jsx("h3",{className:le.ratingWarningTitle,children:"Delete Image?"}),e.jsx("p",{className:le.ratingWarningText,children:"This action cannot be undone. Are you sure you want to delete this saved image and all related data?"}),e.jsxs("div",{className:le.ratingWarningButtons,children:[e.jsx(_,{name:"confirm-delete",variant:"secondary",onClick:ka,children:"Delete"}),e.jsx(_,{name:"cancel-delete",variant:"tertiary",onClick:()=>He(!1),children:"Cancel"})]})]})})}),ma&&e.jsx(Pt,{isOpen:ma,onClose:()=>{Ve(!1),xe(!1),Ee(!1)},onExport:(p,B)=>{B.includes(o.image_type)&&Ka(p)},filteredCount:1,totalCount:1,hasFilters:!1,crisisMapsCount:o.image_type==="crisis_map"?1:0,droneImagesCount:o.image_type==="drone_image"?1:0,isLoading:ea,exportSuccess:Y,variant:"single",onNavigateToList:()=>{Ve(!1),i("/explore")},onNavigateAndExport:()=>{Ve(!1),i("/explore?export=true")}}),e.jsx(Lt,{isOpen:K,imageUrl:Re?.image_url||null,preview:null,selectedImageData:null,onClose:Ya})]})}const el="_adminContainer_j11pf_5",al="_adminHeader_j11pf_13",tl="_adminSection_j11pf_20",sl="_modelSelectionArea_j11pf_29",nl="_modelSelectionRow_j11pf_36",il="_modelsTable_j11pf_89",ol="_promptSubsection_j11pf_97",ll="_promptSubsectionTitle_j11pf_109",rl="_modelCode_j11pf_152",cl="_modelId_j11pf_157",dl="_modelActions_j11pf_163",ml="_addModelButtonContainer_j11pf_169",ul="_addModelForm_j11pf_177",gl="_addModelFormTitle_j11pf_185",hl="_addModelFormGrid_j11pf_193",pl="_addModelFormField_j11pf_206",fl="_addModelFormCheckbox_j11pf_250",xl="_addModelFormActions_j11pf_268",_l="_modalOverlay_j11pf_277",vl="_modalContent_j11pf_291",yl="_modalBody_j11pf_302",jl="_modalTitle_j11pf_312",Cl="_modalText_j11pf_320",bl="_modalTextLeft_j11pf_332",wl="_modalButtons_j11pf_355",Nl="_modalForm_j11pf_363",Sl="_formField_j11pf_372",Il="_formLabel_j11pf_376",Ml="_formInput_j11pf_385",kl="_textarea_j11pf_407",x={adminContainer:el,adminHeader:al,adminSection:tl,modelSelectionArea:sl,modelSelectionRow:nl,modelsTable:il,promptSubsection:ol,promptSubsectionTitle:ll,modelCode:rl,modelId:cl,modelActions:dl,addModelButtonContainer:ml,addModelForm:ul,addModelFormTitle:gl,addModelFormGrid:hl,addModelFormField:pl,addModelFormCheckbox:fl,addModelFormActions:xl,modalOverlay:_l,modalContent:vl,modalBody:yl,modalTitle:jl,modalText:Cl,modalTextLeft:bl,modalButtons:wl,modalForm:Nl,formField:Sl,formLabel:Il,formInput:Ml,textarea:kl},Va="selectedVlmModel";function Tl(){const{isAuthenticated:r,isLoading:i,login:v,logout:h}=lt(),[b,f]=s.useState(""),[o,M]=s.useState(""),[G,w]=s.useState(!1),[N,D]=s.useState([]),[se,q]=s.useState(""),[R,re]=s.useState([]),[ye,he]=s.useState([]),[de,je]=s.useState(!1),[Ye,be]=s.useState(!1),[we,ee]=s.useState(null),[Ne,I]=s.useState(null),[pe,ne]=s.useState({p_code:"",label:"",metadata_instructions:"",image_type:"crisis_map",is_active:!1}),[la,He]=s.useState(!1),[ma,Ve]=s.useState(!1),[ea,Ee]=s.useState(null),[Y,xe]=s.useState({m_code:"",label:"",model_type:"custom",provider:"huggingface",model_id:"",is_available:!1}),[Ge,Xe]=s.useState(!1),[Te,ra]=s.useState(!1),[Qe,ue]=s.useState(!1),[me,$]=s.useState(""),[T,Ca]=s.useState(""),[ba,na]=s.useState(""),[d,z]=s.useState(""),K=s.useCallback(()=>{fetch("/api/models").then(t=>t.json()).then(t=>{console.log("Models data received:",t),D(t.models||[]);const a=localStorage.getItem(Va);if(t.models&&t.models.length>0)if(a==="random")q("random");else if(a&&t.models.find(m=>m.m_code===a&&m.is_available))q(a);else{const m=t.models.find(l=>l.is_available)||t.models[0];q(m.m_code),localStorage.setItem(Va,m.m_code)}}).catch(()=>{})},[]),Se=s.useCallback(()=>{console.log("=== fetchPrompts called ==="),fetch("/api/prompts").then(t=>t.json()).then(t=>{console.log("Prompts data received:",t),re(t||[]),console.log("State update triggered with:",t||[])}).catch(t=>{console.error("Error fetching prompts:",t)})},[]),Re=s.useCallback(()=>{fetch("/api/image-types").then(t=>t.json()).then(t=>{console.log("Image types data received:",t),he(t||[])}).catch(()=>{})},[]);s.useEffect(()=>{r&&(K(),Se(),Re())},[r,K,Se,Re]);const ia=t=>{I(t),ne({p_code:t.p_code,label:t.label||"",metadata_instructions:t.metadata_instructions||"",image_type:t.image_type||"crisis_map",is_active:t.is_active||!1}),je(!0)},Ie=async()=>{try{if(!Ne){alert("No prompt selected for editing");return}const t=await fetch(`/api/prompts/${Ne.p_code}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({label:pe.label,metadata_instructions:pe.metadata_instructions,image_type:pe.image_type,is_active:pe.is_active})});if(t.ok)Se(),je(!1),I(null),ne({p_code:"",label:"",metadata_instructions:"",image_type:"crisis_map",is_active:!1});else{const a=await t.json();alert(`Failed to update prompt: ${a.error||"Unknown error"}`)}}catch{alert("Error updating prompt")}},aa=async(t,a)=>{try{const m=await fetch(`/api/prompts/${t}/toggle-active?image_type=${a}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(m.ok)Se();else{const l=await m.json();alert(`Failed to toggle prompt active status: ${l.detail||"Unknown error"}`)}}catch{alert("Error toggling prompt active status")}},$e=t=>{ee(t),ne({p_code:"",label:"",metadata_instructions:"",image_type:t,is_active:!1}),be(!0)},Le=async()=>{try{const t=await fetch("/api/prompts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(pe)});if(t.ok)Se(),be(!1),ee(null),ne({p_code:"",label:"",metadata_instructions:"",image_type:"crisis_map",is_active:!1});else{const a=await t.json();alert(`Failed to create prompt: ${a.detail||"Unknown error"}`)}}catch{alert("Error creating prompt")}},ae=async(t,a)=>{try{const m=await fetch(`/api/models/${t}/toggle`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({is_available:!a})});if(m.ok)D(l=>l.map(c=>c.m_code===t?{...c,is_available:!a}:c));else{const l=await m.json();alert(`Failed to toggle model availability: ${l.error||"Unknown error"}`)}}catch{alert("Error toggling model availability")}},oa=t=>{q(t),t==="random"?localStorage.setItem(Va,"random"):localStorage.setItem(Va,t)},O=async()=>{try{const t=await fetch("/api/admin/models",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("adminToken")}`},body:JSON.stringify(Y)});if(t.ok){const a=`
Model "${Y.label}" added successfully!

⚠️  IMPORTANT: Model will NOT work until you complete these steps:

1. 🔑 Ensure API key is set and valid.

2. 📝 Verify model_id format.

3. 📚 Check model specific documentation for details.
        `;Ca(a),ra(!0),He(!1),xe({m_code:"",label:"",model_type:"custom",provider:"huggingface",model_id:"",is_available:!1}),K()}else{const a=await t.json();alert(`Failed to add model: ${a.detail||"Unknown error"}`)}}catch{alert("Error adding model")}},A=t=>{Ee(t),xe({m_code:t.m_code,label:t.label,model_type:t.model_type||"custom",provider:t.provider||t.config?.provider||"huggingface",model_id:t.model_id||t.config?.model_id||t.m_code,is_available:t.is_available}),Ve(!0)},X=async()=>{try{console.log("Updating model with data:",Y);const t={label:Y.label,model_type:Y.model_type,provider:Y.provider,model_id:Y.model_id,is_available:Y.is_available};if(console.log("Update payload:",t),!ea){alert("No model selected for editing");return}const a=await fetch(`/api/admin/models/${ea.m_code}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("adminToken")}`},body:JSON.stringify(t)});if(console.log("Update response status:",a.status),a.ok){const m=await a.json();console.log("Update successful:",m),Ve(!1),Ee(null),xe({m_code:"",label:"",model_type:"custom",provider:"huggingface",model_id:"",is_available:!1}),console.log("Refreshing models..."),K()}else{const m=await a.json();console.error("Update failed:",m),alert(`Failed to update model: ${m.detail||"Unknown error"}`)}}catch(t){console.error("Update error:",t),alert("Error updating model")}},ua=async t=>{$(t),Xe(!0)},Ce=async()=>{try{const t=await fetch(`/api/admin/models/${me}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("adminToken")}`}});if(t.ok)Xe(!1),$(""),K();else{const a=await t.json();alert(`Failed to delete model: ${a.detail||"Unknown error"}`)}}catch{alert("Error deleting model")}},Ze=async t=>{if(t.preventDefault(),!b.trim()){M("Please enter a password");return}w(!0),M("");try{await v(b)||M("Invalid password")}catch{M("Login failed. Please try again.")}finally{w(!1)}},P=()=>{h(),f(""),M("")};return i?e.jsx(ga,{children:e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-ifrcRed mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading..."})]})})}):r?e.jsxs(ga,{children:[e.jsxs("div",{className:x.adminContainer,children:[e.jsx("div",{className:x.adminHeader,children:e.jsx(_,{name:"logout",variant:"secondary",onClick:P,children:"Logout"})}),e.jsxs("div",{className:x.adminSection,children:[e.jsx(J,{heading:"VLM Model Selection",headingLevel:2,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsxs("div",{className:x.modelSelectionArea,children:[e.jsx("p",{className:"text-gray-700",children:"Select which Vision Language Model to use for caption generation."}),e.jsx("div",{className:x.modelSelectionRow,children:e.jsx(da,{label:"Model",name:"selected-model",value:se,onChange:t=>oa(t||""),options:[{value:"random",label:"Random"},...N.filter(t=>t.is_available).map(t=>({value:t.m_code,label:t.label}))],keySelector:t=>t.value,labelSelector:t=>t.label})})]})}),e.jsx(J,{heading:"Model Management",headingLevel:2,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsxs("div",{className:x.modelManagementArea,children:[e.jsx("div",{className:x.modelsTable,children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Code"}),e.jsx("th",{children:"Label"}),e.jsx("th",{children:"Provider"}),e.jsx("th",{children:"Model ID"}),e.jsx("th",{children:"Available"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:N.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:x.modelCode,children:t.m_code}),e.jsx("td",{children:t.label}),e.jsx("td",{children:t.provider||t.config?.provider||"huggingface"}),e.jsx("td",{className:x.modelId,children:t.model_id||t.config?.model_id||t.m_code||"N/A"}),e.jsx("td",{children:e.jsx(_,{name:`toggle-${t.m_code}`,variant:t.is_available?"primary":"secondary",size:1,onClick:()=>ae(t.m_code,t.is_available),children:t.is_available?"Enabled":"Disabled"})}),e.jsx("td",{children:e.jsxs("div",{className:x.modelActions,children:[e.jsx(_,{name:`edit-${t.m_code}`,variant:"secondary",size:1,onClick:()=>A(t),children:"Edit"}),e.jsx(_,{name:`delete-${t.m_code}`,variant:"secondary",size:1,onClick:()=>ua(t.m_code),children:"Delete"})]})})]},t.m_code))})]})}),!la&&e.jsx("div",{className:x.addModelButtonContainer,children:e.jsx(_,{name:"show-add-form",variant:"primary",onClick:()=>He(!0),children:"Add New Model"})}),la&&e.jsxs("div",{className:x.addModelForm,children:[e.jsx("h4",{className:x.addModelFormTitle,children:"Add New Model"}),e.jsxs("div",{className:x.addModelFormGrid,children:[e.jsx("div",{className:x.addModelFormField,children:e.jsx(ge,{label:"Model Code",name:"model-code",value:Y.m_code,onChange:t=>xe({...Y,m_code:t||""}),placeholder:"e.g., NEW_MODEL_123"})}),e.jsx("div",{className:x.addModelFormField,children:e.jsx(ge,{label:"Label",name:"model-label",value:Y.label,onChange:t=>xe({...Y,label:t||""}),placeholder:"e.g., New Model Name"})}),e.jsx("div",{className:x.addModelFormField,children:e.jsx(da,{label:"Provider",name:"model-provider",value:Y.provider,onChange:t=>xe({...Y,provider:t||"huggingface"}),options:[{value:"huggingface",label:"HuggingFace"},{value:"openai",label:"OpenAI"},{value:"google",label:"Google"}],keySelector:t=>t.value,labelSelector:t=>t.label})}),e.jsx("div",{className:x.addModelFormField,children:e.jsx(ge,{label:"Model ID",name:"model-id",value:Y.model_id,onChange:t=>xe({...Y,model_id:t||""}),placeholder:"e.g., org/model-name"})}),e.jsx("div",{className:x.addModelFormField,children:e.jsxs("div",{className:x.addModelFormCheckbox,children:[e.jsx("input",{type:"checkbox",checked:Y.is_available,onChange:t=>xe({...Y,is_available:t.target.checked})}),e.jsx("span",{children:"Available for use"})]})})]}),e.jsxs("div",{className:x.addModelFormActions,children:[e.jsx(_,{name:"save-model",variant:"primary",onClick:O,disabled:!Y.m_code||!Y.label||!Y.model_id,children:"Save Model"}),e.jsx(_,{name:"cancel-add",variant:"secondary",onClick:()=>He(!1),children:"Cancel"})]})]}),ma&&e.jsxs("div",{className:x.addModelForm,children:[e.jsxs("h4",{className:x.addModelFormTitle,children:["Edit Model: ",ea?.label]}),e.jsxs("div",{className:x.addModelFormGrid,children:[e.jsx("div",{className:x.addModelFormField,children:e.jsx(ge,{label:"Model Code",name:"model-code",value:Y.m_code,onChange:t=>xe({...Y,m_code:t||""}),placeholder:"e.g., NEW_MODEL_123",disabled:!0})}),e.jsx("div",{className:x.addModelFormField,children:e.jsx(ge,{label:"Label",name:"model-label",value:Y.label,onChange:t=>xe({...Y,label:t||""}),placeholder:"e.g., New Model Name"})}),e.jsx("div",{className:x.addModelFormField,children:e.jsx(da,{label:"Provider",name:"model-provider",value:Y.provider,onChange:t=>xe({...Y,provider:t||"huggingface"}),options:[{value:"huggingface",label:"HuggingFace"},{value:"openai",label:"OpenAI"},{value:"google",label:"Google"}],keySelector:t=>t.value,labelSelector:t=>t.label})}),e.jsx("div",{className:x.addModelFormField,children:e.jsx(ge,{label:"Model ID",name:"model-id",value:Y.model_id,onChange:t=>xe({...Y,model_id:t||""}),placeholder:"e.g., org/model-name"})}),e.jsx("div",{className:x.addModelFormField,children:e.jsxs("div",{className:x.addModelFormCheckbox,children:[e.jsx("input",{type:"checkbox",checked:Y.is_available,onChange:t=>xe({...Y,is_available:t.target.checked})}),e.jsx("span",{children:"Available for use"})]})})]}),e.jsxs("div",{className:x.addModelFormActions,children:[e.jsx(_,{name:"update-model",variant:"primary",onClick:X,disabled:!Y.m_code||!Y.label||!Y.model_id,children:"Update Model"}),e.jsx(_,{name:"cancel-edit",variant:"secondary",onClick:()=>{Ve(!1),Ee(null),xe({m_code:"",label:"",model_type:"custom",provider:"huggingface",model_id:"",is_available:!1})},children:"Cancel"})]})]})]})}),e.jsx(J,{heading:"Prompt Management",headingLevel:2,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsxs("div",{className:x.modelManagementArea,children:[e.jsxs("div",{className:x.promptSubsection,children:[e.jsx("h4",{className:x.promptSubsectionTitle,children:"Crisis Maps"}),e.jsx("div",{className:x.modelsTable,children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Code"}),e.jsx("th",{children:"Label"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:R.filter(t=>t.image_type==="crisis_map").sort((t,a)=>t.p_code.localeCompare(a.p_code)).map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:x.modelCode,children:t.p_code}),e.jsx("td",{className:x.promptLabel,children:t.label||"No label"}),e.jsx("td",{children:e.jsx(_,{name:`toggle-crisis-${t.p_code}`,variant:t.is_active?"primary":"secondary",size:1,onClick:()=>aa(t.p_code,"crisis_map"),children:t.is_active?"Active":"Inactive"})}),e.jsx("td",{children:e.jsxs("div",{className:x.modelActions,children:[e.jsx(_,{name:`view-${t.p_code}`,variant:"secondary",size:1,onClick:()=>{na(`=== Prompt Details ===
Code: ${t.p_code}
Label: ${t.label}
Image Type: ${t.image_type}
Active: ${t.is_active}

Metadata Instructions:
${t.metadata_instructions||"No instructions available"}`),z(`Prompt: ${t.p_code}`),ue(!0)},children:"View"}),e.jsx(_,{name:`edit-${t.p_code}`,variant:"secondary",size:1,onClick:()=>ia(t),children:"Edit"})]})})]},t.p_code))})]})}),e.jsx("div",{className:x.addModelButtonContainer,children:e.jsx(_,{name:"add-crisis-prompt",variant:"primary",onClick:()=>$e("crisis_map"),children:"Add New Crisis Map Prompt"})})]}),e.jsxs("div",{className:x.promptSubsection,children:[e.jsx("h4",{className:x.promptSubsectionTitle,children:"Drone Images"}),e.jsx("div",{className:x.modelsTable,children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Code"}),e.jsx("th",{children:"Label"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:R.filter(t=>t.image_type==="drone_image").sort((t,a)=>t.p_code.localeCompare(a.p_code)).map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:x.modelCode,children:t.p_code}),e.jsx("td",{className:x.promptLabel,children:t.label||"No label"}),e.jsx("td",{children:e.jsx(_,{name:`toggle-drone-${t.p_code}`,variant:t.is_active?"primary":"secondary",size:1,onClick:()=>aa(t.p_code,"drone_image"),children:t.is_active?"Active":"Inactive"})}),e.jsx("td",{children:e.jsxs("div",{className:x.modelActions,children:[e.jsx(_,{name:`view-${t.p_code}`,variant:"secondary",size:1,onClick:()=>{na(`=== Prompt Details ===
Code: ${t.p_code}
Label: ${t.label}
Image Type: ${t.image_type}
Active: ${t.is_active}

Metadata Instructions:
${t.metadata_instructions||"No instructions available"}`),z(`Prompt: ${t.p_code}`),ue(!0)},children:"View"}),e.jsx(_,{name:`edit-${t.p_code}`,variant:"secondary",size:1,onClick:()=>ia(t),children:"Edit"})]})})]},t.p_code))})]})}),e.jsx("div",{className:x.addModelButtonContainer,children:e.jsx(_,{name:"add-drone-prompt",variant:"primary",onClick:()=>$e("drone_image"),children:"Add New Drone Image Prompt"})})]})]})}),e.jsx(J,{heading:"Utilities",headingLevel:2,withHeaderBorder:!0,withInternalPadding:!0,children:e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsx(_,{name:"test-connection",variant:"secondary",onClick:async()=>{na("Testing API connection..."),z("Connection Test Results");try{const t=await fetch("/api/models");if(t.ok){const a=await t.json(),m=`✅ API connection successful!

Found ${a.models?.length||0} models in database.

Available models:
${a.models?.filter(l=>l.is_available).map(l=>`- ${l.label} (${l.m_code})`).join(`
`)||"None"}`;na(m)}else{const a=`❌ API connection failed: HTTP ${t.status}`;na(a)}ue(!0)}catch(t){const a=`❌ Connection error: ${t}`;na(a),ue(!0)}},children:"Test Connection"}),e.jsx(_,{name:"view-schemas",variant:"secondary",onClick:()=>{fetch("/api/schemas",{headers:{Authorization:`Bearer ${localStorage.getItem("adminToken")}`}}).then(t=>t.json()).then(t=>{console.log("Schemas Response:",t);let a="",m="Schemas Response";t&&Array.isArray(t)?(a=`Found ${t.length} schemas:

`,t.forEach((l,c)=>{a+=`=== Schema ${c+1} ===
`,a+=JSON.stringify(l,null,2),a+=`

`})):t&&typeof t=="object"?a=`Prompts Response:

Response type: ${typeof t}
Keys: ${Object.keys(t).join(", ")}

Raw data:
${JSON.stringify(t,null,2)}`:a=`Prompts Response:

Unexpected data type: ${typeof t}
Value: ${t}`,na(a),z(m),ue(!0)}).catch(t=>{console.error("Schemas Error:",t);const a=`Failed to fetch prompts: ${t.message||"Unknown error"}`;na(a),z("Schemas Error"),ue(!0)})},children:"View Schemas"})]})})]})]}),Ge&&e.jsx("div",{className:x.modalOverlay,onClick:()=>Xe(!1),children:e.jsx("div",{className:x.modalContent,onClick:t=>t.stopPropagation(),children:e.jsxs("div",{className:x.modalBody,children:[e.jsx("h3",{className:x.modalTitle,children:"Delete Model"}),e.jsxs("p",{className:x.modalText,children:["Are you sure you want to delete model ",e.jsx("span",{className:x.modelCode,children:me}),"? This action cannot be undone."]}),e.jsxs("div",{className:x.modalButtons,children:[e.jsx(_,{name:"cancel-delete",variant:"tertiary",onClick:()=>Xe(!1),children:"Cancel"}),e.jsx(_,{name:"confirm-delete",variant:"secondary",onClick:Ce,children:"Delete"})]})]})})}),Te&&e.jsx("div",{className:x.modalOverlay,onClick:()=>ra(!1),children:e.jsx("div",{className:x.modalContent,onClick:t=>t.stopPropagation(),children:e.jsxs("div",{className:x.modalBody,children:[e.jsx("h3",{className:x.modalTitle,children:"Model Added Successfully!"}),e.jsx("div",{className:`${x.modalText} ${x.modalTextLeft}`,children:T}),e.jsx("div",{className:x.modalButtons,children:e.jsx(_,{name:"close-setup-instructions",variant:"secondary",onClick:()=>ra(!1),children:"Got it!"})})]})})}),Qe&&e.jsx("div",{className:x.modalOverlay,onClick:()=>ue(!1),children:e.jsx("div",{className:x.modalContent,onClick:t=>t.stopPropagation(),children:e.jsxs("div",{className:x.modalBody,children:[e.jsx("h3",{className:x.modalTitle,children:d}),e.jsx("div",{className:`${x.modalText} ${x.modalTextLeft}`,children:e.jsx("div",{className:"whitespace-pre-wrap font-mono text-sm leading-relaxed",children:ba})}),e.jsx("div",{className:x.modalButtons,children:e.jsx(_,{name:"close-test-results",variant:"secondary",onClick:()=>ue(!1),children:"Close"})})]})})}),de&&e.jsx("div",{className:x.modalOverlay,onClick:()=>je(!1),children:e.jsx("div",{className:x.modalContent,onClick:t=>t.stopPropagation(),children:e.jsxs("div",{className:x.modalBody,children:[e.jsxs("h3",{className:x.modalTitle,children:["Edit Prompt: ",Ne?.p_code]}),e.jsxs("div",{className:x.modalForm,children:[e.jsxs("div",{className:x.formField,children:[e.jsx("label",{className:x.formLabel,children:"Code:"}),e.jsx(ge,{name:"prompt-code",value:Ne?.p_code,onChange:()=>{},disabled:!0,className:x.formInput})]}),e.jsxs("div",{className:x.formField,children:[e.jsx("label",{className:x.formLabel,children:"Label:"}),e.jsx(ge,{name:"prompt-label",value:pe.label,onChange:t=>ne(a=>({...a,label:t||""})),className:x.formInput})]}),e.jsxs("div",{className:x.formField,children:[e.jsx("label",{className:x.formLabel,children:"Image Type:"}),e.jsx(da,{name:"prompt-image-type",value:pe.image_type,onChange:t=>ne(a=>({...a,image_type:t||"crisis_map"})),options:ye,keySelector:t=>t.image_type,labelSelector:t=>t.label})]}),e.jsxs("div",{className:x.formField,children:[e.jsx("label",{className:x.formLabel,children:"Active Status:"}),e.jsxs("div",{className:x.addModelFormCheckbox,children:[e.jsx("input",{type:"checkbox",checked:pe.is_active,onChange:t=>ne(a=>({...a,is_active:t.target.checked}))}),e.jsx("span",{children:"Active for this image type"})]})]}),e.jsxs("div",{className:x.formField,children:[e.jsx("label",{className:x.formLabel,children:"Metadata Instructions:"}),e.jsx("textarea",{name:"prompt-instructions",value:pe.metadata_instructions,onChange:t=>ne(a=>({...a,metadata_instructions:t.target.value})),className:`${x.formInput} ${x.textarea}`,rows:8})]})]}),e.jsxs("div",{className:x.modalButtons,children:[e.jsx(_,{name:"cancel-edit-prompt",variant:"tertiary",onClick:()=>{je(!1),I(null),ne({p_code:"",label:"",metadata_instructions:"",image_type:"crisis_map",is_active:!1})},children:"Cancel"}),e.jsx(_,{name:"save-prompt",variant:"primary",onClick:Ie,children:"Save Changes"})]})]})})}),Ye&&e.jsx("div",{className:x.modalOverlay,onClick:()=>be(!1),children:e.jsx("div",{className:x.modalContent,onClick:t=>t.stopPropagation(),children:e.jsxs("div",{className:x.modalBody,children:[e.jsxs("h3",{className:x.modalTitle,children:["Add New ",we==="crisis_map"?"Crisis Map":"Drone Image"," Prompt"]}),e.jsxs("div",{className:x.modalForm,children:[e.jsxs("div",{className:x.formField,children:[e.jsx("label",{className:x.formLabel,children:"Code:"}),e.jsx(ge,{name:"prompt-code",value:pe.p_code,onChange:t=>ne(a=>({...a,p_code:t||""})),placeholder:"e.g., CUSTOM_CRISIS_MAP_001",className:x.formInput})]}),e.jsxs("div",{className:x.formField,children:[e.jsx("label",{className:x.formLabel,children:"Label:"}),e.jsx(ge,{name:"prompt-label",value:pe.label,onChange:t=>ne(a=>({...a,label:t||""})),placeholder:"Enter prompt description...",className:x.formInput})]}),e.jsxs("div",{className:x.formField,children:[e.jsx("label",{className:x.formLabel,children:"Image Type:"}),e.jsx(ge,{name:"prompt-image-type",value:pe.image_type,onChange:()=>{},disabled:!0,className:x.formInput})]}),e.jsxs("div",{className:x.formField,children:[e.jsx("label",{className:x.formLabel,children:"Active Status:"}),e.jsxs("div",{className:x.addModelFormCheckbox,children:[e.jsx("input",{type:"checkbox",checked:pe.is_active,onChange:t=>ne(a=>({...a,is_active:t.target.checked}))}),e.jsx("span",{children:"Active for this image type"})]})]}),e.jsxs("div",{className:x.formField,children:[e.jsx("label",{className:x.formLabel,children:"Metadata Instructions:"}),e.jsx("textarea",{name:"prompt-instructions",value:pe.metadata_instructions,onChange:t=>ne(a=>({...a,metadata_instructions:t.target.value})),placeholder:"Enter metadata extraction instructions...",className:`${x.formInput} ${x.textarea}`,rows:8})]})]}),e.jsxs("div",{className:x.modalButtons,children:[e.jsx(_,{name:"cancel-add-prompt",variant:"tertiary",onClick:()=>{be(!1),ee(null),ne({p_code:"",label:"",metadata_instructions:"",image_type:"crisis_map",is_active:!1})},children:"Cancel"}),e.jsx(_,{name:"save-new-prompt",variant:"primary",onClick:Le,disabled:!pe.p_code||!pe.label,children:"Create Prompt"})]})]})})})]}):e.jsx(ga,{children:e.jsxs("div",{className:"mx-auto max-w-md px-4 sm:px-6 lg:px-8 py-6 sm:py-10",children:[e.jsx("div",{className:"text-center mb-8",children:e.jsx(Ia,{level:2,children:"Admin Login"})}),e.jsxs("form",{onSubmit:Ze,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-2",children:"Password"}),e.jsx(ge,{id:"password",name:"password",type:"password",value:b,onChange:t=>f(t||""),placeholder:"Enter admin password",required:!0,className:"w-full"})]}),o&&e.jsx("div",{className:"bg-ifrcRed/10 border border-ifrcRed/20 rounded-md p-3",children:e.jsx("p",{className:"text-sm text-ifrcRed font-medium",children:o})}),e.jsx("div",{className:"flex justify-center",children:e.jsx(J,{withInternalPadding:!0,className:"p-2",children:e.jsx(_,{name:"login",type:"submit",variant:"primary",size:2,disabled:G,children:G?"Logging in...":"Login"})})})]})]})})}const Dl=Ts([{element:e.jsx(Ws,{}),children:[{path:"/",element:e.jsx(bt,{})},{path:"/upload",element:e.jsx(bt,{})},{path:"/analytics",element:e.jsx(Qi,{})},{path:"/explore",element:e.jsx(xo,{})},{path:"/help",element:e.jsx(No,{})},{path:"/admin",element:e.jsx(Tl,{})},{path:"/map/:mapId",element:e.jsx(Xo,{})}]}]);function Pl(){const[r,i]=s.useState([]),v=s.useCallback(M=>{i(G=>$s([...G,M],w=>w.name)??G)},[i]),h=s.useCallback(M=>{i(G=>{const w=G.findIndex(D=>D.name===M);if(w===-1)return G;const N=[...G];return N.splice(w,1),N})},[i]),b=s.useCallback((M,G)=>{i(w=>{const N=w.findIndex(se=>se.name===M);if(N===-1)return w;const D=[...w];return D[N]={...D[N],...G},D})},[i]),f=s.useMemo(()=>({alerts:r,addAlert:v,removeAlert:h,updateAlert:b}),[r,v,h,b]),o=s.useMemo(()=>({languageNamespaceStatus:{},setLanguageNamespaceStatus:()=>{},currentLanguage:"en",setCurrentLanguage:()=>{},strings:{},setStrings:()=>{},registerNamespace:()=>{}}),[]);return e.jsx(ws.Provider,{value:f,children:e.jsx(Ns.Provider,{value:o,children:e.jsx(Xi,{children:e.jsx(ti,{children:e.jsx(Ds,{router:Dl})})})})})}function Ll(){return e.jsx(Pl,{})}Ls.createRoot(document.getElementById("root")).render(e.jsx(s.StrictMode,{children:e.jsx(Ll,{})}));
