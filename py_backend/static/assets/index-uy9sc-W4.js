const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jszip.min-BeHyG4q9.js","assets/index-C5rMGfs8.js","assets/index-BYJiCH1e.css"])))=>i.map(i=>d[i]);
import{K as aa,x as ta,r as d,D as sa,j as a,N as ae,n as F,_ as Ie,L as ia,z as P,v as oe,w as re,F as na,M as oa,G as ra}from"./index-C5rMGfs8.js";import{u as la}from"./useAdmin-B8fo0TJy.js";import{F as ca,E as da}from"./ExportModal-DJxQWbes.js";const ga="_tabSelector_usssr_1",ma="_imageContainer_usssr_12",ua="_imagePlaceholder_usssr_33",pa="_metadataTags_usssr_45",fa="_metadataTag_usssr_45",ha="_captionContainer_usssr_67",_a="_captionText_usssr_74",xa="_gridLayout_usssr_131",ya="_detailsSection_usssr_155",va="_loadingContainer_usssr_161",ja="_errorContainer_usssr_171",wa="_fullSizeModalOverlay_usssr_205",Ia="_fullSizeModalContent_usssr_219",Na="_ratingWarningContent_usssr_230",Ca="_ratingWarningTitle_usssr_236",ba="_ratingWarningText_usssr_243",Sa="_ratingWarningButtons_usssr_250",ka="_carouselContainer_usssr_365",Da="_carouselImageWrapper_usssr_370",Ma="_carouselImage_usssr_370",La="_carouselNavigation_usssr_393",Fa="_carouselButton_usssr_405",Ta="_carouselIndicators_usssr_429",Ea="_carouselIndicator_usssr_429",$a="_carouselIndicatorActive_usssr_458",Pa="_singleImageContainer_usssr_488",Ra="_viewImageButtonContainer_usssr_494",m={tabSelector:ga,imageContainer:ma,imagePlaceholder:ua,metadataTags:pa,metadataTag:fa,captionContainer:ha,captionText:_a,gridLayout:xa,detailsSection:ya,loadingContainer:va,errorContainer:ja,fullSizeModalOverlay:wa,fullSizeModalContent:Ia,ratingWarningContent:Na,ratingWarningTitle:Ca,ratingWarningText:ba,ratingWarningButtons:Sa,carouselContainer:ka,carouselImageWrapper:Da,carouselImage:Ma,carouselNavigation:La,carouselButton:Fa,carouselIndicators:Ta,carouselIndicator:Ea,carouselIndicatorActive:$a,singleImageContainer:Pa,viewImageButtonContainer:Ra};function it(){const{mapId:u}=aa(),y=ta(),{isAuthenticated:le}=la(),[ce,Ne]=d.useState("mapDetails"),[e,te]=d.useState(null),[O,A]=d.useState(!0),[de,U]=d.useState(null),[ge,Ce]=d.useState([]),[me,be]=d.useState([]),[ue,Se]=d.useState([]),[pe,ke]=d.useState([]),[De,Me]=d.useState([]),[Le,Fe]=d.useState(!1),[Te,Ee]=d.useState(!1),[J,K]=d.useState(!1),[$e,Z]=d.useState(!1),[fe,Q]=d.useState(!1),[Pe,se]=d.useState(!1),[Re,ie]=d.useState(!1),[Aa,za]=d.useState("standard"),[R,Oa]=d.useState(80),[G,Ua]=d.useState(10),[Ba,Wa]=d.useState(10),[Ja,Ga]=d.useState(!0),[Va,Ha]=d.useState(!0),[B,X]=d.useState(!1),[Ae,he]=d.useState(!1),[ze,_e]=d.useState(null),[Oe,V]=d.useState(!1),[x,H]=d.useState([]),[L,z]=d.useState(0),[q,xe]=d.useState(!1),{search:p,setSearch:qa,srcFilter:v,setSrcFilter:Ka,catFilter:j,setCatFilter:Za,regionFilter:w,setRegionFilter:Qa,countryFilter:I,setCountryFilter:Xa,imageTypeFilter:N,setImageTypeFilter:Ya,uploadTypeFilter:C,setUploadTypeFilter:et,generatedMethodFilter:f,showReferenceExamples:k,setShowReferenceExamples:Ue,clearAllFilters:Be}=sa(),We=[{key:"explore",label:"List"},{key:"mapDetails",label:"Carousel"}],Y=d.useCallback(async t=>{if(!(!t||t==="undefined"||t==="null"||t.trim()===""))try{const i=new URLSearchParams;p&&i.append("search",p),v&&i.append("source",v),j&&i.append("event_type",j),w&&i.append("region",w),I&&i.append("country",I),N&&i.append("image_type",N),C&&i.append("upload_type",C),k&&i.append("starred_only","true");const l=await fetch(`/api/images/grouped?${i.toString()}`);if(l.ok){let s=await l.json();s.items&&(s=s.items),f&&(s=s.filter(o=>f==="manual"?o.model==="manual":f==="generated"?o.model!=="manual":!0)),console.log("Server response for upload_type=multiple:",{url:`/api/images/grouped?${i.toString()}`,count:s.length,images:s.map(o=>({image_id:o.image_id,image_count:o.image_count,all_image_ids:o.all_image_ids,all_image_ids_length:o.all_image_ids?.length}))});const n=s.findIndex(o=>o.image_id===t);console.log("Navigation availability check (server-side):",{filteredImagesCount:s.length,currentIndex:n,currentId:t,uploadTypeFilter:C,hasPrevious:s.length>1&&n>0,hasNext:s.length>1&&n<s.length-1,filteredImages:s.map(o=>({image_id:o.image_id,image_count:o.image_count,all_image_ids:o.all_image_ids,image_type:o.image_type}))}),Fe(s.length>1&&n>0),Ee(s.length>1&&n<s.length-1)}}catch(i){console.error("Failed to check navigation availability:",i)}},[p,v,j,w,I,N,C,f,k]),ne=d.useCallback(async t=>{console.log("fetchAllImages called with imageIds:",t),xe(!0);try{const i=t.map(async s=>{const n=await fetch(`/api/images/${s}`);if(!n.ok)throw new Error(`Failed to fetch image ${s}`);return n.json()}),l=await Promise.all(i);H(l),z(0),console.log("fetchAllImages: Loaded",l.length,"images")}catch(i){console.error("fetchAllImages error:",i),U(i instanceof Error?i.message:"Failed to load all images")}finally{xe(!1)}},[]),ye=d.useCallback(async t=>{if(console.log("fetchMapData called with id:",t),console.log("fetchMapData id type:",typeof t),!t||t==="undefined"||t==="null"||t.trim()===""){console.log("fetchMapData: Invalid ID detected:",t),U("Invalid Map ID"),A(!1);return}if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t)){console.log("fetchMapData: Invalid UUID format:",t),U("Invalid Map ID format"),A(!1);return}console.log("fetchMapData: Making API call for id:",t),K(!0),A(!0);try{const l=await fetch(`/api/images/${t}`);if(!l.ok)throw new Error("Map not found");const s=await l.json();if(te(s),s.all_image_ids&&s.all_image_ids.length>1)await ne(s.all_image_ids);else if(s.image_count&&s.image_count>1){console.log("Multi-upload detected but no all_image_ids, trying grouped endpoint");try{const n=await fetch("/api/images/grouped");if(n.ok){const r=(await n.json()).find(g=>g.all_image_ids&&g.all_image_ids.includes(s.image_id));r&&r.all_image_ids?await ne(r.all_image_ids):(H([s]),z(0))}else H([s]),z(0)}catch(n){console.error("Failed to fetch from grouped endpoint:",n),H([s]),z(0)}}else H([s]),z(0);await Y(t)}catch(l){U(l instanceof Error?l.message:"Unknown error occurred")}finally{A(!1),K(!1)}},[Y,ne]),Je=d.useCallback(()=>{x.length>1&&z(t=>t>0?t-1:x.length-1)},[x.length]),Ge=d.useCallback(()=>{x.length>1&&z(t=>t<x.length-1?t+1:0)},[x.length]),Ve=d.useCallback(t=>{t>=0&&t<x.length&&z(t)},[x.length]),ve=d.useCallback(async t=>{const i=t||(x.length>0?x[L]:e);if(i){V(!0),_e(i),he(!0);try{const l=new Image;l.onload=()=>{V(!1)},l.onerror=()=>{V(!1)},l.src=i.image_url}catch(l){console.error("Error preloading full-size image:",l),V(!1)}}},[x,L,e]),He=d.useCallback(()=>{he(!1),_e(null),V(!1)},[]);d.useEffect(()=>{if(console.log("MapDetailsPage: mapId from useParams:",u),console.log("MapDetailsPage: mapId type:",typeof u),console.log("MapDetailsPage: mapId value:",u),!u||u==="undefined"||u==="null"||u.trim()===""||u===void 0||u===null){console.log("MapDetailsPage: Invalid mapId, setting error"),U("Map ID is required"),A(!1);return}if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(u)){console.log("MapDetailsPage: Invalid UUID format:",u),U("Invalid Map ID format"),A(!1);return}console.log("MapDetailsPage: Fetching data for mapId:",u),ye(u)},[u,ye]),d.useEffect(()=>{if(!e||O||B)return;if(!u||u==="undefined"||u==="null"||u.trim()===""){console.log("Auto-navigation skipped: Invalid mapId");return}if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(u)){console.log("Auto-navigation skipped: Invalid mapId format");return}(()=>{const l=!p||e.title?.toLowerCase().includes(p.toLowerCase())||e.generated?.toLowerCase().includes(p.toLowerCase())||e.source?.toLowerCase().includes(p.toLowerCase())||e.event_type?.toLowerCase().includes(p.toLowerCase()),s=!v||e.source===v,n=!j||e.event_type===j,o=!w||e.countries.some(M=>M.r_code===w),r=!I||e.countries.some(M=>M.c_code===I),g=!N||e.image_type===N,_=!f||f==="manual"&&e.model==="manual"||f==="generated"&&e.model!=="manual",T=!k||e.starred===!0,E=l&&s&&n&&o&&r&&g&&_&&T;return console.log("Auto-navigation check:",{mapId:u,search:p,srcFilter:v,catFilter:j,regionFilter:w,countryFilter:I,imageTypeFilter:N,generatedMethodFilter:f,showReferenceExamples:k,matchesSearch:l,matchesSource:s,matchesCategory:n,matchesRegion:o,matchesCountry:r,matchesImageType:g,matchesReferenceExamples:T,matches:E}),E})()||(console.log("Current map does not match filters, looking for first matching item"),fetch("/api/images").then(l=>l.json()).then(l=>{console.log("Auto-navigation: Received images from API:",l.length),console.log("Auto-navigation: First few images:",l.slice(0,3).map(n=>({image_id:n.image_id,title:n.title})));const s=l.find(n=>{const o=!p||n.title?.toLowerCase().includes(p.toLowerCase())||n.generated?.toLowerCase().includes(p.toLowerCase())||n.source?.toLowerCase().includes(p.toLowerCase())||n.event_type?.toLowerCase().includes(p.toLowerCase()),r=!v||n.source===v,g=!j||n.event_type===j,_=!w||n.countries?.some(S=>S.r_code===w),T=!I||n.countries?.some(S=>S.c_code===I),E=!N||n.image_type===N,M=!f||f==="manual"&&n.model==="manual"||f==="generated"&&n.model!=="manual",h=!k||n.starred===!0;return o&&r&&g&&_&&T&&E&&M&&h});console.log("Auto-navigation: Found first matching image:",s?{image_id:s.image_id,title:s.title,source:s.source}:"No matching image found"),s&&s.image_id&&s.image_id!=="undefined"&&s.image_id!=="null"&&s.image_id.trim()!==""&&s.image_id!==u&&(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(s.image_id)?(console.log("Auto-navigating to:",s.image_id),y(`/map/${s.image_id}`)):console.error("Auto-navigation blocked: Invalid image_id format:",s.image_id))}).catch(console.error))},[e,p,v,j,w,I,N,f,k,u,y,O,B]);const je=async t=>{if(!J){K(!0);try{const i=new URLSearchParams;p&&i.append("search",p),v&&i.append("source",v),j&&i.append("event_type",j),w&&i.append("region",w),I&&i.append("country",I),N&&i.append("image_type",N),C&&i.append("upload_type",C),k&&i.append("starred_only","true");const l=await fetch(`/api/images/grouped?${i.toString()}`);if(l.ok){let s=await l.json();s.items&&(s=s.items),f&&(s=s.filter(g=>f==="manual"?g.model==="manual":f==="generated"?g.model!=="manual":!0));const n=s.findIndex(g=>g.image_id===u);if(n===-1){console.error("Current image not found in filtered list");return}let o;t==="previous"?o=n>0?n-1:s.length-1:o=n<s.length-1?n+1:0;const r=s[o];r&&r.image_id&&r.image_id!=="undefined"&&r.image_id!=="null"&&r.image_id.trim()!==""&&(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(r.image_id)?(console.log("Carousel navigating to:",r.image_id),y(`/map/${r.image_id}`)):console.error("Carousel navigation blocked: Invalid image_id format:",r.image_id))}}catch(i){console.error("Failed to navigate to item:",i)}finally{K(!1)}}};d.useEffect(()=>{console.log("=== NAVIGATION USEEFFECT TRIGGERED ==="),console.log("Navigation useEffect triggered:",{map:!!e,mapId:u,loading:O,isDeleting:B,uploadTypeFilter:C,allFilters:{search:p,srcFilter:v,catFilter:j,regionFilter:w,countryFilter:I,imageTypeFilter:N,uploadTypeFilter:C,generatedMethodFilter:f,showReferenceExamples:k}}),e&&u&&!O&&!B?(console.log("Calling checkNavigationAvailability with:",u),Y(u)):console.log("NOT calling checkNavigationAvailability because:",{map:!!e,mapId:!!u,loading:O,isDeleting:B})},[e,u,p,v,j,w,I,N,C,f,k,O,B,Y]),d.useEffect(()=>{Promise.all([fetch("/api/sources").then(t=>t.json()),fetch("/api/types").then(t=>t.json()),fetch("/api/image-types").then(t=>t.json()),fetch("/api/regions").then(t=>t.json()),fetch("/api/countries").then(t=>t.json())]).then(([t,i,l,s,n])=>{Ce(t),be(i),Se(l),ke(s),Me(n)}).catch(console.error)},[]);const qe=async()=>{e&&Z(!0)},Ke=async()=>{if(e)try{(await fetch(`/api/images/${e.image_id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({starred:!e.starred})})).ok?te(i=>i?{...i,starred:!i.starred}:null):console.error("Failed to toggle starred status")}catch(t){console.error("Error toggling starred status:",t)}},Ze=async()=>{if(e){X(!0);try{if(console.log("Deleting image with ID:",e.image_id),(await fetch(`/api/images/${e.image_id}`,{method:"DELETE"})).ok){te(i=>i?{...i,starred:!i.starred}:null),Z(!1);try{const i=await fetch("/api/images/grouped");if(i.ok){const s=(await i.json()).filter(o=>{const r=!p||o.title?.toLowerCase().includes(p.toLowerCase())||o.generated?.toLowerCase().includes(p.toLowerCase())||o.source?.toLowerCase().includes(p.toLowerCase())||o.event_type?.toLowerCase().includes(p.toLowerCase()),g=!v||o.source===v,_=!j||o.event_type===j,T=!w||o.countries?.some(b=>b.r_code===w),E=!I||o.countries?.some(b=>b.c_code===I),M=!N||o.image_type===N,h=!C||C==="single"&&(!o.image_count||o.image_count<=1)||C==="multiple"&&o.image_count&&o.image_count>1,S=!f||f==="manual"&&o.model==="manual"||f==="generated"&&o.model!=="manual",D=!k||o.starred===!0;return r&&g&&_&&T&&E&&M&&h&&S&&D}),n=s.filter(o=>o.image_id!==e.image_id);if(n.length>0){const o=s.findIndex(g=>g.image_id===e.image_id);let r;if(o===s.length-1?r=o-1:r=o,console.log("Navigation target:",{currentIndex:o,targetIndex:r,targetId:n[r]?.image_id}),r>=0&&r<n.length){const g=n[r];g&&g.image_id&&g.image_id!=="undefined"&&g.image_id!=="null"&&g.image_id.trim()!==""?/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(g.image_id)?(console.log("Navigating to:",g.image_id),y(`/map/${g.image_id}`)):(console.error("Navigation blocked: Invalid image_id format:",g.image_id),y("/explore")):(console.error("Navigation blocked: Invalid image_id:",g?.image_id),y("/explore"))}else n[0]&&n[0].image_id&&n[0].image_id!=="undefined"&&n[0].image_id!=="null"&&n[0].image_id.trim()!==""?/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(n[0].image_id)?(console.log("Fallback navigation to first item:",n[0].image_id),y(`/map/${n[0].image_id}`)):(console.error("Fallback navigation blocked: Invalid image_id format:",n[0].image_id),y("/explore")):(console.log("No valid remaining items, going to explore page"),y("/explore"))}else console.log("No remaining items, going to explore page"),y("/explore")}else y("/explore")}catch(i){console.error("Failed to navigate to next item:",i),y("/explore")}finally{X(!1)}}else console.error("Delete failed"),X(!1)}catch(t){console.error("Delete failed:",t),X(!1)}}},we=d.useCallback(async()=>{A(!0);try{const t=new URLSearchParams;p&&t.append("search",p),v&&t.append("source",v),j&&t.append("event_type",j),w&&t.append("region",w),I&&t.append("country",I),N&&t.append("image_type",N),C&&t.append("upload_type",C),k&&t.append("starred_only","true");const i=await fetch(`/api/images/grouped?${t.toString()}`);if(i.ok){let l=await i.json();if(l.items&&(l=l.items),f&&(l=l.filter(s=>f==="manual"?s.model==="manual":f==="generated"?s.model!=="manual":!0)),l.length>0){const s=l[0];s&&s.image_id&&y(`/map/${s.image_id}`)}else y("/explore")}}catch(t){console.error("Failed to navigate to matching image:",t),y("/explore")}finally{A(!1)}},[p,v,j,w,I,N,C,f,k,y]),c=d.useMemo(()=>{if(!e)return null;if(!p&&!v&&!j&&!w&&!I&&!N&&!C&&!f&&!k)return e;const t=!p||e.title?.toLowerCase().includes(p.toLowerCase())||e.generated?.toLowerCase().includes(p.toLowerCase())||e.source?.toLowerCase().includes(p.toLowerCase())||e.event_type?.toLowerCase().includes(p.toLowerCase()),i=!v||e.source===v,l=!j||e.event_type===j,s=!w||e.countries.some(E=>E.r_code===w),n=!I||e.countries.some(E=>E.c_code===I),o=!N||e.image_type===N,r=!C||C==="single"&&(!e.image_count||e.image_count<=1)&&(!e.all_image_ids||e.all_image_ids.length<=1)||C==="multiple"&&(e.image_count&&e.image_count>1||e.all_image_ids&&e.all_image_ids.length>1),g=!f||f==="manual"&&e.model==="manual"||f==="generated"&&e.model!=="manual",_=!k||e.starred===!0,T=t&&i&&l&&s&&n&&o&&r&&g&&_;return!T&&(p||v||j||w||I||N||C||f||k)?(setTimeout(()=>{we()},100),e):T?e:null},[e,p,v,j,w,I,N,C,f,k,we]),Qe=()=>{if(!e)return;if(!e.all_image_ids||e.all_image_ids.length<=1){const s=`/upload?step=1&contribute=true&imageIds=${[e.image_id].join(",")}`;y(s);return}const i=`/upload?step=1&contribute=true&imageIds=${e.all_image_ids.join(",")}`;y(i)},$=(t,i)=>({image:`images/${i}`,caption:t.edited||t.generated||"",metadata:{image_id:t.image_count&&t.image_count>1?t.all_image_ids||[t.image_id]:t.image_id,title:t.title,source:t.source,event_type:t.event_type,image_type:t.image_type,countries:t.countries,starred:t.starred,image_count:t.image_count||1}}),Xe=async t=>{if(e){se(!0),ie(!1);try{const i=(await ra(async()=>{const{default:r}=await import("./jszip.min-BeHyG4q9.js").then(g=>g.j);return{default:r}},__vite__mapDeps([0,1,2]))).default,l=new i;if(e.image_type==="crisis_map"){const r=l.folder("crisis_maps_dataset"),g=r?.folder("images");if(g)try{const _=e.image_count&&e.image_count>1?e.all_image_ids||[e.image_id]:[e.image_id],T=_.map(async(h,S)=>{try{const D=await fetch(`/api/images/${h}/file`);if(!D.ok)throw new Error(`Failed to fetch image ${h}`);const b=await D.blob(),ee=e.file_key.split(".").pop()||"jpg",W=`0001_${String(S+1).padStart(2,"0")}.${ee}`;return g.file(W,b),{success:!0,fileName:W,imageId:h}}catch(D){return console.error(`Failed to process image ${h}:`,D),{success:!1,fileName:"",imageId:h}}}),M=(await Promise.all(T)).filter(h=>h.success);if(M.length===0)throw new Error("No images could be processed");if(t==="fine-tuning"){const h=[],S=[],D=[],b=M.map(ea=>`images/${ea.fileName}`),ee=Math.random(),W={image:b.length===1?b[0]:b,caption:e.edited||e.generated||"",metadata:{image_id:_,title:e.title,source:e.source,event_type:e.event_type,image_type:e.image_type,countries:e.countries,starred:e.starred,image_count:e.image_count||1}};ee<R/100?h.push(W):ee<(R+G)/100?S.push(W):D.push(W),r&&(r.file("train.jsonl",JSON.stringify(h,null,2)),r.file("test.jsonl",JSON.stringify(S,null,2)),r.file("val.jsonl",JSON.stringify(D,null,2)))}else{const h=M.map(D=>`images/${D.fileName}`),S={image:h.length===1?h[0]:h,caption:e.edited||e.generated||"",metadata:{image_id:_,title:e.title,source:e.source,event_type:e.event_type,image_type:e.image_type,countries:e.countries,starred:e.starred,image_count:e.image_count||1}};r&&r.file("0001.json",JSON.stringify(S,null,2))}}catch(_){throw console.error(`Failed to process image ${e.image_id}:`,_),_}}else if(e.image_type==="drone_image"){const r=l.folder("drone_images_dataset"),g=r?.folder("images");if(g)try{const _=await fetch(`/api/images/${e.image_id}/file`);if(!_.ok)throw new Error(`Failed to fetch image ${e.image_id}`);const T=await _.blob(),M=`0001.${e.file_key.split(".").pop()||"jpg"}`;if(g.file(M,T),t==="fine-tuning"){const h=[],S=[],D=[];if(String(e?.image_type)==="crisis_map"){const b=Math.random();b<R/100?h.push($(e,"0001")):b<(R+G)/100?S.push($(e,"0001")):D.push($(e,"0001"))}else if(String(e?.image_type)==="drone_image"){const b=Math.random();b<R/100?h.push($(e,"0001")):b<(R+G)/100?S.push($(e,"0001")):D.push($(e,"0001"))}r&&(r.file("train.jsonl",JSON.stringify(h,null,2)),r.file("test.jsonl",JSON.stringify(S,null,2)),r.file("val.jsonl",JSON.stringify(D,null,2)))}else{const h={image:`images/${M}`,caption:e.edited||e.generated||"",metadata:{image_id:e.image_count&&e.image_count>1?e.all_image_ids||[e.image_id]:e.image_id,title:e.title,source:e.source,event_type:e.event_type,image_type:e.image_type,countries:e.countries,starred:e.starred,image_count:e.image_count||1}};r&&r.file("0001.json",JSON.stringify(h,null,2))}}catch(_){throw console.error(`Failed to process image ${e.image_id}:`,_),_}}else{const r=l.folder("generic_dataset"),g=r?.folder("images");if(g)try{const _=await fetch(`/api/images/${e.image_id}/file`);if(!_.ok)throw new Error(`Failed to fetch image ${e.image_id}`);const T=await _.blob(),M=`0001.${e.file_key.split(".").pop()||"jpg"}`;if(g.file(M,T),t==="fine-tuning"){const h=[],S=[],D=[];if(String(e?.image_type)==="crisis_map"){const b=Math.random();b<R/100?h.push($(e,"0001")):b<(R+G)/100?S.push($(e,"0001")):D.push($(e,"0001"))}else if(String(e?.image_type)==="drone_image"){const b=Math.random();b<R/100?h.push($(e,"0001")):b<(R+G)/100?S.push($(e,"0001")):D.push($(e,"0001"))}r&&(r.file("train.jsonl",JSON.stringify(h,null,2)),r.file("test.jsonl",JSON.stringify(S,null,2)),r.file("val.jsonl",JSON.stringify(D,null,2)))}else{const h={image:`images/${M}`,caption:e.edited||e.generated||"",metadata:{image_id:e.image_count&&e.image_count>1?e.all_image_ids||[e.image_id]:e.image_id,title:e.title,source:e.source,event_type:e.event_type,image_type:e.image_type,countries:e.countries,starred:e.starred,image_count:e.image_count||1}};r&&r.file("0001.json",JSON.stringify(h,null,2))}}catch(_){throw console.error(`Failed to process image ${e.image_id}:`,_),_}}const s=await l.generateAsync({type:"blob"}),n=URL.createObjectURL(s),o=document.createElement("a");o.href=n,o.download=`dataset_${e.image_type}_${e.image_id}_${t}_${new Date().toISOString().split("T")[0]}.zip`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),console.log(`Exported ${e.image_type} dataset with 1 image in ${t} mode`),ie(!0)}catch(i){console.error("Export failed:",i),alert("Failed to export dataset. Please try again.")}finally{se(!1)}}},Ye=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;return!u||u==="undefined"||u==="null"||u.trim()===""||!Ye.test(u)?a.jsx(ae,{children:a.jsxs("div",{className:"flex flex-col items-center gap-4 text-center py-12",children:[a.jsx("div",{className:"text-4xl",children:"âš ï¸"}),a.jsx("div",{className:"text-xl font-semibold",children:"Invalid Map ID"}),a.jsx("div",{children:"The map ID provided is not valid."}),a.jsxs("div",{className:"text-sm text-gray-500 mt-2",children:['Debug Info: mapId = "',u,'" (type: ',typeof u,")"]}),a.jsx(F,{name:"back-to-explore",variant:"secondary",onClick:()=>y("/explore"),children:"Return to Explore"})]})}):O?a.jsx(ae,{children:a.jsx("div",{className:m.loadingContainer,children:a.jsxs("div",{className:"flex flex-col items-center gap-4",children:[a.jsx(Ie,{className:"text-ifrcRed"}),a.jsx("div",{children:"Loading map details..."})]})})}):de||!e?a.jsx(ae,{children:a.jsx("div",{className:m.errorContainer,children:a.jsxs("div",{className:"flex flex-col items-center gap-4 text-center",children:[a.jsx("div",{className:"text-4xl",children:"âš ï¸"}),a.jsx("div",{className:"text-xl font-semibold",children:"Unable to load map"}),a.jsx("div",{children:de||"Map not found"}),a.jsx(F,{name:"back-to-explore",variant:"secondary",onClick:()=>y("/explore"),children:"Return to Explore"})]})})}):a.jsxs(ae,{children:[a.jsxs("div",{className:"max-w-7xl mx-auto",children:[a.jsxs("div",{className:m.tabSelector,children:[a.jsx(ia,{name:"map-details-view",value:ce,onChange:t=>{(t==="mapDetails"||t==="explore")&&(Ne(t),t==="explore"&&y("/explore"))},options:We,keySelector:t=>t.key,labelSelector:t=>t.label}),a.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[a.jsx(P,{withInternalPadding:!0,className:"bg-white/20 backdrop-blur-sm rounded-md p-2",children:a.jsxs(F,{name:"reference-examples",variant:k?"primary":"secondary",onClick:()=>Ue(!k),className:"whitespace-nowrap",children:[a.jsx("span",{className:"mr-2",children:k?a.jsx("span",{className:"text-yellow-400",children:"â˜…"}):a.jsx("span",{className:"text-yellow-400",children:"â˜†"})}),"Reference Examples"]})}),a.jsx(F,{name:"export-dataset",variant:"secondary",onClick:()=>Q(!0),children:"Export"})]})]}),a.jsx(ca,{sources:ge,types:me,regions:pe,countries:De,imageTypes:ue,isLoadingFilters:!1}),ce==="mapDetails"?a.jsx("div",{className:"relative",children:c?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:m.gridLayout,children:[a.jsxs(P,{heading:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{children:c.title||"Map Image"}),c.starred&&a.jsx("span",{className:"text-red-500 text-xl",title:"Starred image",children:"â˜…"})]}),headingLevel:2,withHeaderBorder:!0,withInternalPadding:!0,spacing:"comfortable",children:[a.jsx("div",{className:m.imageContainer,children:e?.image_count&&e.image_count>1||x.length>1?a.jsxs("div",{className:m.carouselContainer,children:[a.jsx("div",{className:m.carouselImageWrapper,children:q?a.jsxs("div",{className:m.imagePlaceholder,children:[a.jsx(Ie,{className:"text-ifrcRed"}),a.jsx("div",{children:"Loading images..."})]}):x[L]?.detail_url?a.jsx("img",{src:x[L].detail_url,alt:x[L].file_key,className:m.carouselImage,onError:t=>{console.log("MapDetailsPage: Detail image failed to load, falling back to original:",x[L].detail_url);const i=t.target;x[L].image_url&&(i.src=x[L].image_url)},onLoad:()=>console.log("MapDetailsPage: Detail image loaded successfully:",x[L].detail_url)}):x[L]?.image_url?a.jsx("img",{src:x[L].image_url,alt:x[L].file_key,className:m.carouselImage,onLoad:()=>console.log("MapDetailsPage: Original image loaded successfully:",x[L].image_url)}):a.jsx("div",{className:m.imagePlaceholder,children:"No image available"})}),a.jsxs("div",{className:m.carouselNavigation,children:[a.jsx(F,{name:"previous-image",variant:"tertiary",size:1,onClick:Je,disabled:q,className:m.carouselButton,children:a.jsx(oe,{className:"w-4 h-4"})}),a.jsx("div",{className:m.carouselIndicators,children:x.map((t,i)=>a.jsx("button",{onClick:()=>Ve(i),className:`${m.carouselIndicator} ${i===L?m.carouselIndicatorActive:""}`,disabled:q,children:i+1},i))}),a.jsx(F,{name:"next-image",variant:"tertiary",size:1,onClick:Ge,disabled:q,className:m.carouselButton,children:a.jsx(re,{className:"w-4 h-4"})})]}),a.jsx("div",{className:m.viewImageButtonContainer,children:a.jsx(F,{name:"view-full-size-carousel",variant:"secondary",size:1,onClick:()=>ve(x[L]),disabled:q||!x[L]?.image_url,children:"View Image"})})]}):a.jsxs("div",{className:m.singleImageContainer,children:[c.detail_url?a.jsx("img",{src:c.detail_url,alt:c.file_key,onError:t=>{console.log("MapDetailsPage: Detail image failed to load, falling back to original:",c.detail_url);const i=t.target;c.image_url&&(i.src=c.image_url)},onLoad:()=>console.log("MapDetailsPage: Detail image loaded successfully:",c.detail_url)}):c.image_url?a.jsx("img",{src:c.image_url,alt:c.file_key,onLoad:()=>console.log("MapDetailsPage: Original image loaded successfully:",c.image_url)}):a.jsx("div",{className:m.imagePlaceholder,children:"No image available"}),a.jsx("div",{className:m.viewImageButtonContainer,children:a.jsx(F,{name:"view-full-size-single",variant:"secondary",size:1,onClick:()=>ve(c),disabled:!c.image_url,children:"View Image"})})]})}),a.jsx(P,{withInternalPadding:!0,className:"bg-white/20 backdrop-blur-sm rounded-md p-2",children:a.jsxs("div",{className:m.metadataTags,children:[c.image_type!=="drone_image"&&a.jsx("span",{className:m.metadataTag,children:ge.find(t=>t.s_code===c.source)?.label||c.source}),a.jsx("span",{className:m.metadataTag,children:me.find(t=>t.t_code===c.event_type)?.label||c.event_type}),a.jsx("span",{className:m.metadataTag,children:ue.find(t=>t.image_type===c.image_type)?.label||c.image_type}),a.jsx("span",{className:m.metadataTag,children:c.model==="manual"?"Manual":"Generated"}),c.countries&&c.countries.length>0&&a.jsxs(a.Fragment,{children:[a.jsx("span",{className:m.metadataTag,children:pe.find(t=>t.r_code===c.countries[0].r_code)?.label||"Unknown Region"}),a.jsx("span",{className:m.metadataTag,children:c.countries.map(t=>t.label).join(", ")})]}),c.image_count&&c.image_count>1&&a.jsxs("span",{className:m.metadataTag,title:`Multi-upload with ${c.image_count} images`,children:["ðŸ“· ",c.image_count]}),(!c.image_count||c.image_count<=1)&&a.jsx("span",{className:m.metadataTag,title:"Single Upload",children:"Single"})]})})]}),a.jsx("div",{className:m.detailsSection,children:c.edited&&c.edited.includes("Description:")||c.generated&&c.generated.includes("Description:")?a.jsx(P,{heading:"Interpretation",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,spacing:"comfortable",children:a.jsx("div",{className:m.captionContainer,children:a.jsx("div",{className:m.captionText,children:(c.edited||c.generated||"").split(/(Description:|Analysis:|Recommended Actions:)/).map((l,s)=>l.trim()===""?null:l==="Description:"||l==="Analysis:"||l==="Recommended Actions:"?a.jsx("h4",{className:"font-semibold text-gray-800 mt-4 mb-2",children:l},s):a.jsx("p",{className:"mb-2",children:l.trim()},s))})})}):a.jsx(P,{heading:"Description",headingLevel:3,withHeaderBorder:!0,withInternalPadding:!0,spacing:"comfortable",children:a.jsx("div",{className:m.captionContainer,children:c.generated||c.edited?a.jsx("div",{className:m.captionText,children:a.jsx("p",{children:c.edited||c.generated})}):a.jsx("p",{children:"â€” no caption yet â€”"})})})})]}),a.jsx("div",{className:"flex items-center justify-center mt-8",children:a.jsx(P,{withInternalPadding:!0,className:"bg-white/20 backdrop-blur-sm rounded-lg p-4",children:a.jsxs("div",{className:"flex items-center gap-4",children:[Le&&a.jsx(P,{withInternalPadding:!0,className:"rounded-md p-2",children:a.jsx(F,{name:"previous-item",variant:"tertiary",size:1,className:`bg-white/90 hover:bg-white shadow-lg border border-gray-200 ${J?"opacity-50 cursor-not-allowed":"hover:scale-110"}`,onClick:()=>je("previous"),disabled:J,children:a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsxs("div",{className:"flex -space-x-1",children:[a.jsx(oe,{className:"w-4 h-4"}),a.jsx(oe,{className:"w-4 h-4"})]}),a.jsx("span",{className:"font-semibold",children:"Previous"})]})})}),le&&a.jsx(P,{withInternalPadding:!0,className:"rounded-md p-2",children:a.jsx(F,{name:"delete",variant:"tertiary",size:1,className:"bg-red-50 hover:bg-red-100 text-red-700 border border-red-200 hover:border-red-300",onClick:qe,title:"Delete","aria-label":"Delete saved image",children:a.jsx(na,{className:"w-4 h-4"})})}),a.jsx(P,{withInternalPadding:!0,className:"rounded-md p-2",children:a.jsx(F,{name:"contribute",onClick:Qe,children:"Contribute"})}),le&&a.jsx(P,{withInternalPadding:!0,className:"rounded-md p-2",children:a.jsx(F,{name:"toggle-star",variant:"tertiary",size:1,className:`${e?.starred?"bg-red-100 hover:bg-red-200 text-red-800 border-2 border-red-400":"bg-gray-100 hover:bg-gray-200 text-gray-600 border-2 border-gray-300"} w-16 h-8 rounded-full transition-all duration-200 flex items-center justify-center`,onClick:Ke,title:e?.starred?"Unstar image":"Star image","aria-label":e?.starred?"Unstar image":"Star image",children:a.jsx("span",{className:`text-lg transition-all duration-200 ${e?.starred?"text-red-600":"text-gray-500"}`,children:e?.starred?"â˜…":"â˜†"})})}),Te&&a.jsx(P,{withInternalPadding:!0,className:"rounded-md p-2",children:a.jsx(F,{name:"next-item",variant:"tertiary",size:1,className:`bg-white/90 hover:bg-white shadow-lg border border-gray-200 ${J?"opacity-50 cursor-not-allowed":"hover:scale-110"}`,onClick:()=>je("next"),disabled:J,children:a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"font-semibold",children:"Next"}),a.jsxs("div",{className:"flex -space-x-1",children:[a.jsx(re,{className:"w-4 h-4"}),a.jsx(re,{className:"w-4 h-4"})]})]})})})]})})})]}):a.jsxs("div",{className:"text-center py-12",children:[a.jsx("div",{className:"text-xl font-semibold text-gray-600 mb-4",children:"No matches found"}),a.jsx("div",{className:"mt-4",children:a.jsx(F,{name:"clear-filters",variant:"secondary",onClick:Be,children:"Clear Filters"})})]})}):null]}),$e&&a.jsx("div",{className:m.fullSizeModalOverlay,onClick:()=>Z(!1),children:a.jsx("div",{className:m.fullSizeModalContent,onClick:t=>t.stopPropagation(),children:a.jsxs("div",{className:m.ratingWarningContent,children:[a.jsx("h3",{className:m.ratingWarningTitle,children:"Delete Image?"}),a.jsx("p",{className:m.ratingWarningText,children:"This action cannot be undone. Are you sure you want to delete this saved image and all related data?"}),a.jsxs("div",{className:m.ratingWarningButtons,children:[a.jsx(F,{name:"confirm-delete",variant:"secondary",onClick:Ze,children:"Delete"}),a.jsx(F,{name:"cancel-delete",variant:"tertiary",onClick:()=>Z(!1),children:"Cancel"})]})]})})}),fe&&a.jsx(da,{isOpen:fe,onClose:()=>{Q(!1),ie(!1),se(!1)},onExport:(t,i)=>{i.includes(e.image_type)&&Xe(t)},filteredCount:1,totalCount:1,hasFilters:!1,crisisMapsCount:e.image_type==="crisis_map"?1:0,droneImagesCount:e.image_type==="drone_image"?1:0,isLoading:Pe,exportSuccess:Re,variant:"single",onNavigateToList:()=>{Q(!1),y("/explore")},onNavigateAndExport:()=>{Q(!1),y("/explore?export=true")}}),a.jsx(oa,{isOpen:Ae,imageUrl:ze?.image_url||null,preview:null,selectedImageData:null,onClose:He,isLoading:Oe})]})}export{it as default};
